# 維護手冊

## 概述

本文件說明 AETIM 系統的維護作業，包含定期維護、更新程序、故障排除等。

## 定期維護作業

### 1. 每日維護

#### 1.1 健康檢查

- 檢查所有服務的健康狀態
- 檢查資料庫連線
- 檢查 Redis 連線
- 檢查 AI 服務連線

#### 1.2 日誌審查

- 檢查錯誤日誌
- 檢查警告訊息
- 檢查異常活動

#### 1.3 效能監控

- 檢查 API 回應時間
- 檢查系統資源使用量
- 檢查錯誤率

### 2. 每週維護

#### 2.1 資料庫備份

- 執行完整資料庫備份
- 驗證備份檔案完整性
- 清理舊備份檔案（保留 4 週）

#### 2.2 日誌清理

- 清理過期的日誌檔案
- 壓縮舊日誌檔案
- 歸檔重要日誌

#### 2.3 效能分析

- 分析慢查詢
- 優化資料庫查詢
- 調整快取策略

### 3. 每月維護

#### 3.1 安全性掃描

- 執行依賴套件漏洞掃描
- 執行程式碼安全性掃描
- 檢查安全性設定

#### 3.2 系統更新

- 檢查套件更新
- 評估更新影響
- 執行測試更新

#### 3.3 容量規劃

- 檢查資料庫大小
- 檢查磁碟使用量
- 規劃容量擴充

## 更新程序

### 1. 應用程式更新

#### 1.1 準備工作

1. 備份資料庫
2. 備份設定檔案
3. 通知使用者（如需要）

#### 1.2 更新步驟

```bash
# 1. 停止服務
docker-compose down

# 2. 更新程式碼
git pull origin main

# 3. 建置新映像檔
docker-compose build

# 4. 執行資料庫遷移
docker-compose run --rm backend alembic upgrade head

# 5. 啟動服務
docker-compose up -d

# 6. 驗證服務
docker-compose ps
curl http://localhost:8000/api/v1/health
```

#### 1.3 回滾程序

如果更新失敗，執行回滾：

```bash
# 1. 停止服務
docker-compose down

# 2. 還原資料庫備份
cp backups/aetim_YYYYMMDD.db data/aetim.db

# 3. 還原程式碼
git checkout previous_version

# 4. 啟動服務
docker-compose up -d
```

### 2. 資料庫遷移

#### 2.1 遷移前檢查

```bash
# 檢查當前版本
alembic current

# 檢查遷移歷史
alembic history

# 檢查待執行遷移
alembic heads
```

#### 2.2 執行遷移

```bash
# 執行所有待執行遷移
alembic upgrade head

# 執行特定遷移
alembic upgrade {revision}

# 回滾遷移
alembic downgrade {revision}
```

### 3. 依賴套件更新

#### 3.1 檢查更新

```bash
# Python 套件
pip list --outdated

# Node.js 套件
npm outdated
```

#### 3.2 更新套件

```bash
# Python 套件
pip install --upgrade package_name

# Node.js 套件
npm update package_name
```

#### 3.3 測試更新

更新後執行完整測試：

```bash
# 後端測試
cd backend
pytest

# 前端測試
cd frontend
npm test
```

## 故障排除

### 1. 服務無法啟動

#### 1.1 檢查日誌

```bash
docker-compose logs backend
docker-compose logs frontend
```

#### 1.2 檢查環境變數

```bash
docker-compose exec backend env
```

#### 1.3 檢查資源

```bash
# 檢查記憶體
free -h

# 檢查磁碟空間
df -h

# 檢查 CPU
top
```

### 2. 資料庫問題

#### 2.1 連線問題

- 檢查資料庫服務狀態
- 檢查連線字串
- 檢查網路連線
- 檢查防火牆設定

#### 2.2 效能問題

- 檢查慢查詢
- 重建索引
- 更新統計資訊
- 優化查詢語句

#### 2.3 資料損壞

- 執行資料庫完整性檢查
- 還原備份
- 修復資料庫

### 3. Redis 問題

#### 3.1 連線問題

- 檢查 Redis 服務狀態
- 檢查 Redis URL
- 檢查網路連線

#### 3.2 記憶體問題

- 檢查記憶體使用量
- 調整記憶體限制
- 清理快取

### 4. API 問題

#### 4.1 回應時間過長

- 檢查資料庫查詢
- 檢查快取命中率
- 檢查系統資源
- 優化查詢語句

#### 4.2 錯誤率過高

- 檢查錯誤日誌
- 檢查系統資源
- 檢查依賴服務狀態

## 監控與告警

### 1. 監控指標

#### 1.1 系統指標

- CPU 使用率
- 記憶體使用率
- 磁碟使用率
- 網路流量

#### 1.2 應用程式指標

- API 回應時間
- 請求數量
- 錯誤率
- 並發請求數

#### 1.3 業務指標

- 威脅收集成功率
- 報告生成成功率
- 使用者活動

### 2. 告警設定

#### 2.1 系統告警

- CPU 使用率 > 80%
- 記憶體使用率 > 90%
- 磁碟使用率 > 85%
- 服務無法啟動

#### 2.2 應用程式告警

- API 回應時間 > 2 秒
- 錯誤率 > 5%
- 請求失敗率 > 10%

### 3. 告警處理

#### 3.1 收到告警後

1. 確認告警真實性
2. 檢查相關日誌
3. 評估影響範圍
4. 執行修復程序
5. 記錄處理過程

## 備份策略

### 1. 備份頻率

- **資料庫**：每日完整備份
- **設定檔案**：每次變更後備份
- **報告檔案**：每週備份

### 2. 備份保留

- **每日備份**：保留 7 天
- **每週備份**：保留 4 週
- **每月備份**：保留 12 個月

### 3. 備份驗證

- 定期驗證備份檔案完整性
- 定期執行還原測試
- 記錄備份驗證結果

## 災難復原

### 1. 復原目標

- **RTO (Recovery Time Objective)**：≤ 4 小時
- **RPO (Recovery Point Objective)**：≤ 24 小時

### 2. 復原程序

#### 2.1 資料庫復原

1. 停止服務
2. 還原資料庫備份
3. 執行資料庫完整性檢查
4. 啟動服務
5. 驗證服務功能

#### 2.2 完整系統復原

1. 準備新環境
2. 還原資料庫
3. 還原設定檔案
4. 還原報告檔案
5. 啟動所有服務
6. 驗證系統功能

## 相關文件

- **操作手冊**：`docs/OPERATIONS.md`
- **部署文件**：`docs/DEPLOYMENT.md`
- **系統架構文件**：`docs/ARCHITECTURE.md`

