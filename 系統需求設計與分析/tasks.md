# 開發任務清單文件 (Development Tasks)

**專案名稱**：AI 驅動之自動化威脅情資管理系統 (AETIM)  
**文件版本**：v1.0.0  
**撰寫日期**：2025-11-21  
**最後修訂**：2025-11-21  
**文件狀態**：已核准 (Approved)

---

## 目錄

1. [目的](#1-目的)
2. [範圍](#2-範圍)
3. [任務組織方式](#3-任務組織方式)
4. [任務定義格式](#4-任務定義格式)
5. [階段 1：基礎建設與核心功能](#5-階段-1基礎建設與核心功能)
   - [5.1 專案初始化與基礎架構](#51-專案初始化與基礎架構)
   - [5.2 資料庫設計與實作](#52-資料庫設計與實作)
   - [5.3 基礎建設與情資定義模組 - 資產管理](#53-基礎建設與情資定義模組---資產管理)
   - [5.4 基礎建設與情資定義模組 - PIR 與威脅來源管理](#54-基礎建設與情資定義模組---pir-與威脅來源管理)
6. [階段 2：威脅收集與 AI 處理](#6-階段-2威脅收集與-ai-處理)
   - [6.1 AI/ML 服務開發](#61-aiml-服務開發)
   - [6.3 威脅資料儲存與查詢](#63-威脅資料儲存與查詢)
   - [6.2 威脅情資收集引擎](#62-威脅情資收集引擎)
   - [6.4 整合測試與優化](#64-整合測試與優化)
7. [階段 3：關聯分析與風險計算](#7-階段-3關聯分析與風險計算)
   - [7.1 關聯分析引擎](#71-關聯分析引擎)
   - [7.2 風險分數計算引擎](#72-風險分數計算引擎)
   - [7.3 風險評估介面](#73-風險評估介面)
   - [7.4 測試與優化](#74-測試與優化)
8. [階段 4：報告生成與通知](#8-階段-4報告生成與通知)
   - [8.1 報告生成服務](#81-報告生成服務)
   - [8.2 IT 工單生成](#82-it-工單生成)
   - [8.3 通知機制](#83-通知機制)
   - [8.4 報告與通知介面](#84-報告與通知介面)
9. [階段 5：Web 管理界面與系統整合](#9-階段-5web-管理界面與系統整合)
   - [9.1 身份驗證與授權](#91-身份驗證與授權)
   - [9.2 系統管理功能](#92-系統管理功能)
   - [9.3 統計與儀表板](#93-統計與儀表板)
   - [9.4 系統整合與優化](#94-系統整合與優化)
10. [任務追蹤與狀態管理](#10-任務追蹤與狀態管理)
11. [參考文件](#11-參考文件)

---

## 1. 目的

本文件旨在將「AI 驅動之自動化威脅情資管理系統 (AETIM)」的實作計畫（plan.md）轉換為具體、可執行的開發任務。

本文件遵循專案憲章（Project Constitution）的所有原則，特別是：
- **P0：規格驅動開發 (SDD)**：本文件為 Phase 3: 任務 (Tasks) 階段產出
- **P4：漸進式價值交付**：所有任務必須可追溯至 spec.md 中的特定使用者故事
- **P3：清晰與可測試性**：每個任務必須具有明確的驗收條件與測試要求

---

## 2. 範圍

### 2.1 任務範圍

本文件涵蓋以下內容：

1. **開發任務定義**
   - 將 plan.md 中的設計轉換為具體的開發任務
   - 每個任務對應至 spec.md 中的使用者故事
   - 任務包含：描述、驗收條件、測試要求、預估工時

2. **任務組織**
   - 按開發階段組織任務（5 個階段）
   - 按功能模組組織任務（4 個主要模組）
   - 按優先級排序任務

3. **任務追蹤**
   - 任務狀態管理（待處理、進行中、已完成、已驗收）
   - 任務負責人指派
   - 任務進度追蹤

### 2.2 不包含的內容

- 詳細的程式碼實作（將在 Phase 4: 執行階段完成）
- 測試案例的詳細內容（將在測試文件中定義）
- 部署與運維的詳細步驟（將在部署文件中定義）

---

## 3. 任務組織方式

### 3.1 組織結構

任務按以下方式組織：

1. **按開發階段**：5 個主要階段（對應 plan.md 第 10 章）
2. **按功能模組**：4 個主要模組（對應 plan.md 第 6 章）
3. **按使用者故事**：29 個使用者故事（對應 spec.md 第 5 章）

### 3.2 驗收報告要求

根據專案憲章 H4「驗收報告要求」，所有 Phase 4（執行階段）的任務完成後，**必須**建立對應的驗收報告：

- **報告存放位置**：`系統建置與驗證報告/{階段名稱}/`
- **報告命名格式**：`{任務編號}-{任務名稱}-驗收報告.md`
- **報告內容**：必須包含任務概述、執行內容、驗收條件檢查、測試結果、交付成果、相關文件、備註
- **建立時機**：任務完成後立即建立
- **README.md 更新**：建立驗收報告後，**必須**同步更新 `系統建置與驗證報告/README.md` 的「已完成任務」章節（專案憲章 H4 第 6 點）

詳細規範請參考：`系統建置與驗證報告/README.md`

#### 3.2.1 驗收報告檢查清單

建立驗收報告時，請確認以下項目：

- [ ] 驗收報告已建立並存放在正確的階段資料夾中
- [ ] 驗收報告命名符合規則：`{任務編號}-{任務名稱}-驗收報告.md`
- [ ] 驗收報告包含所有必要章節（任務概述、執行內容、驗收條件檢查、測試結果、交付成果、相關文件、備註）
- [ ] **已更新 `系統建置與驗證報告/README.md` 的「已完成任務」章節**
- [ ] **已更新 `系統建置與驗證報告/README.md` 的「最後更新」日期**
- [ ] 驗收報告可追溯至 `tasks.md` 中的對應任務
- [ ] 驗收報告可追溯至 `plan.md` 中的相關設計章節
- [ ] 驗收報告可追溯至 `spec.md` 中的相關使用者故事

### 3.2 任務優先級

任務優先級分為三級：

- **P0（高）**：核心功能，必須在階段內完成
- **P1（中）**：重要功能，建議在階段內完成
- **P2（低）**：輔助功能，可在後續階段完成

### 3.3 任務依賴關係

任務之間可能存在依賴關係：

- **前置任務**：必須先完成的任務
- **後續任務**：依賴前置任務的任務
- **並行任務**：可同時進行的任務

---

## 4. 任務定義格式

### 4.1 任務模板

每個任務包含以下欄位：

```markdown
### T-{階段編號}-{模組編號}-{任務序號}：{任務名稱}

**對應使用者故事**：US-{編號}  
**對應驗收條件**：AC-{編號}-{序號}  
**優先級**：P0 / P1 / P2  
**預估工時**：{小時數} 小時  
**負責人**：{角色或姓名}  
**狀態**：待處理 / 進行中 / 已完成 / 已驗收  

**任務描述**：
{詳細描述任務內容}

**驗收條件**：
- {驗收條件 1}
- {驗收條件 2}
- ...

**測試要求**：
- {測試要求 1}
- {測試要求 2}
- ...

**前置任務**：
- T-{編號}：{任務名稱}

**相關文件**：
- plan.md 第 {章節}
- spec.md 第 {章節}
```

### 4.2 任務編號規則

任務編號格式：`T-{階段編號}-{模組編號}-{任務序號}`

範例：
- `T-1-1-1`：階段 1，模組 1（專案初始化），任務 1
- `T-2-3-2`：階段 2，模組 3（威脅資料儲存），任務 2

---

## 5. 階段 1：基礎建設與核心功能

**目標**：建立系統基礎架構與核心資料管理功能  
**預估時程**：4-5 週  
**里程碑**：M1 - 基礎建設完成

### 5.1 專案初始化與基礎架構

**對應 plan.md**：第 10.1.1 節

#### T-1-1-1：建立專案結構

**對應使用者故事**：基礎架構  
**優先級**：P0  
**預估工時**：8 小時  
**狀態**：待處理

**任務描述**：
建立模組化單體架構的專案目錄結構，包含：
- 後端應用程式目錄結構（Domain、Application、Infrastructure、API）
- 前端應用程式目錄結構（Next.js 專案）
- AI 服務目錄結構
- 共用配置檔案（Docker、環境變數、依賴管理）

**驗收條件**：
- 專案目錄結構符合 plan.md 第 3.3 節的設計
- 所有必要的配置檔案已建立
- 專案可在本地環境成功啟動（Docker Compose）

**測試要求**：
- 驗證專案結構符合設計文件
- 驗證 Docker Compose 可正常啟動所有服務

**相關文件**：
- plan.md 第 3.3 節「模組化單體設計」

---

#### T-1-1-2：設定開發環境

**對應使用者故事**：基礎架構  
**對應 plan.md**：第 10.1.1 節「專案初始化與基礎架構」、第 9.1 節「容器化策略」  
**優先級**：P0  
**預估工時**：6 小時  
**狀態**：待處理

**任務描述**：
設定開發環境，包含：
- Docker 與 Docker Compose 配置
  - 後端服務容器（Python/FastAPI）
  - 前端服務容器（Next.js）
  - 資料庫容器（SQLite，使用 volume 掛載）
  - Redis 容器
  - 服務間網路配置
- 開發用資料庫（SQLite）
  - 資料庫檔案位置配置
  - 連線字串配置
- Redis 配置
  - Redis 連線字串配置
  - Redis 持久化配置（開發環境可選）
- 環境變數檔案（.env.example）
  - 資料庫連線設定
  - Redis 連線設定
  - 應用程式設定（LOG_LEVEL、ENVIRONMENT 等）
  - API URL 設定
- 開發工具配置
  - Python 虛擬環境設定（如需要）
  - Node.js 版本管理（.nvmrc）
  - 編輯器設定（.vscode/settings.json，可選）

**驗收條件**：
- Docker Compose 可正常啟動所有服務（docker-compose up）
- 資料庫連線正常（可執行查詢）
- Redis 連線正常（可執行命令）
- 所有服務健康檢查通過（/health 端點）
- 環境變數檔案完整且正確

**測試要求**：
- 驗證所有服務健康檢查通過
- 驗證服務間通訊正常（後端可連線資料庫與 Redis）

**前置任務**：
- T-1-1-1：建立專案結構

**相關文件**：
- plan.md 第 9.1 節「容器化策略」
- plan.md 第 9.2 節「環境配置」

---

#### T-1-1-3：建立 CI/CD 流程

**對應使用者故事**：基礎架構  
**對應 plan.md**：第 10.1.1 節「專案初始化與基礎架構」、第 8.5 節「測試自動化」  
**優先級**：P0  
**預估工時**：10 小時  
**狀態**：待處理

**任務描述**：
建立 CI/CD 流程，包含：
- GitHub Actions 工作流程（.github/workflows/）
  - 測試工作流程（test.yml）
    - 觸發條件（push、pull_request）
    - Python 環境設定
    - Node.js 環境設定
    - 依賴安裝
    - 測試執行（單元測試、整合測試）
    - 測試覆蓋率檢查（pytest-cov）
    - 覆蓋率報告上傳（codecov，可選）
  - 程式碼品質檢查工作流程（lint.yml）
    - Python Lint（ruff 或 black）
    - TypeScript/JavaScript Lint（ESLint）
    - 程式碼格式化檢查
  - 建置工作流程（build.yml，可選）
    - Docker 映像檔建置
    - 映像檔推送（如需要）
- 測試配置
  - pytest.ini 配置
  - 測試覆蓋率閾值設定（≥ 80%）
- 程式碼品質工具配置
  - ruff 或 black 配置（Python）
  - ESLint 配置（TypeScript/JavaScript）
  - Pre-commit hooks（可選）

**驗收條件**：
- CI/CD 流程可正常執行
- 程式碼提交時自動觸發測試（push、pull_request）
- 測試覆蓋率報告自動生成
- 程式碼品質檢查正常運作
- 測試失敗時阻止合併（如需要）
- 覆蓋率不足時阻止合併（< 80%）

**測試要求**：
- 驗證 CI/CD 流程正常運作（提交測試）
- 驗證測試失敗時流程正確處理
- 驗證覆蓋率檢查正常運作

**前置任務**：
- T-1-1-1：建立專案結構

**相關文件**：
- plan.md 第 8.5 節「測試自動化」
- plan.md 第 8.6 節「測試覆蓋率要求」

---

#### T-1-1-4：設定日誌與監控基礎設施

**對應使用者故事**：基礎架構  
**對應 plan.md**：第 10.1.1 節「專案初始化與基礎架構」、第 9.3 節「監控與日誌」  
**優先級**：P1  
**預估工時**：8 小時  
**狀態**：待處理

**任務描述**：
設定日誌與監控基礎設施，包含：
- 結構化日誌配置（JSON 格式）
  - 實作 StructuredFormatter（plan.md 第 9.3.1 節）
  - 設定日誌級別（DEBUG、INFO、WARN、ERROR、FATAL）
  - 設定日誌輸出（Console、File）
  - 日誌輪轉配置（RotatingFileHandler）
- 健康檢查端點實作
  - GET /health 端點（plan.md 第 9.3.2 節）
  - 資料庫連線檢查
  - Redis 連線檢查
  - 回應格式（status、timestamp、checks）
- 基本監控指標收集
  - 實作 /metrics 端點（plan.md 第 9.3.3 節）
  - 基本 KPI 收集（API 請求數、回應時間等）
  - Prometheus 格式支援（可選）
- 分佈式追蹤基礎設施
  - 追蹤 ID 生成（UUID）
  - 追蹤中介軟體實作（plan.md 第 9.3.5 節）
  - 追蹤 ID 加入回應標頭（X-Trace-Id）

**驗收條件**：
- 日誌以 JSON 格式輸出（符合 plan.md 第 9.3.1 節格式）
- 健康檢查端點可正常回應（/health）
- 健康檢查包含資料庫與 Redis 狀態
- 基本監控指標可正常收集（/metrics）
- 追蹤 ID 可正常生成與傳遞
- 日誌包含追蹤 ID（如需要）

**測試要求**：
- 驗證日誌格式正確（JSON 格式、包含必要欄位）
- 驗證健康檢查端點功能（正常/異常情況）
- 驗證監控指標收集正常
- 驗證追蹤 ID 功能正常

**前置任務**：
- T-1-1-2：設定開發環境

**相關文件**：
- plan.md 第 9.3 節「監控與日誌」
- plan.md 第 9.3.1 節「日誌記錄策略」
- plan.md 第 9.3.2 節「健康檢查實作」
- plan.md 第 9.3.3 節「指標監控」
- plan.md 第 9.3.5 節「分佈式追蹤」

---
### 5.2 資料庫設計與實作


**對應 plan.md**：第 10.1.1 節

#### T-1-2-1：實作資料庫 Schema

**對應使用者故事**：基礎架構  
**對應 plan.md**：第 10.1.1 節「資料庫設計與實作」、第 4.2 節「資料庫 Schema」  
**優先級**：P0  
**預估工時**：20 小時  
**狀態**：待處理

**任務描述**：
使用 SQLAlchemy 根據 plan.md 第 4.2 節的設計，實作所有資料庫表結構，包含：
- 資產管理模組
  - Assets 表（id、host_name、ip、operating_system、running_applications、owner、data_sensitivity、is_public_facing、business_criticality、created_at、updated_at）
  - AssetProducts 表（id、asset_id、product_name、product_version、created_at）
- 威脅情資模組
  - ThreatFeeds 表（id、name、description、priority、is_enabled、collection_frequency、collection_strategy、last_collected_at、status、error_message、created_at、updated_at）
  - Threats 表（id、cve_id、title、description、cvss_score、severity、source、collected_at、created_at、updated_at）
- 優先情資需求模組
  - PIRs 表（id、name、description、priority、condition_type、condition_value、is_enabled、created_at、updated_at）
- 關聯分析模組
  - ThreatAssetAssociations 表（id、threat_id、asset_id、matched_product、matched_version、confidence、created_at）
  - RiskAssessments 表（id、threat_id、base_score、weighted_factors、final_score、risk_level、calculated_at、created_at）
- 報告與通知模組
  - Reports 表（id、report_type、title、content、file_path、generated_at、created_at）
  - NotificationRules 表（id、notification_type、risk_threshold、is_enabled、recipients、schedule、created_at、updated_at）
  - Notifications 表（id、rule_id、recipient、subject、content、sent_at、status、created_at）
- 系統管理模組
  - Users 表（id、username、email、oidc_sub、created_at、updated_at）
  - Roles 表（id、name、description、created_at、updated_at）
  - Permissions 表（id、name、description、resource、action、created_at）
  - UserRoles 表（user_id、role_id、created_at）
  - RolePermissions 表（role_id、permission_id、created_at）
  - SystemConfigurations 表（id、key、value、description、updated_at）
  - Schedules 表（id、schedule_type、cron_expression、is_enabled、last_run_at、next_run_at、created_at、updated_at）
- 稽核日誌模組
  - AuditLogs 表（id、user_id、action_type、resource_type、resource_id、details、ip_address、user_agent、created_at）

**驗收條件**：
- 所有資料表符合 plan.md 第 4.2 節的設計
- 所有欄位型別正確（VARCHAR、INTEGER、BOOLEAN、TIMESTAMP 等）
- 所有索引已建立（主鍵、外鍵、查詢優化索引）
- 所有外鍵約束已設定（ON DELETE、ON UPDATE）
- 所有預設值已設定
- 所有 NOT NULL 約束已設定
- 符合資料庫命名規範

**測試要求**：
- 驗證資料表結構正確（使用 SQLAlchemy 的 create_all）
- 驗證索引與約束正常運作（插入、更新、刪除測試）
- 驗證外鍵關聯正常（關聯查詢測試）

**前置任務**：
- T-1-1-2：設定開發環境

**相關文件**：
- plan.md 第 4.2 節「資料庫 Schema」
- plan.md 第 4.1 節「資料模型」

---

#### T-1-2-2：建立資料庫遷移工具

**對應使用者故事**：基礎架構  
**對應 plan.md**：第 10.1.1 節「資料庫設計與實作」、第 4.3 節「資料遷移策略」  
**優先級**：P0  
**預估工時**：8 小時  
**狀態**：待處理

**任務描述**：
使用 Alembic 建立資料庫遷移工具，包含：
- 設定 Alembic 配置檔案（alembic.ini）
- 建立遷移目錄結構
- 實作遷移腳本生成機制
- 實作遷移執行機制（upgrade）
- 實作遷移回滾機制（downgrade）
- 建立遷移歷史追蹤機制

**驗收條件**：
- Alembic 配置正確，可正常運作
- 可成功執行資料庫遷移（alembic upgrade head）
- 可成功回滾遷移（alembic downgrade -1）
- 遷移歷史可追蹤（alembic history）
- 遷移腳本符合 plan.md 第 4.2 節的 Schema 設計

**測試要求**：
- 驗證遷移與回滾功能正常
- 驗證遷移歷史記錄正確
- 驗證遷移腳本可重複執行（idempotent）

**前置任務**：
- T-1-2-1：實作資料庫 Schema

**相關文件**：
- plan.md 第 4.3 節「資料遷移策略」
- plan.md 第 4.2 節「資料庫 Schema」

---

#### T-1-2-3：建立測試資料與資料種子腳本

**對應使用者故事**：基礎架構  
**對應 plan.md**：第 10.1.1 節「資料庫設計與實作」、第 8.1.5 節「測試資料管理」  
**優先級**：P1  
**預估工時**：6 小時  
**狀態**：待處理

**任務描述**：
建立測試資料與資料種子腳本，包含：
- 建立測試資料工廠（Factory Pattern）
- 建立測試用資產資料（至少 100 筆，涵蓋不同類型）
- 建立測試用 PIR 資料（5 個 PIR 項目）
- 建立測試用威脅來源資料（5 個來源）
- 建立測試用使用者與角色資料
- 建立資料種子腳本（可用於開發環境初始化）

**驗收條件**：
- 測試資料符合測試需求
- 測試資料涵蓋各種邊界情況
- 測試資料可重複使用（使用 fixtures）
- 資料種子腳本可正常執行
- 測試資料符合 spec.md 第 7 章的表單格式

**測試要求**：
- 驗證測試資料完整性
- 驗證資料種子腳本功能

**前置任務**：
- T-1-2-1：實作資料庫 Schema
- T-1-2-2：建立資料庫遷移工具

**相關文件**：
- plan.md 第 8.1.5 節「測試資料管理」
- spec.md 第 7 章「使用表單」

---
### 5.3 基礎建設與情資定義模組 - 資產管理


**對應 plan.md**：第 10.1.1 節  
**對應使用者故事**：US-001, US-002, US-003

#### T-1-3-1：實作資產領域模型

**對應使用者故事**：US-001, US-002  
**對應驗收條件**：AC-001-1, AC-001-2, AC-002-1, AC-002-2  
**對應 plan.md**：第 10.1.1 節「基礎建設與情資定義模組 - 資產管理」、第 6.1 節「基礎建設與情資定義模組」  
**優先級**：P0  
**預估工時**：16 小時  
**狀態**：待處理

**任務描述**：
實作資產領域模型（Domain Layer），包含：
- Asset 聚合根（包含所有業務邏輯方法）
  - 建立資產（create）
  - 更新資產（update）
  - 新增產品資訊（add_product）
  - 移除產品資訊（remove_product）
  - 計算風險權重（calculate_risk_weight）
- DataSensitivity 值物件（高/中/低，權重：1.5/1.0/0.5）
- BusinessCriticality 值物件（高/中/低，權重：1.5/1.0/0.5）
- AssetProduct 實體（產品名稱、版本）
- 領域事件（AssetCreatedEvent, AssetUpdatedEvent）

**驗收條件**：
- 領域模型符合 plan.md 第 6.1 節的設計
- 所有業務規則正確實作（資料驗證、業務邏輯）
- 值物件的權重計算正確
- 領域事件可正常發布
- 符合 DDD 原則（聚合根、實體、值物件）

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 所有業務規則通過測試
- 值物件計算邏輯測試通過
- 領域事件發布測試通過

**前置任務**：
- T-1-2-1：實作資料庫 Schema

**相關文件**：
- plan.md 第 6.1 節「基礎建設與情資定義模組」
- plan.md 第 3.2 節「有界上下文劃分」（Asset Management Context）
- spec.md US-001, US-002

---

#### T-1-3-2：實作資產 Repository

**對應使用者故事**：US-001, US-002, US-003  
**對應驗收條件**：AC-001-1, AC-002-1, AC-002-6, AC-003-1, AC-003-2, AC-003-3  
**對應 plan.md**：第 10.1.1 節「基礎建設與情資定義模組 - 資產管理」、第 6.1 節「基礎建設與情資定義模組」  
**優先級**：P0  
**預估工時**：12 小時  
**狀態**：待處理

**任務描述**：
實作資產 Repository（Infrastructure Layer），使用 SQLAlchemy，包含：
- 資產 CRUD 操作
  - save（新增/更新）
  - get_by_id（依 ID 查詢）
  - delete（刪除）
- 資產查詢功能
  - get_all（查詢所有，支援分頁）
  - search（依產品名稱、版本、類型等篩選）
  - sort（依資產名稱、產品名稱、版本等排序）
- 資產產品關聯管理
  - 批次儲存資產與產品關聯
- 查詢效能優化
  - 建立適當的資料庫索引
  - 使用 Eager Loading 避免 N+1 查詢問題

**驗收條件**：
- Repository 符合 plan.md 第 6.1 節的設計
- 所有 CRUD 操作正常運作
- 分頁功能正常（每頁至少 20 筆，AC-003-2）
- 排序功能正常（支援多個條件，AC-003-3）
- 篩選功能正常（依產品名稱、版本、類型等，AC-002-6）
- 查詢效能符合要求（NFR-001：API 回應時間 ≤ 2 秒）

**測試要求**：
- 整合測試通過（使用測試資料庫）
- 查詢效能測試通過（10,000 筆資料下回應時間 ≤ 2 秒）
- 分頁、排序、篩選功能測試通過

**前置任務**：
- T-1-2-1：實作資料庫 Schema
- T-1-3-1：實作資產領域模型

**相關文件**：
- plan.md 第 6.1 節「基礎建設與情資定義模組」
- plan.md 第 4.2 節「資料庫 Schema」（Assets、AssetProducts 表）
- spec.md US-001, US-002, US-003

---

#### T-1-3-3：實作資產服務

**對應使用者故事**：US-001, US-002  
**對應驗收條件**：AC-001-1 至 AC-001-7, AC-002-1 至 AC-002-6  
**對應 plan.md**：第 10.1.1 節「基礎建設與情資定義模組 - 資產管理」、第 6.1 節「基礎建設與情資定義模組」  
**優先級**：P0  
**預估工時**：20 小時  
**狀態**：待處理

**任務描述**：
實作資產服務（Application Layer），包含：
- AssetService（資產 CRUD 業務邏輯）
  - create_asset（建立資產）
  - update_asset（更新資產）
  - delete_asset（刪除資產，包含確認邏輯）
  - batch_delete_assets（批次刪除）
  - get_assets（查詢資產清單，支援分頁、排序、篩選）
  - get_asset_by_id（查詢資產詳情）
- AssetImportService（CSV 匯入功能）
  - parse_csv（解析 CSV 檔案）
  - validate_csv_format（驗證 CSV 格式，AC-001-3）
  - preview_import（匯入預覽，AC-001-4）
  - import_assets（執行匯入，支援批次處理至少 1000 筆，AC-001-5）
  - generate_import_result（生成匯入結果報告，AC-001-6）
- AssetParsingService（產品名稱與版本解析）
  - parse_products（從「運行的應用程式」欄位解析產品名稱與版本）
  - parse_os_info（從「作業系統」欄位解析 OS 資訊）
  - 實作 plan.md 第 6.1 節定義的欄位對應規則

**驗收條件**：
- 服務符合 plan.md 第 6.1 節的設計
- CSV 匯入功能正常運作（AC-001-1 至 AC-001-7）
- 產品名稱與版本解析準確（符合欄位對應規則）
- 批次匯入支援至少 1000 筆（AC-001-5）
- 資料驗證正確（必填欄位檢查，AC-002-2）
- 刪除確認邏輯正確實作（AC-002-3）
- 批次刪除功能正常（AC-002-5）
- 搜尋與篩選功能正常（AC-002-6）
- 稽核日誌記錄功能正常（AC-001-7, AC-002-4）

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 整合測試通過
- CSV 匯入功能測試通過（包含各種格式、錯誤情況）
- 產品解析功能測試通過（包含各種產品名稱格式）

**前置任務**：
- T-1-3-1：實作資產領域模型
- T-1-3-2：實作資產 Repository

**相關文件**：
- plan.md 第 6.1 節「基礎建設與情資定義模組」
- plan.md 第 4.2 節「資料庫 Schema」（Assets 表）
- spec.md US-001, US-002
- spec.md 第 7.1 節「資產清冊匯入表單」

---

#### T-1-3-4：實作資產 API 端點

**對應使用者故事**：US-001, US-002, US-003  
**對應驗收條件**：AC-001-1 至 AC-001-7, AC-002-1 至 AC-002-6, AC-003-1 至 AC-003-4  
**對應 plan.md**：第 10.1.1 節「基礎建設與情資定義模組 - 資產管理」、第 5.2 節「API 端點定義」  
**優先級**：P0  
**預估工時**：16 小時  
**狀態**：待處理

**任務描述**：
使用 FastAPI 實作資產 API 端點，包含：
- POST /api/v1/assets（建立資產）
  - 請求驗證（Pydantic 模型）
  - 呼叫 AssetService.create_asset
  - 記錄稽核日誌
- GET /api/v1/assets（查詢資產清單）
  - 支援查詢參數：page, pageSize, sort, filter
  - 回應包含分頁資訊（AC-003-2）
  - 支援多條件排序（AC-003-3）
- GET /api/v1/assets/{id}（查詢資產詳情）
  - 回應包含完整資產資訊（AC-003-4）
- PUT /api/v1/assets/{id}（更新資產）
  - 請求驗證
  - 呼叫 AssetService.update_asset
  - 記錄稽核日誌
- DELETE /api/v1/assets/{id}（刪除資產）
  - 呼叫 AssetService.delete_asset（包含確認邏輯）
  - 記錄稽核日誌
- POST /api/v1/assets/batch-delete（批次刪除）
  - 支援批次刪除（AC-002-5）
- POST /api/v1/assets/import（匯入資產）
  - 檔案上傳處理（CSV，≤ 10MB，AC-001-1）
  - 呼叫 AssetImportService
  - 回應包含匯入結果（成功/失敗筆數，AC-001-6）
- 錯誤處理
  - 統一的錯誤回應格式
  - 適當的 HTTP 狀態碼
- OpenAPI 文件
  - 使用 FastAPI 自動生成 OpenAPI 文件
  - 補充 API 描述與範例

**驗收條件**：
- API 端點符合 plan.md 第 5.2 節的設計
- 所有驗收條件通過（AC-001-1 至 AC-001-7, AC-002-1 至 AC-002-6, AC-003-1 至 AC-003-4）
- API 文件（OpenAPI）已更新且完整
- 錯誤處理正確
- 輸入驗證正確（防止 SQL 注入、XSS 等，NFR-006）
- API 回應時間符合要求（≤ 2 秒，NFR-001）

**測試要求**：
- API 整合測試通過
- 驗收條件測試通過（所有 AC 項目）
- 錯誤處理測試通過
- 效能測試通過（回應時間 ≤ 2 秒）

**前置任務**：
- T-1-3-3：實作資產服務

**相關文件**：
- plan.md 第 5.2 節「API 端點定義」
- plan.md 第 5.1 節「RESTful API 規格」
- spec.md US-001, US-002, US-003

---

#### T-1-3-5：實作前端資產管理介面

**對應使用者故事**：US-001, US-002, US-003  
**對應驗收條件**：AC-001-1 至 AC-001-7, AC-002-1 至 AC-002-6, AC-003-1 至 AC-003-4  
**對應 plan.md**：第 10.1.1 節「基礎建設與情資定義模組 - 資產管理」、第 6.4 節「Web 管理界面模組」  
**優先級**：P0  
**預估工時**：24 小時  
**狀態**：待處理

**任務描述**：
使用 Next.js + React + TypeScript + Tailwind CSS 實作前端資產管理介面，包含：
- 資產清單頁面
  - 表格顯示資產清單（AC-003-1）
  - 分頁控制（每頁至少 20 筆，AC-003-2）
  - 排序功能（依資產名稱、產品名稱、版本等，AC-003-3）
  - 篩選功能（依產品名稱、版本、類型等，AC-002-6）
  - 搜尋功能
  - 批次選擇與批次刪除（AC-002-5）
- 資產詳情頁面
  - 顯示完整資產資訊（AC-003-4）
  - 顯示關聯的產品清單
- 資產新增/編輯表單
  - 表單欄位驗證（必填欄位檢查，AC-002-2）
  - 明確的交易儲存（儲存/取消按鈕，P8）
  - 不採用即時儲存（Auto-Save）（P8）
- 資產匯入功能
  - CSV 檔案上傳（AC-001-1）
  - 檔案格式驗證（AC-001-3）
  - 匯入預覽（顯示解析結果，AC-001-4）
  - 確認匯入按鈕（明確的交易儲存，P8）
  - 匯入結果顯示（成功/失敗筆數，AC-001-6）
- 刪除確認對話框（AC-002-3）
- UI/UX 設計
  - 使用統一的設計系統（Tailwind CSS，P8）
  - 響應式設計
  - 載入狀態顯示
  - 錯誤訊息顯示

**驗收條件**：
- 所有驗收條件通過（AC-001-1 至 AC-001-7, AC-002-1 至 AC-002-6, AC-003-1 至 AC-003-4）
- UI/UX 符合設計規範（P8：一致的使用者體驗）
- 明確的交易儲存（P8：不得採用即時儲存）
- 頁面載入時間符合要求（≤ 2 秒，NFR-001）
- 表單驗證正確
- 錯誤處理與使用者回饋正確

**測試要求**：
- 端對端測試通過（使用 Playwright 或 Cypress）
- UI 測試通過
- 表單驗證測試通過
- 匯入功能測試通過（包含各種 CSV 格式）

**前置任務**：
- T-1-3-4：實作資產 API 端點

**相關文件**：
- plan.md 第 6.4 節「Web 管理界面模組」
- plan.md 第 3.4 節「技術堆疊選擇」（前端技術）
- spec.md US-001, US-002, US-003
- spec.md 第 7.1 節「資產清冊匯入表單」

---

### 5.4 基礎建設與情資定義模組 - PIR 與威脅來源管理

**對應 plan.md**：第 10.1.1 節  
**對應使用者故事**：US-004, US-005, US-006, US-007

#### T-1-4-1：實作 PIR 領域模型與服務

**對應使用者故事**：US-004, US-005  
**對應驗收條件**：AC-004-1 至 AC-004-5, AC-005-1 至 AC-005-3  
**對應 plan.md**：第 10.1.1 節「基礎建設與情資定義模組 - PIR 與威脅來源管理」、第 6.1 節「基礎建設與情資定義模組」  
**優先級**：P0  
**預估工時**：16 小時  
**狀態**：待處理

**任務描述**：
實作 PIR 領域模型與服務，包含：
- PIR 聚合根（Domain Layer）
  - 名稱、描述
  - 優先級（高/中/低）
  - 條件類型與條件值（產品名稱、CVE 編號、威脅類型等，AC-004-3）
  - 啟用狀態（is_enabled）
  - 業務規則：停用的 PIR 不得影響威脅分析流程（AC-005-2）
  - 領域事件（PIRCreatedEvent, PIRUpdatedEvent, PIRToggledEvent）
- PIRRepository（Infrastructure Layer）
  - CRUD 操作
  - 查詢啟用的 PIR
  - 查詢符合條件的 PIR
- PIRService（Application Layer）
  - create_pir（建立 PIR，AC-004-1, AC-004-2）
  - update_pir（更新 PIR）
  - delete_pir（刪除 PIR）
  - toggle_pir（啟用/停用 PIR，AC-005-1）
  - get_pirs（查詢 PIR 清單）
  - get_enabled_pirs（查詢啟用的 PIR）
  - 記錄稽核日誌（AC-004-5, AC-005-3）

**驗收條件**：
- 領域模型符合 plan.md 第 6.1 節的設計
- 所有驗收條件通過（AC-004-1 至 AC-004-5, AC-005-1 至 AC-005-3）
- PIR 條件定義正確（支援產品名稱、CVE 編號、威脅類型等，AC-004-3）
- 啟用/停用功能正常（AC-005-1）
- 停用的 PIR 不影響威脅分析（AC-005-2）
- 稽核日誌記錄正確（AC-004-5, AC-005-3）

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 整合測試通過
- PIR 條件匹配邏輯測試通過
- 啟用/停用功能測試通過

**前置任務**：
- T-1-2-1：實作資料庫 Schema

**相關文件**：
- plan.md 第 6.1 節「基礎建設與情資定義模組」
- plan.md 第 4.2 節「資料庫 Schema」（PIRs 表）
- spec.md US-004, US-005
- spec.md 第 7.2 節「優先情資需求定義表單」

---

#### T-1-4-2：實作威脅情資來源管理

**對應使用者故事**：US-006, US-007  
**對應驗收條件**：AC-006-1 至 AC-006-5, AC-007-1 至 AC-007-3  
**對應 plan.md**：第 10.1.1 節「基礎建設與情資定義模組 - PIR 與威脅來源管理」、第 6.1 節「基礎建設與情資定義模組」  
**優先級**：P0  
**預估工時**：16 小時  
**狀態**：待處理

**任務描述**：
實作威脅情資來源管理，包含：
- ThreatFeed 領域模型（Domain Layer）
  - 名稱、描述
  - 優先級（P0/P1/P2/P3）
  - 對應的 PIR(s)（多對多關係）
  - 啟用狀態（is_enabled）
  - 收集頻率（每小時、每日、每週等，AC-006-3）
  - 收集策略（API、RSS、Web 爬蟲等）
  - 最後收集時間（last_collected_at）
  - 收集狀態（success/failed/in_progress，AC-007-1）
  - 錯誤訊息（error_message，AC-007-2）
  - 領域事件（ThreatFeedCreatedEvent, ThreatFeedUpdatedEvent）
- ThreatFeedRepository（Infrastructure Layer）
  - CRUD 操作
  - 查詢啟用的來源
  - 查詢依優先級排序的來源
  - 更新收集狀態與時間
- ThreatFeedService（Application Layer）
  - create_threat_feed（建立來源，AC-006-1, AC-006-2）
  - update_threat_feed（更新來源）
  - delete_threat_feed（刪除來源）
  - toggle_threat_feed（啟用/停用來源，AC-006-2）
  - set_collection_frequency（設定收集頻率，AC-006-3）
  - get_threat_feeds（查詢來源清單）
  - get_collection_status（查詢收集狀態，AC-006-5, AC-007-1, AC-007-2）
  - update_collection_status（更新收集狀態與日誌，AC-007-3）
  - 記錄稽核日誌（AC-006-4）

**驗收條件**：
- 領域模型符合 plan.md 第 6.1 節的設計
- 所有驗收條件通過（AC-006-1 至 AC-006-5, AC-007-1 至 AC-007-3）
- 支援所有指定的威脅情資來源（CISA KEV、NVD、VMware VMSA、MSRC、TWCERT，AC-006-1）
- 啟用/停用功能正常（AC-006-2）
- 收集頻率設定正常（AC-006-3）
- 收集狀態顯示正確（AC-006-5, AC-007-1, AC-007-2）
- 收集日誌記錄正確（AC-007-3）
- 稽核日誌記錄正確（AC-006-4）

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 整合測試通過
- 收集狀態管理測試通過

**前置任務**：
- T-1-2-1：實作資料庫 Schema

**相關文件**：
- plan.md 第 6.1 節「基礎建設與情資定義模組」
- plan.md 第 4.2 節「資料庫 Schema」（ThreatFeeds 表）
- spec.md US-006, US-007
- spec.md 第 7.3 節「威脅情資來源訂閱表單」

---

#### T-1-4-3：實作 PIR 與威脅來源 API 端點

**對應使用者故事**：US-004, US-005, US-006, US-007  
**對應驗收條件**：AC-004-1 至 AC-004-5, AC-005-1 至 AC-005-3, AC-006-1 至 AC-006-5, AC-007-1 至 AC-007-3  
**對應 plan.md**：第 10.1.1 節「基礎建設與情資定義模組 - PIR 與威脅來源管理」、第 5.2 節「API 端點定義」  
**優先級**：P0  
**預估工時**：14 小時  
**狀態**：待處理

**任務描述**：
使用 FastAPI 實作 PIR 與威脅來源 API 端點，包含：
- PIR API 端點
  - POST /api/v1/pirs（建立 PIR）
  - GET /api/v1/pirs（查詢 PIR 清單）
  - GET /api/v1/pirs/{id}（查詢 PIR 詳情）
  - PUT /api/v1/pirs/{id}（更新 PIR）
  - DELETE /api/v1/pirs/{id}（刪除 PIR）
  - PATCH /api/v1/pirs/{id}/toggle（啟用/停用 PIR）
- 威脅來源 API 端點
  - POST /api/v1/threat-feeds（建立威脅來源）
  - GET /api/v1/threat-feeds（查詢威脅來源清單）
  - GET /api/v1/threat-feeds/{id}（查詢威脅來源詳情）
  - PUT /api/v1/threat-feeds/{id}（更新威脅來源）
  - DELETE /api/v1/threat-feeds/{id}（刪除威脅來源）
  - PATCH /api/v1/threat-feeds/{id}/toggle（啟用/停用威脅來源）
  - GET /api/v1/threat-feeds/{id}/status（查詢收集狀態）
- 錯誤處理與輸入驗證
- OpenAPI 文件更新

**驗收條件**：
- API 端點符合 plan.md 第 5.2 節的設計
- 所有驗收條件通過（AC-004-1 至 AC-004-5, AC-005-1 至 AC-005-3, AC-006-1 至 AC-006-5, AC-007-1 至 AC-007-3）
- API 文件（OpenAPI）已更新且完整
- 錯誤處理正確
- 輸入驗證正確
- API 回應時間符合要求（≤ 2 秒，NFR-001）

**測試要求**：
- API 整合測試通過
- 驗收條件測試通過（所有 AC 項目）
- 錯誤處理測試通過

**前置任務**：
- T-1-4-1：實作 PIR 領域模型與服務
- T-1-4-2：實作威脅情資來源管理

**相關文件**：
- plan.md 第 5.2 節「API 端點定義」
- plan.md 第 5.1 節「RESTful API 規格」
- spec.md US-004, US-005, US-006, US-007

---

#### T-1-4-4：實作前端 PIR 與威脅來源管理介面

**對應使用者故事**：US-004, US-005, US-006, US-007  
**對應驗收條件**：AC-004-1 至 AC-004-5, AC-005-1 至 AC-005-3, AC-006-1 至 AC-006-5, AC-007-1 至 AC-007-3  
**對應 plan.md**：第 10.1.1 節「基礎建設與情資定義模組 - PIR 與威脅來源管理」、第 6.4 節「Web 管理界面模組」  
**優先級**：P0  
**預估工時**：20 小時  
**狀態**：待處理

**任務描述**：
使用 Next.js + React + TypeScript + Tailwind CSS 實作前端 PIR 與威脅來源管理介面，包含：
- PIR 管理介面
  - PIR 清單頁面（顯示所有 PIR）
  - PIR 新增/編輯表單
    - 名稱、描述欄位（AC-004-2）
    - 優先級選擇（高/中/低，AC-004-2）
    - 條件類型與條件值設定（產品名稱、CVE 編號、威脅類型等，AC-004-3）
    - 啟用/停用開關（AC-005-1）
    - 明確的交易儲存（儲存/取消按鈕，P8）
  - PIR 詳情頁面
- 威脅來源管理介面
  - 威脅來源清單頁面
    - 顯示所有威脅來源（AC-006-1）
    - 顯示最後收集時間與狀態（AC-006-5, AC-007-1）
    - 顯示收集失敗的錯誤訊息（AC-007-2）
  - 威脅來源新增/編輯表單
    - 名稱、描述欄位
    - 優先級選擇（P0/P1/P2/P3）
    - 對應的 PIR(s) 選擇（多選）
    - 啟用/停用開關（AC-006-2）
    - 收集頻率設定（每小時、每日、每週等，AC-006-3）
    - 收集策略設定
    - 明確的交易儲存（儲存/取消按鈕，P8）
  - 威脅來源詳情頁面
    - 顯示收集狀態（AC-007-1）
    - 顯示收集日誌（AC-007-3）
- UI/UX 設計
  - 使用統一的設計系統（Tailwind CSS，P8）
  - 響應式設計
  - 載入狀態顯示
  - 錯誤訊息顯示

**驗收條件**：
- 所有驗收條件通過（AC-004-1 至 AC-004-5, AC-005-1 至 AC-005-3, AC-006-1 至 AC-006-5, AC-007-1 至 AC-007-3）
- UI/UX 符合設計規範（P8：一致的使用者體驗）
- 明確的交易儲存（P8：不得採用即時儲存）
- 頁面載入時間符合要求（≤ 2 秒，NFR-001）
- 表單驗證正確
- 錯誤處理與使用者回饋正確

**測試要求**：
- 端對端測試通過（使用 Playwright 或 Cypress）
- UI 測試通過
- 表單驗證測試通過
- 啟用/停用功能測試通過

**前置任務**：
- T-1-4-3：實作 PIR 與威脅來源 API 端點

**相關文件**：
- plan.md 第 6.4 節「Web 管理界面模組」
- plan.md 第 3.4 節「技術堆疊選擇」（前端技術）
- spec.md US-004, US-005, US-006, US-007
- spec.md 第 7.2 節「優先情資需求定義表單」
- spec.md 第 7.3 節「威脅情資來源訂閱表單」

---

#### T-1-4-5：實作稽核日誌服務

**對應使用者故事**：US-001, US-002, US-004, US-005, US-006（所有涉及資料異動的操作）  
**對應驗收條件**：AC-001-7, AC-002-4, AC-004-5, AC-005-3, AC-006-4  
**對應 plan.md**：第 10.1.1 節「基礎建設與情資定義模組」、第 4.2 節「資料庫 Schema」（AuditLogs 表）、第 6.1 節「基礎建設與情資定義模組」  
**優先級**：P0  
**預估工時**：8 小時  
**狀態**：已完成

**任務描述**：
實作稽核日誌服務，用於記錄所有涉及資料存取、修改、刪除的操作，符合 ISO 27001:2022 要求（NFR-005），包含：
- AuditLogService（Application Layer）
  - log_action（記錄操作）
    - 操作者（user_id）
    - 時間戳記（created_at）
    - 操作類型（action_type：CREATE、UPDATE、DELETE、IMPORT 等）
    - 資源類型（resource_type：Asset、PIR、ThreatFeed 等）
    - 資源識別碼（resource_id）
    - 操作詳情（details：JSON 格式，包含變更前後的值）
    - IP 位址（ip_address）
    - User Agent（user_agent）
  - get_audit_logs（查詢稽核日誌）
    - 支援依使用者、操作類型、資源類型、時間範圍篩選
    - 支援分頁
- AuditLogRepository（Infrastructure Layer）
  - save（儲存稽核日誌）
  - get_by_filters（依條件查詢）
- 稽核日誌中介軟體
  - 自動記錄 API 請求（可選）
  - 提取使用者資訊、IP 位址、User Agent

**驗收條件**：
- 稽核日誌服務符合 plan.md 第 4.2 節的設計
- 所有驗收條件通過（AC-001-7, AC-002-4, AC-004-5, AC-005-3, AC-006-4）
- 稽核日誌包含所有必要欄位（操作者、時間戳記、操作類型、資源識別碼、操作結果）
- 稽核日誌不可篡改（寫入後不可修改）
- 稽核日誌查詢功能正常
- 符合 NFR-005 要求

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 整合測試通過
- 驗證稽核日誌記錄正確（所有欄位）
- 驗證稽核日誌不可篡改

**前置任務**：
- T-1-2-1：實作資料庫 Schema（AuditLogs 表）

**相關文件**：
- plan.md 第 4.2 節「資料庫 Schema」（AuditLogs 表）
- plan.md 第 6.1 節「基礎建設與情資定義模組」
- spec.md NFR-005「稽核日誌」

---

## 6. 階段 2：威脅收集與 AI 處理

**目標**：實作自動化威脅收集與 AI 資訊提取功能  
**預估時程**：5-6 週  
**里程碑**：M2 - 威脅收集與 AI 處理完成

**對應 plan.md**：第 10.1.2 節「階段 2：威脅收集與 AI 處理」  
**對應使用者故事**：US-008, US-009, US-014

### 6.1 AI/ML 服務開發

**對應 plan.md**：第 10.1.2 節「AI/ML 服務開發」、第 7 章「AI/ML 整合設計」

#### T-2-1-1：建立 AI 服務專案結構

**對應使用者故事**：US-009  
**對應 plan.md**：第 10.1.2 節「AI/ML 服務開發」、第 7.1.4 節「AI 服務實作架構」  
**優先級**：P0  
**預估工時**：6 小時  
**狀態**：已完成

**任務描述**：
建立 AI/ML 服務的專案結構（獨立 Python 服務），包含：
- 專案目錄結構
  - app/main.py（FastAPI 應用程式入口）
  - app/models/（請求/回應模型）
  - app/services/（NLP 服務、提取服務、摘要服務）
  - app/processors/（CVE、產品、TTP、IOC 提取器）
  - app/models/（ML 模型管理）
- Dockerfile（AI 服務容器化）
- requirements.txt（Python 依賴：FastAPI、spaCy、transformers、regex）
- 環境變數配置（.env.example）
- Docker Compose 配置更新（加入 ai-service 服務）

**驗收條件**：
- 專案目錄結構符合 plan.md 第 7.1.4 節的設計
- Dockerfile 可正常建置
- Docker Compose 可正常啟動 AI 服務
- 所有必要的配置檔案已建立

**測試要求**：
- 驗證專案結構符合設計文件
- 驗證 Docker Compose 可正常啟動 AI 服務
- 驗證 AI 服務健康檢查端點可正常回應

**相關文件**：
- plan.md 第 7.1.4 節「AI 服務實作架構」
- plan.md 第 9.1 節「容器化策略」（AI 服務 Dockerfile）

---

#### T-2-1-2：實作 CVE 編號提取器

**對應使用者故事**：US-009  
**對應驗收條件**：AC-009-1  
**對應 plan.md**：第 10.1.2 節「AI/ML 服務開發」、第 7.2.1 節「CVE 編號識別」  
**優先級**：P0  
**預估工時**：4 小時  
**狀態**：已完成

**任務描述**：
實作 CVE 編號提取器（processors/cve_extractor.py），包含：
- CVEExtractor 類別
- extract 方法（提取單一 CVE 編號）
  - 使用正則表達式匹配 CVE 格式（CVE-YYYY-NNNNN，AC-009-1）
  - 驗證格式正確性
  - 返回標準化格式（大寫）
- extract_all 方法（提取所有 CVE 編號）
  - 從文字中提取所有符合格式的 CVE 編號
  - 去重處理

**驗收條件**：
- 可正確識別 CVE 編號（格式：CVE-YYYY-NNNNN，AC-009-1）
- 支援各種 CVE 格式變體（大小寫、空格等）
- 提取結果準確（無誤判、無遺漏）
- 處理邊界情況（無 CVE、多個 CVE、格式錯誤等）

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 測試各種 CVE 格式（正確、錯誤、邊界情況）
- 測試提取準確度（≥ 95%）

**前置任務**：
- T-2-1-1：建立 AI 服務專案結構

**相關文件**：
- plan.md 第 7.2.1 節「CVE 編號識別」
- spec.md US-009, AC-009-1

---

#### T-2-1-3：實作產品名稱與版本提取器

**對應使用者故事**：US-009  
**對應驗收條件**：AC-009-2  
**對應 plan.md**：第 10.1.2 節「AI/ML 服務開發」、第 7.2.2 節「產品名稱與版本提取」  
**優先級**：P0  
**預估工時**：12 小時  
**狀態**：已完成

**任務描述**：
實作產品名稱與版本提取器（processors/product_extractor.py），包含：
- ProductExtractor 類別
- extract 方法（提取產品名稱與版本）
  - 關鍵字匹配（常見產品：Windows Server、VMware、SQL Server、Apache、MySQL、Delphi、EEP、Ruby On Rails）
  - spaCy NER 實體識別（PRODUCT 標籤）
  - 版本號提取（v1.0、1.0、7.0.3、2024 等格式）
  - 信心分數計算（關鍵字匹配：0.8，NER：0.7）
- _extract_version 方法（提取版本號）
  - 使用正則表達式匹配版本號模式
  - 支援多種版本格式

**驗收條件**：
- 可正確識別產品名稱與版本資訊（AC-009-2）
- 支援常見產品關鍵字匹配
- 支援 spaCy NER 識別
- 版本號提取準確
- 提供信心分數

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 測試各種產品名稱格式
- 測試版本號提取（各種格式）
- 測試提取準確度（≥ 80%）

**前置任務**：
- T-2-1-1：建立 AI 服務專案結構

**相關文件**：
- plan.md 第 7.2.2 節「產品名稱與版本提取」
- spec.md US-009, AC-009-2

---

#### T-2-1-4：實作 TTPs 與 IOC 提取器

**對應使用者故事**：US-009  
**對應驗收條件**：AC-009-3, AC-009-4  
**對應 plan.md**：第 10.1.2 節「AI/ML 服務開發」、第 7.2.3 節「TTPs 識別」、第 7.2.4 節「IOC 提取」  
**優先級**：P0  
**預估工時**：10 小時  
**狀態**：已完成

**任務描述**：
實作 TTPs 與 IOC 提取器，包含：
- TTPExtractor 類別（processors/ttp_extractor.py）
  - extract 方法（提取 TTPs）
    - MITRE ATT&CK TTP 關鍵字對應表
    - 關鍵字匹配（釣魚、phishing、命令執行、command execution 等）
    - 返回 TTP ID 列表（T1566.001、T1059.001 等，AC-009-3）
- IOCExtractor 類別（processors/ioc_extractor.py）
  - extract 方法（提取 IOCs）
    - IP 位址提取（正則表達式 + IP 驗證，AC-009-4）
    - 網域提取（正則表達式 + 格式驗證，AC-009-4）
    - 檔案雜湊值提取（MD5、SHA256，AC-009-4）
  - _extract_ips、_extract_domains、_extract_hashes 方法

**驗收條件**：
- 可正確識別 TTPs（AC-009-3）
- 可正確識別 IOCs（IP、網域、雜湊值，AC-009-4）
- TTP 關鍵字對應正確
- IOC 格式驗證正確（避免誤判）
- 提取結果準確

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 測試各種 TTP 關鍵字
- 測試各種 IOC 格式（IP、網域、雜湊值）
- 測試提取準確度（≥ 85%）

**前置任務**：
- T-2-1-1：建立 AI 服務專案結構

**相關文件**：
- plan.md 第 7.2.3 節「TTPs 識別」
- plan.md 第 7.2.4 節「IOC 提取」
- spec.md US-009, AC-009-3, AC-009-4

---

#### T-2-1-5：實作整合提取服務

**對應使用者故事**：US-009  
**對應驗收條件**：AC-009-1 至 AC-009-5  
**對應 plan.md**：第 10.1.2 節「AI/ML 服務開發」、第 7.2.5 節「整合提取服務」  
**優先級**：P0  
**預估工時**：8 小時  
**狀態**：已完成

**任務描述**：
實作整合提取服務（services/extraction_service.py），包含：
- ExtractionService 類別
- extract 方法（整合所有提取器）
  - 呼叫 CVEExtractor.extract
  - 呼叫 ProductExtractor.extract
  - 呼叫 TTPExtractor.extract
  - 呼叫 IOCExtractor.extract
  - 計算整體信心分數（_calculate_confidence）
    - CVE：0.3
    - Products：0.3
    - TTPs：0.2
    - IOCs：0.2
  - 返回整合結果（cve、products、ttps、iocs、confidence，AC-009-5）

**驗收條件**：
- 整合所有提取器功能
- 可從文字內容中提取所有威脅資訊（AC-009-1 至 AC-009-4）
- 提供整體信心分數（AC-009-5）
- 處理錯誤情況（提取器失敗時回退）
- 結果格式符合 API 規格

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 整合測試通過（所有提取器協同運作）
- 測試各種文字內容格式
- 測試錯誤處理

**前置任務**：
- T-2-1-2：實作 CVE 編號提取器
- T-2-1-3：實作產品名稱與版本提取器
- T-2-1-4：實作 TTPs 與 IOC 提取器

**相關文件**：
- plan.md 第 7.2.5 節「整合提取服務」
- spec.md US-009, AC-009-1 至 AC-009-5

---

#### T-2-1-6：實作 AI 服務 API

**對應使用者故事**：US-009  
**對應驗收條件**：AC-009-1 至 AC-009-6  
**對應 plan.md**：第 10.1.2 節「AI/ML 服務開發」、第 7.1.3 節「AI 服務 API 設計」、第 7.2.6 節「API 端點實作」  
**優先級**：P0  
**預估工時**：8 小時  
**狀態**：已完成

**任務描述**：
使用 FastAPI 實作 AI 服務 API，包含：
- POST /api/v1/ai/extract（提取威脅資訊）
  - 請求模型（ExtractRequest：text）
  - 呼叫 ExtractionService.extract
  - 回應模型（ExtractResponse：cve、products、ttps、iocs、confidence）
  - 記錄 AI 處理日誌（輸入內容、提取結果、信心分數，AC-009-6）
- POST /api/v1/ai/summarize（生成摘要，可選）
- POST /api/v1/ai/translate-to-business（轉換為業務語言，可選）
- GET /api/v1/ai/health（健康檢查）
- 錯誤處理
- OpenAPI 文件生成

**驗收條件**：
- API 端點符合 plan.md 第 7.1.3 節的設計
- 所有驗收條件通過（AC-009-1 至 AC-009-6）
- API 回應格式正確
- AI 處理日誌記錄正確（AC-009-6）
- 錯誤處理正確
- API 文件（OpenAPI）已更新

**測試要求**：
- API 整合測試通過
- 驗收條件測試通過
- 錯誤處理測試通過
- 日誌記錄測試通過

**前置任務**：
- T-2-1-5：實作整合提取服務

**相關文件**：
- plan.md 第 7.1.3 節「AI 服務 API 設計」
- plan.md 第 7.2.6 節「API 端點實作」
- spec.md US-009, AC-009-1 至 AC-009-6

---

#### T-2-1-7：測試與優化 AI 提取準確度

**對應使用者故事**：US-009  
**對應驗收條件**：AC-009-1 至 AC-009-5  
**對應 plan.md**：第 10.1.2 節「AI/ML 服務開發」  
**優先級**：P0  
**預估工時**：16 小時  
**狀態**：已完成

**任務描述**：
測試與優化 AI 提取準確度，包含：
- 建立測試資料集
  - 各種格式的威脅情資文字（CISA KEV、NVD、TWCERT 等）
  - 標註正確答案（CVE、產品、TTP、IOC）
- 準確度測試
  - CVE 提取準確度（目標 ≥ 95%）
  - 產品名稱提取準確度（目標 ≥ 80%）
  - TTP 提取準確度（目標 ≥ 85%）
  - IOC 提取準確度（目標 ≥ 90%）
- 優化調整
  - 調整正則表達式模式
  - 調整關鍵字列表
  - 調整信心分數計算邏輯
  - 優化 spaCy 模型使用
- 效能測試
  - 處理時間測試
  - 並發處理測試
  - 資源使用量測試

**驗收條件**：
- CVE 提取準確度 ≥ 95%
- 產品名稱提取準確度 ≥ 80%
- TTP 提取準確度 ≥ 85%
- IOC 提取準確度 ≥ 90%
- 處理時間符合要求（單一請求 ≤ 5 秒）
- 資源使用量合理

**測試要求**：
- 準確度測試通過（使用測試資料集）
- 效能測試通過
- 邊界情況測試通過

**前置任務**：
- T-2-1-6：實作 AI 服務 API

**相關文件**：
- plan.md 第 10.1.2 節「AI/ML 服務開發」
- spec.md US-009

---

### 6.2 威脅情資收集引擎

**對應 plan.md**：第 10.1.2 節「威脅情資收集引擎」、第 6.2 節「自動化收集與關聯分析模組」

#### T-2-2-1：實作威脅領域模型

**對應使用者故事**：US-008, US-014  
**對應驗收條件**：AC-008-5, AC-008-6, AC-014-1, AC-014-3  
**對應 plan.md**：第 10.1.2 節「威脅情資收集引擎」、第 6.2.2 節「核心類別設計」  
**優先級**：P0  
**預估工時**：12 小時  
**狀態**：已完成

**任務描述**：
實作威脅領域模型（Domain Layer），包含：
- Threat 聚合根
  - id、cve_id、title、description
  - cvss_score、severity
  - source、threat_feed_id
  - collected_at、created_at、updated_at
  - status（新增、分析中、已處理、已關閉，AC-014-3）
  - products（產品清單）
  - ttps（TTPs 清單）
  - iocs（IOCs 字典）
  - 業務規則方法
    - update_status（更新狀態）
    - add_product（新增產品資訊）
    - add_ttp（新增 TTP）
    - add_ioc（新增 IOC）
  - 領域事件（ThreatCreatedEvent, ThreatStatusUpdatedEvent）

**驗收條件**：
- 領域模型符合 plan.md 第 6.2.2 節的設計
- 所有業務規則正確實作
- 狀態管理正確（AC-014-3）
- 領域事件可正常發布
- 符合 DDD 原則

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 所有業務規則通過測試
- 狀態轉換測試通過
- 領域事件發布測試通過

**前置任務**：
- T-1-2-1：實作資料庫 Schema（Threats 表）

**相關文件**：
- plan.md 第 6.2.2 節「核心類別設計」（Threat 聚合根）
- plan.md 第 4.2 節「資料庫 Schema」（Threats 表）
- spec.md US-008, US-014

---

#### T-2-2-2：實作威脅收集服務

**對應使用者故事**：US-008  
**對應驗收條件**：AC-008-1 至 AC-008-7  
**對應 plan.md**：第 10.1.2 節「威脅情資收集引擎」、第 6.2.2 節「核心類別設計」  
**優先級**：P0  
**預估工時**：16 小時  
**狀態**：已完成

**任務描述**：
實作威脅收集服務（Application Layer），包含：
- ThreatCollectionService 類別
  - collect_from_feed（從單一來源收集）
    - 取得威脅來源設定
    - 呼叫對應的收集器（CISA KEV、NVD、VMware VMSA、MSRC、TWCERT）
    - 處理收集結果
    - 標準化為統一資料模型（AC-008-5）
    - 提取關鍵資訊（CVE、產品、版本、CVSS，AC-008-6）
    - 使用 AI 服務處理非結構化資料（AC-008-7）
    - 更新收集狀態與時間
    - 記錄收集日誌
  - collect_all_feeds（收集所有啟用的來源）
    - 支援並行收集（至少 3 個來源，AC-008-2）
    - 使用 asyncio 或執行緒池
  - 錯誤處理與重試機制（AC-008-3, AC-008-4）
    - API 速率限制處理
    - 錯誤重試（指數退避）
    - 連續失敗告警

**驗收條件**：
- 可根據排程自動執行收集作業（AC-008-1）
- 支援多個來源的並行收集（至少 3 個，AC-008-2）
- 處理來源 API 的速率限制與錯誤重試（AC-008-3）
- 收集失敗時記錄錯誤日誌，連續失敗時發送告警（AC-008-4）
- 解析不同來源的資料格式，標準化為統一資料模型（AC-008-5）
- 識別並提取關鍵資訊（CVE、產品、版本、CVSS，AC-008-6）
- 使用 AI/NLP 技術處理非結構化資料（AC-008-7）

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 整合測試通過（Mock 外部 API）
- 並行收集測試通過
- 錯誤處理與重試測試通過

**前置任務**：
- T-2-2-1：實作威脅領域模型
- T-2-1-6：實作 AI 服務 API

**相關文件**：
- plan.md 第 6.2.2 節「核心類別設計」（ThreatCollectionService）
- spec.md US-008, AC-008-1 至 AC-008-7

---

#### T-2-2-3：實作 CISA KEV 收集器

**對應使用者故事**：US-008  
**對應驗收條件**：AC-008-1, AC-008-5, AC-008-6  
**對應 plan.md**：第 10.1.2 節「威脅情資收集引擎」  
**優先級**：P0  
**預估工時**：8 小時  
**狀態**：已完成

**任務描述**：
實作 CISA KEV 收集器（Infrastructure Layer），包含：
- CISAKEVCollector 類別
  - collect 方法
    - 呼叫 CISA KEV API（https://www.cisa.gov/known-exploited-vulnerabilities-catalog）
    - 解析 JSON 回應
    - 提取 CVE 編號、產品名稱、描述等資訊
    - 標準化為 Threat 領域模型
  - 錯誤處理
    - API 連線錯誤
    - 資料格式錯誤
    - 速率限制處理

**驗收條件**：
- 可成功從 CISA KEV API 收集資料
- 正確解析 JSON 格式
- 正確提取 CVE 編號、產品名稱等資訊
- 標準化為統一資料模型（AC-008-5）
- 錯誤處理正確

**測試要求**：
- 單元測試通過（使用 Mock API）
- 整合測試通過（實際 API 呼叫，可選）
- 錯誤處理測試通過

**前置任務**：
- T-2-2-2：實作威脅收集服務

**相關文件**：
- plan.md 第 10.1.2 節「威脅情資收集引擎」
- spec.md US-008, AC-008-1
- CISA KEV API 文件

---

#### T-2-2-4：實作 NVD 收集器

**對應使用者故事**：US-008  
**對應驗收條件**：AC-008-1, AC-008-5, AC-008-6  
**對應 plan.md**：第 10.1.2 節「威脅情資收集引擎」  
**優先級**：P0  
**預估工時**：10 小時  
**狀態**：已完成

**任務描述**：
實作 NVD 收集器（Infrastructure Layer），包含：
- NVDCollector 類別
  - collect 方法
    - 呼叫 NVD API（https://services.nvd.nist.gov/rest/json/cves/2.0）
    - 處理 API 速率限制（每 6 秒 5 個請求）
    - 解析 JSON 回應
    - 提取 CVE 編號、CVSS 分數、產品資訊、描述等
    - 標準化為 Threat 領域模型
  - 增量收集機制
    - 記錄最後收集時間
    - 僅收集新資料
  - 錯誤處理與重試

**驗收條件**：
- 可成功從 NVD API 收集資料
- 正確處理 API 速率限制
- 正確解析 JSON 格式
- 正確提取 CVE、CVSS、產品資訊（AC-008-6）
- 標準化為統一資料模型（AC-008-5）
- 增量收集機制正常運作

**測試要求**：
- 單元測試通過（使用 Mock API）
- 速率限制處理測試通過
- 錯誤處理測試通過

**前置任務**：
- T-2-2-2：實作威脅收集服務

**相關文件**：
- plan.md 第 10.1.2 節「威脅情資收集引擎」
- spec.md US-008, AC-008-1
- NVD API 文件

---

#### T-2-2-5：實作 VMware VMSA 收集器

**對應使用者故事**：US-008  
**對應驗收條件**：AC-008-1, AC-008-5, AC-008-6, AC-008-7  
**對應 plan.md**：第 10.1.2 節「威脅情資收集引擎」  
**優先級**：P0  
**預估工時**：8 小時  
**狀態**：已完成

**任務描述**：
實作 VMware VMSA 收集器（Infrastructure Layer），包含：
- VMwareVMSACollector 類別
  - collect 方法
    - 解析 VMware VMSA RSS Feed（https://www.vmware.com/security/advisories.xml）
    - 或解析 HTML 頁面（https://www.vmware.com/security/advisories.html）
    - 提取公告標題、描述、CVE 編號、影響產品等
    - 使用 AI 服務處理非結構化內容（如需要，AC-008-7）
    - 標準化為 Threat 領域模型
  - 錯誤處理

**驗收條件**：
- 可成功從 VMware VMSA 收集資料
- 正確解析 RSS/HTML 格式
- 正確提取 CVE、產品資訊（AC-008-6）
- 使用 AI 處理非結構化內容（AC-008-7）
- 標準化為統一資料模型（AC-008-5）

**測試要求**：
- 單元測試通過（使用 Mock 資料）
- 錯誤處理測試通過

**前置任務**：
- T-2-2-2：實作威脅收集服務
- T-2-1-6：實作 AI 服務 API

**相關文件**：
- plan.md 第 10.1.2 節「威脅情資收集引擎」
- spec.md US-008, AC-008-1

---

#### T-2-2-6：實作 MSRC 收集器

**對應使用者故事**：US-008  
**對應驗收條件**：AC-008-1, AC-008-5, AC-008-6  
**對應 plan.md**：第 10.1.2 節「威脅情資收集引擎」  
**優先級**：P0  
**預估工時**：8 小時  
**狀態**：已完成

**任務描述**：
實作 MSRC 收集器（Infrastructure Layer），包含：
- MSRCCollector 類別
  - collect 方法
    - 呼叫 MSRC API（https://api.msrc.microsoft.com/）
    - 解析 JSON 回應
    - 提取 CVE 編號、CVSS 分數、影響產品、描述等
    - 標準化為 Threat 領域模型
  - 錯誤處理與重試

**驗收條件**：
- 可成功從 MSRC API 收集資料
- 正確解析 JSON 格式
- 正確提取 CVE、CVSS、產品資訊（AC-008-6）
- 標準化為統一資料模型（AC-008-5）

**測試要求**：
- 單元測試通過（使用 Mock API）
- 錯誤處理測試通過

**前置任務**：
- T-2-2-2：實作威脅收集服務

**相關文件**：
- plan.md 第 10.1.2 節「威脅情資收集引擎」
- spec.md US-008, AC-008-1
- MSRC API 文件

---

#### T-2-2-7：實作 TWCERT 收集器

**對應使用者故事**：US-008  
**對應驗收條件**：AC-008-1, AC-008-5, AC-008-6, AC-008-7  
**對應 plan.md**：第 10.1.2 節「威脅情資收集引擎」  
**優先級**：P0  
**預估工時**：12 小時  
**狀態**：已完成

**任務描述**：
實作 TWCERT 收集器（Infrastructure Layer），包含：
- TWCERTCollector 類別
  - collect 方法
    - 解析 TWCERT 網站或 RSS Feed
    - 提取通報標題、內容、發布時間等
    - 使用 AI 服務處理非結構化中文內容（AC-008-7）
      - 呼叫 AI 服務的 /api/v1/ai/extract 端點
      - 提取 CVE、產品、TTP、IOC 等資訊
    - 標準化為 Threat 領域模型
  - 中文內容處理
    - 處理正體中文文字
    - 處理中文產品名稱
  - 錯誤處理

**驗收條件**：
- 可成功從 TWCERT 收集資料
- 正確解析中文內容
- 使用 AI 服務處理非結構化資料（AC-008-7）
- 正確提取威脅資訊（CVE、產品、TTP、IOC，AC-008-6）
- 標準化為統一資料模型（AC-008-5）

**測試要求**：
- 單元測試通過（使用 Mock 資料）
- AI 整合測試通過
- 中文處理測試通過

**前置任務**：
- T-2-2-2：實作威脅收集服務
- T-2-1-6：實作 AI 服務 API

**相關文件**：
- plan.md 第 10.1.2 節「威脅情資收集引擎」
- spec.md US-008, AC-008-1, AC-008-7

---

#### T-2-2-8：實作收集排程與任務管理

**對應使用者故事**：US-008  
**對應驗收條件**：AC-008-1  
**對應 plan.md**：第 10.1.2 節「威脅情資收集引擎」  
**優先級**：P0  
**預估工時**：10 小時  
**狀態**：已完成

**任務描述**：
實作收集排程與任務管理，包含：
- ScheduleService 類別（Application Layer）
  - 使用 APScheduler 或類似工具
  - 根據威脅來源的收集頻率設定排程（每小時、每日、每週等）
  - 動態新增/移除排程任務
  - 排程任務執行
    - 呼叫 ThreatCollectionService.collect_from_feed
    - 記錄執行日誌
    - 處理執行錯誤
- 任務管理
  - 任務狀態追蹤（待執行、執行中、已完成、失敗）
  - 任務執行歷史記錄
  - 任務重試機制

**驗收條件**：
- 可根據設定的排程自動執行收集作業（AC-008-1）
- 支援多種收集頻率（每小時、每日、每週等）
- 排程任務可動態新增/移除
- 任務狀態追蹤正確
- 任務執行日誌記錄正確

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 整合測試通過（實際排程執行）
- 排程管理測試通過

**前置任務**：
- T-2-2-2：實作威脅收集服務
- T-1-2-1：實作資料庫 Schema（Schedules 表）

**相關文件**：
- plan.md 第 10.1.2 節「威脅情資收集引擎」
- plan.md 第 4.2 節「資料庫 Schema」（Schedules 表）
- spec.md US-008, AC-008-1

---

### 6.3 威脅資料儲存與查詢

**對應 plan.md**：第 10.1.2 節「威脅資料儲存與查詢」、第 6.2 節「自動化收集與關聯分析模組」

#### T-2-3-1：實作威脅 Repository

**對應使用者故事**：US-014  
**對應驗收條件**：AC-014-1, AC-014-2, AC-014-4, AC-014-5  
**對應 plan.md**：第 10.1.2 節「威脅資料儲存與查詢」、第 6.2.2 節「核心類別設計」  
**優先級**：P0  
**預估工時**：12 小時  
**狀態**：已完成

**任務描述**：
實作威脅 Repository（Infrastructure Layer），使用 SQLAlchemy，包含：
- ThreatRepository 類別
  - save（儲存威脅，AC-014-1）
    - 新增或更新威脅記錄
    - 儲存威脅的完整生命週期資訊（收集時間、分析時間等，AC-014-2）
  - get_by_id（依 ID 查詢）
  - get_by_cve（依 CVE 編號查詢）
  - get_all（查詢所有威脅，支援分頁、排序、篩選）
    - 依 CVE 篩選
    - 依產品名稱篩選
    - 依風險分數篩選
    - 依狀態篩選（AC-014-3）
  - search（搜尋威脅）
    - 全文搜尋（標題、描述）
    - 多條件組合搜尋
  - 建立索引（AC-014-5）
    - CVE 編號索引
    - 產品名稱索引
    - 風險分數索引
    - 收集時間索引
- ThreatAssetAssociationRepository
  - save_association（儲存威脅-資產關聯，AC-014-4）
  - get_by_threat_id（查詢威脅的所有關聯）
  - get_by_asset_id（查詢資產的所有關聯）

**驗收條件**：
- Repository 符合 plan.md 第 6.2.2 節的設計
- 可儲存威脅情資為結構化資料（AC-014-1）
- 可儲存威脅的完整生命週期（AC-014-2）
- 可建立威脅與資產的關聯表（多對多關係，AC-014-4）
- 已建立適當的索引（AC-014-5）
- 查詢效能符合要求（NFR-001）

**測試要求**：
- 整合測試通過（使用測試資料庫）
- 查詢效能測試通過（100,000 筆資料下回應時間 ≤ 2 秒）
- 索引使用測試通過

**前置任務**：
- T-1-2-1：實作資料庫 Schema（Threats、ThreatAssetAssociations 表）
- T-2-2-1：實作威脅領域模型

**相關文件**：
- plan.md 第 6.2.2 節「核心類別設計」
- plan.md 第 4.2 節「資料庫 Schema」（Threats、ThreatAssetAssociations 表）
- spec.md US-014, AC-014-1, AC-014-2, AC-014-4, AC-014-5

---

#### T-2-3-2：實作威脅 API 端點

**對應使用者故事**：US-014  
**對應驗收條件**：AC-014-1 至 AC-014-6  
**對應 plan.md**：第 10.1.2 節「威脅資料儲存與查詢」、第 5.2 節「API 端點定義」  
**優先級**：P0  
**預估工時**：10 小時  
**狀態**：已完成

**任務描述**：
使用 FastAPI 實作威脅 API 端點，包含：
- GET /api/v1/threats（查詢威脅清單）
  - 支援查詢參數：page, pageSize, sort, filter
  - 支援依 CVE、產品名稱、風險分數、狀態篩選
  - 回應包含分頁資訊
- GET /api/v1/threats/{id}（查詢威脅詳情）
  - 回應包含完整威脅資訊
  - 回應包含關聯的資產清單
- GET /api/v1/threats/search（搜尋威脅）
  - 全文搜尋功能
- PUT /api/v1/threats/{id}/status（更新威脅狀態，AC-014-3）
- 錯誤處理
- OpenAPI 文件更新

**驗收條件**：
- API 端點符合 plan.md 第 5.2 節的設計
- 所有驗收條件通過（AC-014-1 至 AC-014-6）
- 支援威脅狀態管理（AC-014-3）
- API 回應時間符合要求（≤ 2 秒，NFR-001）
- API 文件（OpenAPI）已更新

**測試要求**：
- API 整合測試通過
- 驗收條件測試通過
- 效能測試通過

**前置任務**：
- T-2-3-1：實作威脅 Repository

**相關文件**：
- plan.md 第 5.2 節「API 端點定義」
- spec.md US-014, AC-014-1 至 AC-014-6

---

#### T-2-3-3：實作前端威脅清單與詳細頁面

**對應使用者故事**：US-014  
**對應驗收條件**：AC-014-1, AC-014-3  
**對應 plan.md**：第 10.1.2 節「威脅資料儲存與查詢」、第 6.4 節「Web 管理界面模組」  
**優先級**：P0  
**預估工時**：16 小時  
**狀態**：已完成

**任務描述**：
使用 Next.js + React + TypeScript + Tailwind CSS 實作前端威脅管理介面，包含：
- 威脅清單頁面
  - 表格顯示威脅清單
  - 分頁控制
  - 排序功能（依 CVE、風險分數、收集時間等）
  - 篩選功能（依 CVE、產品名稱、風險分數、狀態等）
  - 搜尋功能
- 威脅詳細頁面
  - 顯示完整威脅資訊（CVE、標題、描述、CVSS 分數等）
  - 顯示關聯的資產清單
  - 顯示威脅狀態（AC-014-3）
  - 狀態更新功能（下拉選單或按鈕）
- UI/UX 設計
  - 使用統一的設計系統（Tailwind CSS，P8）
  - 響應式設計
  - 載入狀態顯示
  - 錯誤訊息顯示

**驗收條件**：
- 所有驗收條件通過（AC-014-1, AC-014-3）
- UI/UX 符合設計規範（P8）
- 頁面載入時間符合要求（≤ 2 秒，NFR-001）
- 狀態管理功能正常（AC-014-3）

**測試要求**：
- 端對端測試通過
- UI 測試通過

**前置任務**：
- T-2-3-2：實作威脅 API 端點

**相關文件**：
- plan.md 第 6.4 節「Web 管理界面模組」
- spec.md US-014, AC-014-1, AC-014-3

---

#### T-2-3-4：實作威脅搜尋與篩選功能

**對應使用者故事**：US-014  
**對應 plan.md**：第 10.1.2 節「威脅資料儲存與查詢」  
**優先級**：P1  
**預估工時**：8 小時  
**狀態**：待處理

**任務描述**：
實作威脅搜尋與篩選功能，包含：
- 前端搜尋介面
  - 搜尋輸入框
  - 即時搜尋（debounce）
  - 搜尋結果高亮顯示
- 前端篩選介面
  - 多條件篩選（CVE、產品名稱、風險分數、狀態等）
  - 篩選條件組合
  - 篩選結果統計
- 後端搜尋 API 優化
  - 全文搜尋索引
  - 搜尋效能優化

**驗收條件**：
- 搜尋功能正常運作
- 篩選功能正常運作
- 搜尋效能符合要求（≤ 2 秒）
- UI/UX 符合設計規範

**測試要求**：
- 搜尋功能測試通過
- 篩選功能測試通過
- 效能測試通過

**前置任務**：
- T-2-3-3：實作前端威脅清單與詳細頁面

**相關文件**：
- plan.md 第 10.1.2 節「威脅資料儲存與查詢」

---

### 6.4 整合測試與優化

**對應 plan.md**：第 10.1.2 節「整合測試與優化」

#### T-2-4-1：整合 AI 服務與主系統

**對應使用者故事**：US-008, US-009  
**對應 plan.md**：第 10.1.2 節「整合測試與優化」、第 7.3.5 節「主系統整合」  
**優先級**：P0  
**預估工時**：8 小時  
**狀態**：待處理

**任務描述**：
整合 AI 服務與主系統，包含：
- 在主系統中實作 ThreatExtractionService
  - 呼叫 AI 服務的 /api/v1/ai/extract 端點
  - 使用 httpx 進行 HTTP 請求
  - 錯誤處理與回退機制（規則基礎方法）
  - 超時控制（30 秒）
- 配置 AI 服務 URL（環境變數）
- 服務發現與健康檢查
  - 檢查 AI 服務可用性
  - AI 服務不可用時使用回退機制

**驗收條件**：
- AI 服務與主系統整合正常
- 可成功呼叫 AI 服務 API
- 錯誤處理正確（AI 服務失敗時回退）
- 超時控制正常
- 健康檢查正常

**測試要求**：
- 整合測試通過
- 錯誤處理測試通過（AI 服務失敗情況）
- 回退機制測試通過

**前置任務**：
- T-2-1-6：實作 AI 服務 API
- T-2-2-2：實作威脅收集服務

**相關文件**：
- plan.md 第 7.3.5 節「主系統整合」
- spec.md US-008, US-009

---

#### T-2-4-2：端對端測試威脅收集流程

**對應使用者故事**：US-008, US-009, US-014  
**對應 plan.md**：第 10.1.2 節「整合測試與優化」、第 8.3 節「端對端測試」  
**優先級**：P0  
**預估工時**：12 小時  
**狀態**：待處理

**任務描述**：
撰寫與執行端對端測試，驗證威脅收集完整流程，包含：
- 測試場景
  - 設定威脅來源（CISA KEV、NVD 等）
  - 觸發收集作業（手動或排程）
  - 驗證收集結果（威脅資料已儲存）
  - 驗證 AI 處理結果（非結構化內容已提取資訊）
  - 驗證威脅查詢功能
- 測試資料準備
  - Mock 外部 API（CISA KEV、NVD 等）
  - 測試用威脅來源設定
- 測試執行
  - 使用 pytest 執行端對端測試
  - 驗證所有驗收條件

**驗收條件**：
- 端對端測試通過
- 所有驗收條件通過（US-008, US-009, US-014）
- 威脅收集流程正常運作
- AI 處理流程正常運作

**測試要求**：
- 端對端測試通過（使用 Playwright 或類似工具）
- 所有測試場景通過

**前置任務**：
- T-2-4-1：整合 AI 服務與主系統
- T-2-3-3：實作前端威脅清單與詳細頁面

**相關文件**：
- plan.md 第 8.3 節「端對端測試」
- spec.md US-008, US-009, US-014

---

#### T-2-4-3：效能測試與優化

**對應使用者故事**：US-008, US-014  
**對應 plan.md**：第 10.1.2 節「整合測試與優化」、第 8.4 節「效能測試」  
**優先級**：P1  
**預估工時**：10 小時  
**狀態**：待處理

**任務描述**：
執行效能測試與優化，包含：
- 效能測試
  - 威脅收集效能測試（單一來源收集時間 ≤ 5 分鐘，AC-008-1）
  - 並行收集效能測試（至少 3 個來源同時處理，AC-008-2）
  - 威脅查詢效能測試（10,000 筆資料下回應時間 ≤ 2 秒，NFR-001）
  - AI 服務處理效能測試（單一請求 ≤ 5 秒）
- 效能優化
  - 資料庫查詢優化（索引調整）
  - API 回應時間優化
  - AI 服務處理時間優化
  - 快取機制實作（如需要）

**驗收條件**：
- 威脅收集效能符合要求（單一來源 ≤ 5 分鐘）
- 並行收集效能符合要求（至少 3 個來源）
- 威脅查詢效能符合要求（≤ 2 秒）
- AI 服務處理效能符合要求（≤ 5 秒）

**測試要求**：
- 效能測試通過
- 負載測試通過（如需要）

**前置任務**：
- T-2-4-2：端對端測試威脅收集流程

**相關文件**：
- plan.md 第 8.4 節「效能測試」
- spec.md US-008, AC-008-1, AC-008-2
- spec.md NFR-001

---

#### T-2-4-4：錯誤處理完善

**對應使用者故事**：US-008  
**對應驗收條件**：AC-008-3, AC-008-4  
**對應 plan.md**：第 10.1.2 節「整合測試與優化」  
**優先級**：P0  
**預估工時**：8 小時  
**狀態**：待處理

**任務描述**：
完善錯誤處理機制，包含：
- API 速率限制處理（AC-008-3）
  - 偵測速率限制回應（HTTP 429）
  - 實作指數退避重試
  - 記錄重試次數與時間
- 錯誤重試機制（AC-008-3）
  - 網路錯誤重試
  - 暫時性錯誤重試
  - 最大重試次數限制
- 錯誤日誌記錄（AC-008-4）
  - 記錄所有收集錯誤
  - 錯誤分類（網路錯誤、API 錯誤、資料格式錯誤等）
  - 錯誤詳情記錄
- 連續失敗告警（AC-008-4）
  - 追蹤連續失敗次數
  - 達到閾值時發送告警（Email 或系統通知）
  - 告警內容包含錯誤詳情

**驗收條件**：
- 處理來源 API 的速率限制與錯誤重試機制正常（AC-008-3）
- 收集失敗時記錄錯誤日誌，連續失敗時發送告警（AC-008-4）
- 錯誤處理涵蓋所有邊界情況
- 告警機制正常運作

**測試要求**：
- 錯誤處理測試通過（各種錯誤情況）
- 重試機制測試通過
- 告警機制測試通過

**前置任務**：
- T-2-2-2：實作威脅收集服務

**相關文件**：
- plan.md 第 10.1.2 節「整合測試與優化」
- spec.md US-008, AC-008-3, AC-008-4

---

## 7. 階段 3：關聯分析與風險計算

**目標**：實作威脅與資產關聯分析與風險分數計算  
**預估時程**：4-5 週  
**里程碑**：M3 - 關聯分析與風險計算完成

**對應 plan.md**：第 10.1.3 節「階段 3：關聯分析與風險計算」、第 6.2 節「自動化收集與關聯分析模組」  
**對應使用者故事**：US-010, US-011, US-012, US-013

### 7.1 關聯分析引擎

**對應 plan.md**：第 10.1.3 節「關聯分析引擎」、第 6.2.2 節「核心類別設計」

#### T-3-1-1：實作關聯分析服務

**對應使用者故事**：US-010  
**對應驗收條件**：AC-010-1 至 AC-010-5  
**對應 plan.md**：第 10.1.3 節「關聯分析引擎」、第 6.2.2 節「核心類別設計」（AssociationAnalysisService）  
**優先級**：P0  
**預估工時**：16 小時  
**狀態**：待處理

**任務描述**：
實作關聯分析服務（Domain Layer），包含：
- AssociationAnalysisService 類別
  - analyze 方法（分析威脅與資產的關聯）
    - 輸入：Threat 聚合根、Asset 清單
    - 對每個資產執行 _match_threat_to_asset
    - 返回關聯清單（threat_id、asset_id、confidence、match_type）
  - _match_threat_to_asset 方法（模糊比對威脅與資產）
    - 產品名稱比對（精確與模糊比對，AC-010-2）
      - 精確匹配（完全相同的產品名稱）
      - 模糊匹配（產品名稱變體，如 "SQL Server" vs "Microsoft SQL Server"）
    - 版本範圍比對（AC-010-2）
      - 精確版本匹配
      - 版本範圍匹配（如 "7.0.x" 匹配 "7.0.1", "7.0.2" 等）
      - 主版本匹配（如 "7" 匹配 "7.0", "7.1", "7.2" 等）
    - 作業系統比對
      - OS 名稱匹配
      - OS 版本匹配
    - 計算比對信心分數（confidence）
    - 返回比對結果（is_match、confidence、match_type）

**驗收條件**：
- 可正確比對威脅情資中的產品名稱與版本與資產清冊（AC-010-1）
- 支援模糊比對（產品名稱變體、版本號範圍比對，AC-010-2）
- 可識別所有受影響的資產，並建立威脅與資產的關聯記錄（AC-010-3）
- 比對完成後更新威脅記錄的關聯狀態（AC-010-4）
- 記錄關聯分析的執行日誌（威脅 ID、比對結果、受影響資產數，AC-010-5）
- 比對準確度 ≥ 90%

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 產品名稱比對測試通過（精確與模糊）
- 版本範圍比對測試通過
- 比對準確度測試通過（≥ 90%）

**前置任務**：
- T-1-3-1：實作資產領域模型
- T-2-2-1：實作威脅領域模型

**相關文件**：
- plan.md 第 6.2.2 節「核心類別設計」（AssociationAnalysisService）
- plan.md 第 6.2.3 節「業務邏輯流程」（關聯分析流程）
- spec.md US-010, AC-010-1 至 AC-010-5

---

#### T-3-1-2：實作產品名稱比對邏輯

**對應使用者故事**：US-010  
**對應驗收條件**：AC-010-1, AC-010-2  
**對應 plan.md**：第 10.1.3 節「關聯分析引擎」、第 6.2.2 節「核心類別設計」  
**優先級**：P0  
**預估工時**：12 小時  
**狀態**：待處理

**任務描述**：
實作產品名稱比對邏輯，包含：
- ProductNameMatcher 類別（Domain Service）
  - exact_match 方法（精確匹配）
    - 完全相同的產品名稱（大小寫不敏感）
    - 標準化處理（移除空格、特殊字元）
  - fuzzy_match 方法（模糊匹配）
    - 產品名稱變體處理
      - "SQL Server" vs "Microsoft SQL Server"
      - "Windows Server" vs "Windows Server 2016"
      - "VMware ESXi" vs "VMware ESXi 7.0"
    - 使用字串相似度演算法（如 Levenshtein 距離）
    - 設定相似度閾值（≥ 0.8 視為匹配）
  - normalize_product_name 方法（產品名稱標準化）
    - 移除版本號
    - 移除特殊字元
    - 統一大小寫
    - 處理常見變體（如 "MS SQL" → "Microsoft SQL Server"）

**驗收條件**：
- 精確匹配功能正常
- 模糊匹配功能正常（支援產品名稱變體，AC-010-2）
- 產品名稱標準化正確
- 比對準確度 ≥ 90%

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 測試各種產品名稱格式
- 測試模糊匹配準確度

**前置任務**：
- T-3-1-1：實作關聯分析服務

**相關文件**：
- plan.md 第 6.2.2 節「核心類別設計」
- spec.md US-010, AC-010-1, AC-010-2

---

#### T-3-1-3：實作版本範圍比對邏輯

**對應使用者故事**：US-010  
**對應驗收條件**：AC-010-1, AC-010-2  
**對應 plan.md**：第 10.1.3 節「關聯分析引擎」、第 6.2.2 節「核心類別設計」  
**優先級**：P0  
**預估工時**：10 小時  
**狀態**：待處理

**任務描述**：
實作版本範圍比對邏輯，包含：
- VersionMatcher 類別（Domain Service）
  - exact_match 方法（精確版本匹配）
    - 完全相同的版本號（如 "7.0.1" = "7.0.1"）
  - range_match 方法（版本範圍匹配）
    - 支援版本範圍格式（如 "7.0.x" 匹配 "7.0.1", "7.0.2" 等）
    - 支援主版本匹配（如 "7" 匹配 "7.0", "7.1", "7.2" 等）
    - 支援版本比較（如 ">= 7.0" 匹配 "7.0" 及以上版本）
  - parse_version 方法（版本號解析）
    - 解析各種版本格式（"7.0.1", "v7.0.1", "2017" 等）
    - 標準化為語義版本格式（Major.Minor.Patch）
  - compare_versions 方法（版本比較）
    - 比較兩個版本號的大小
    - 支援語義版本比較

**驗收條件**：
- 精確版本匹配功能正常
- 版本範圍匹配功能正常（支援版本號範圍比對，AC-010-2）
- 版本號解析正確（各種格式）
- 版本比較邏輯正確

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 測試各種版本格式
- 測試版本範圍匹配邏輯

**前置任務**：
- T-3-1-1：實作關聯分析服務

**相關文件**：
- plan.md 第 6.2.2 節「核心類別設計」
- spec.md US-010, AC-010-1, AC-010-2

---

#### T-3-1-4：實作威脅-資產關聯建立

**對應使用者故事**：US-010  
**對應驗收條件**：AC-010-3, AC-010-4  
**對應 plan.md**：第 10.1.3 節「關聯分析引擎」、第 6.2.2 節「核心類別設計」  
**優先級**：P0  
**預估工時**：10 小時  
**狀態**：待處理

**任務描述**：
實作威脅-資產關聯建立（Application Layer），包含：
- ThreatAssetAssociationService 類別
  - create_associations 方法（建立威脅-資產關聯）
    - 輸入：威脅 ID、關聯分析結果
    - 對每個匹配的資產建立關聯記錄
      - threat_id、asset_id
      - matched_product（匹配的產品名稱）
      - matched_version（匹配的版本）
      - confidence（比對信心分數）
      - match_type（匹配類型：exact、fuzzy、range）
    - 儲存關聯記錄（AC-010-3）
    - 更新威脅記錄的關聯狀態（AC-010-4）
    - 發布 ThreatAssetAssociated 事件
  - update_associations 方法（更新關聯）
    - 當資產變更時重新分析
    - 更新或刪除關聯記錄
- ThreatAssetAssociationRepository
  - save_association（儲存關聯記錄）
  - get_by_threat_id（查詢威脅的所有關聯）
  - get_by_asset_id（查詢資產的所有關聯）
  - delete_association（刪除關聯記錄）

**驗收條件**：
- 可識別所有受影響的資產，並建立威脅與資產的關聯記錄（AC-010-3）
- 比對完成後更新威脅記錄的關聯狀態（AC-010-4）
- 關聯記錄包含所有必要資訊（匹配產品、版本、信心分數等）
- 關聯記錄可正確查詢

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 整合測試通過
- 關聯建立與查詢測試通過

**前置任務**：
- T-3-1-1：實作關聯分析服務
- T-2-3-1：實作威脅 Repository（ThreatAssetAssociationRepository）

**相關文件**：
- plan.md 第 6.2.2 節「核心類別設計」
- plan.md 第 4.2 節「資料庫 Schema」（ThreatAssetAssociations 表）
- spec.md US-010, AC-010-3, AC-010-4

---

#### T-3-1-5：實作關聯分析 API

**對應使用者故事**：US-010, US-011  
**對應驗收條件**：AC-010-1 至 AC-010-5, AC-011-1, AC-011-2  
**對應 plan.md**：第 10.1.3 節「關聯分析引擎」、第 5.2 節「API 端點定義」  
**優先級**：P0  
**預估工時**：8 小時  
**狀態**：待處理

**任務描述**：
使用 FastAPI 實作關聯分析 API，包含：
- POST /api/v1/threats/{id}/analyze（執行關聯分析）
  - 觸發關聯分析作業
  - 返回分析結果（受影響資產數量）
- GET /api/v1/threats/{id}/associations（查詢威脅的關聯）
  - 返回威脅的所有關聯資產（AC-011-1）
  - 支援分頁、排序、篩選
- GET /api/v1/assets/{id}/threats（查詢資產的關聯）
  - 返回資產的所有關聯威脅（AC-011-2）
  - 支援分頁、排序、篩選
- GET /api/v1/threats/{id}/associations/analysis-log（查詢分析日誌）
  - 返回關聯分析的執行日誌（AC-010-5）
- 錯誤處理
- OpenAPI 文件更新

**驗收條件**：
- API 端點符合 plan.md 第 5.2 節的設計
- 所有驗收條件通過（AC-010-1 至 AC-010-5, AC-011-1, AC-011-2）
- API 回應時間符合要求（≤ 2 秒，NFR-001）
- API 文件（OpenAPI）已更新

**測試要求**：
- API 整合測試通過
- 驗收條件測試通過
- 效能測試通過

**前置任務**：
- T-3-1-4：實作威脅-資產關聯建立

**相關文件**：
- plan.md 第 5.2 節「API 端點定義」
- spec.md US-010, US-011

---

#### T-3-1-6：實作前端關聯分析視覺化

**對應使用者故事**：US-011  
**對應驗收條件**：AC-011-1 至 AC-011-4  
**對應 plan.md**：第 10.1.3 節「關聯分析引擎」、第 6.4 節「Web 管理界面模組」  
**優先級**：P0  
**預估工時**：16 小時  
**狀態**：待處理

**任務描述**：
使用 Next.js + React + TypeScript + Tailwind CSS 實作前端關聯分析視覺化，包含：
- 威脅詳細頁面 - 關聯資產區塊
  - 顯示所有受影響的資產（AC-011-1）
  - 顯示關聯資訊（匹配產品、版本、信心分數）
  - 支援篩選（依威脅嚴重程度、資產重要性等，AC-011-3）
  - 支援排序
- 資產詳細頁面 - 關聯威脅區塊
  - 顯示所有相關的威脅（AC-011-2）
  - 顯示威脅資訊（CVE、風險分數、狀態等）
  - 支援篩選（依威脅嚴重程度、資產重要性等，AC-011-3）
  - 支援排序
- 關聯分析視覺化（AC-011-4）
  - 使用圖表函式庫（如 D3.js、vis.js 或 React Flow）
  - 威脅-資產關係圖
    - 節點：威脅、資產
    - 邊：關聯關係
    - 節點大小：依風險分數或資產重要性
    - 節點顏色：依威脅嚴重程度或資產類型
  - 互動功能
    - 點擊節點顯示詳情
    - 縮放、平移
    - 篩選顯示
- UI/UX 設計
  - 使用統一的設計系統（Tailwind CSS，P8）
  - 響應式設計
  - 載入狀態顯示

**驗收條件**：
- 所有驗收條件通過（AC-011-1 至 AC-011-4）
- 關聯分析視覺化正常運作（AC-011-4）
- 篩選功能正常（AC-011-3）
- UI/UX 符合設計規範（P8）
- 頁面載入時間符合要求（≤ 2 秒，NFR-001）

**測試要求**：
- 端對端測試通過
- UI 測試通過
- 視覺化功能測試通過

**前置任務**：
- T-3-1-5：實作關聯分析 API

**相關文件**：
- plan.md 第 6.4 節「Web 管理界面模組」
- spec.md US-011, AC-011-1 至 AC-011-4

---

### 7.2 風險分數計算引擎

**對應 plan.md**：第 10.1.3 節「風險分數計算引擎」、第 6.2.2 節「核心類別設計」

#### T-3-2-1：實作風險計算服務

**對應使用者故事**：US-012  
**對應驗收條件**：AC-012-1 至 AC-012-5  
**對應 plan.md**：第 10.1.3 節「風險分數計算引擎」、第 6.2.2 節「核心類別設計」（RiskCalculationService）  
**優先級**：P0  
**預估工時**：16 小時  
**狀態**：待處理

**任務描述**：
實作風險計算服務（Domain Layer），包含：
- RiskCalculationService 類別
  - calculate_risk 方法（計算風險評估）
    - 輸入：Threat、關聯資訊、Asset、PIRs 清單
    - 計算基礎 CVSS 分數（AC-012-1）
      - 使用威脅的 cvss_score
    - 計算資產重要性加權（AC-012-2）
      - 資產重要性權重：高=1.5、中=1.0、低=0.5
      - 計算公式：asset_weight = data_sensitivity.weight * business_criticality.weight
    - 計算受影響資產數量加權（AC-012-2）
      - 每增加 10 個資產，風險分數增加 0.1
      - 計算公式：asset_count_weight = (affected_count / 10.0) * 0.1
    - 計算 PIR 符合度加權（AC-012-2）
      - 符合高優先級 PIR，風險分數增加 0.3
      - 檢查威脅是否符合啟用的 PIR 條件
    - 計算 CISA KEV 加權（AC-012-2）
      - 是否在 CISA KEV 清單中，是則風險分數增加 0.5
    - 計算最終風險分數（AC-012-3）
      - 公式：final_score = base_score * asset_weight + asset_count_weight + pir_weight + cisa_kev_weight
      - 限制在 0.0 - 10.0 範圍
    - 決定風險等級（AC-012-4）
      - 嚴重：≥ 8.0
      - 高：6.0 - 7.9
      - 中：4.0 - 5.9
      - 低：< 4.0
    - 記錄計算過程（AC-012-5）
      - 基礎分數、各加權因子、最終分數
    - 返回 RiskAssessment 聚合根
  - _check_pir_match 方法（檢查 PIR 符合度）
    - 檢查威脅是否符合 PIR 條件
    - 返回加權值（符合高優先級 PIR：0.3，否則：0.0）
  - _calculate_asset_count_weight 方法（計算資產數量加權）
    - 計算受影響資產數量的加權值

**驗收條件**：
- 可基於 CVSS 分數計算基礎風險分數（AC-012-1）
- 考慮所有加權因子（資產重要性、受影響數量、PIR 符合度、CISA KEV，AC-012-2）
- 計算最終風險分數（範圍：0.0 - 10.0，AC-012-3）
- 根據風險分數分類威脅（嚴重/高/中/低，AC-012-4）
- 記錄風險分數的計算過程（AC-012-5）
- 計算邏輯正確（符合 plan.md 設計）

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 所有計算邏輯測試通過
- 邊界情況測試通過（極值、空值等）
- 計算結果驗證測試通過

**前置任務**：
- T-2-2-1：實作威脅領域模型
- T-1-3-1：實作資產領域模型
- T-1-4-1：實作 PIR 領域模型與服務

**相關文件**：
- plan.md 第 6.2.2 節「核心類別設計」（RiskCalculationService）
- plan.md 第 4.2 節「資料庫 Schema」（RiskAssessments 表）
- spec.md US-012, AC-012-1 至 AC-012-5

---

#### T-3-2-2：實作 CVSS 基礎分數計算

**對應使用者故事**：US-012  
**對應驗收條件**：AC-012-1  
**對應 plan.md**：第 10.1.3 節「風險分數計算引擎」、第 6.2.2 節「核心類別設計」  
**優先級**：P0  
**預估工時**：6 小時  
**狀態**：待處理

**任務描述**：
實作 CVSS 基礎分數計算，包含：
- CVSSScoreCalculator 類別（Domain Service）
  - calculate_base_score 方法（計算基礎 CVSS 分數）
    - 輸入：CVSS 向量字串或 CVSS 分數
    - 如果威脅已有 cvss_score，直接使用
    - 如果只有 CVSS 向量，解析向量並計算分數
    - 返回 CVSS 基礎分數（0.0 - 10.0）
  - parse_cvss_vector 方法（解析 CVSS 向量）
    - 解析 CVSS v3.1 向量格式
    - 提取各項指標值
  - 使用 CVSS 計算函式庫（如需要）
    - 或實作簡化的 CVSS 計算邏輯

**驗收條件**：
- 可正確計算 CVSS 基礎分數（AC-012-1）
- 支援 CVSS v3.1 格式
- 計算結果準確（與官方 CVSS 計算器一致）

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 測試各種 CVSS 分數與向量
- 驗證計算結果準確性

**前置任務**：
- T-3-2-1：實作風險計算服務

**相關文件**：
- plan.md 第 6.2.2 節「核心類別設計」
- spec.md US-012, AC-012-1
- CVSS v3.1 標準文件

---

#### T-3-2-3：實作加權因子計算

**對應使用者故事**：US-012  
**對應驗收條件**：AC-012-2  
**對應 plan.md**：第 10.1.3 節「風險分數計算引擎」、第 6.2.2 節「核心類別設計」  
**優先級**：P0  
**預估工時**：12 小時  
**狀態**：待處理

**任務描述**：
實作加權因子計算，包含：
- WeightFactorCalculator 類別（Domain Service）
  - calculate_asset_importance_weight 方法（計算資產重要性加權）
    - 輸入：Asset（包含 data_sensitivity、business_criticality）
    - 計算公式：weight = data_sensitivity.weight * business_criticality.weight
    - 權重值：高=1.5、中=1.0、低=0.5
    - 返回加權值
  - calculate_asset_count_weight 方法（計算受影響資產數量加權）
    - 輸入：受影響資產數量
    - 計算公式：weight = (affected_count / 10.0) * 0.1
    - 每增加 10 個資產，風險分數增加 0.1
    - 返回加權值
  - calculate_pir_match_weight 方法（計算 PIR 符合度加權）
    - 輸入：Threat、啟用的 PIRs 清單
    - 檢查威脅是否符合 PIR 條件
      - 產品名稱匹配
      - CVE 編號匹配
      - 威脅類型匹配
    - 符合高優先級 PIR，返回 0.3
    - 否則返回 0.0
  - calculate_cisa_kev_weight 方法（計算 CISA KEV 加權）
    - 輸入：Threat（檢查是否在 CISA KEV 清單中）
    - 如果在 CISA KEV 清單中，返回 0.5
    - 否則返回 0.0

**驗收條件**：
- 資產重要性加權計算正確（高/中/低，權重：1.5/1.0/0.5，AC-012-2）
- 受影響資產數量加權計算正確（每增加 10 個資產，風險分數增加 0.1，AC-012-2）
- PIR 符合度加權計算正確（符合高優先級 PIR，風險分數增加 0.3，AC-012-2）
- CISA KEV 加權計算正確（是，風險分數增加 0.5，AC-012-2）
- 所有加權因子計算邏輯正確

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 所有加權因子計算測試通過
- 邊界情況測試通過

**前置任務**：
- T-3-2-1：實作風險計算服務

**相關文件**：
- plan.md 第 6.2.2 節「核心類別設計」
- spec.md US-012, AC-012-2

---

#### T-3-2-4：實作風險分數分類

**對應使用者故事**：US-012  
**對應驗收條件**：AC-012-4  
**對應 plan.md**：第 10.1.3 節「風險分數計算引擎」、第 6.2.2 節「核心類別設計」  
**優先級**：P0  
**預估工時**：4 小時  
**狀態**：待處理

**任務描述**：
實作風險分數分類，包含：
- RiskLevelClassifier 類別（Domain Service）
  - classify 方法（分類風險等級）
    - 輸入：風險分數（0.0 - 10.0）
    - 分類規則（AC-012-4）：
      - 嚴重（Critical）：≥ 8.0
      - 高（High）：6.0 - 7.9
      - 中（Medium）：4.0 - 5.9
      - 低（Low）：< 4.0
    - 返回風險等級字串
- RiskAssessment 聚合根中的 _determine_risk_level 方法
  - 實作風險等級決定邏輯
  - 與 RiskLevelClassifier 保持一致

**驗收條件**：
- 可根據風險分數將威脅分類為：嚴重（≥8.0）、高（6.0-7.9）、中（4.0-5.9）、低（<4.0）（AC-012-4）
- 分類邏輯正確（邊界值處理正確）

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 所有風險等級分類測試通過
- 邊界值測試通過（8.0、6.0、4.0）

**前置任務**：
- T-3-2-1：實作風險計算服務

**相關文件**：
- plan.md 第 6.2.2 節「核心類別設計」（RiskAssessment 聚合根）
- spec.md US-012, AC-012-4

---

#### T-3-2-5：實作風險計算歷史記錄

**對應使用者故事**：US-012, US-013  
**對應驗收條件**：AC-012-5, AC-013-3  
**對應 plan.md**：第 10.1.3 節「風險分數計算引擎」、第 4.2 節「資料庫 Schema」  
**優先級**：P0  
**預估工時**：8 小時  
**狀態**：待處理

**任務描述**：
實作風險計算歷史記錄，包含：
- RiskAssessmentHistory 實體
  - id、risk_assessment_id
  - base_score（基礎 CVSS 分數）
  - asset_importance_weight（資產重要性加權）
  - asset_count_weight（受影響資產數量加權）
  - pir_match_weight（PIR 符合度加權）
  - cisa_kev_weight（CISA KEV 加權）
  - final_score（最終風險分數）
  - risk_level（風險等級）
  - calculated_at（計算時間）
- RiskAssessmentHistoryRepository
  - save_history（儲存歷史記錄）
  - get_by_risk_assessment_id（查詢風險評估的歷史記錄）
  - get_latest（查詢最新的風險評估記錄）
- RiskAssessmentService
  - 每次計算風險分數時，儲存歷史記錄（AC-012-5）
  - 當資產變更導致風險分數更新時，建立新的歷史記錄（AC-013-3）

**驗收條件**：
- 可記錄風險分數的計算過程（基礎分數、各加權因子、最終分數，AC-012-5）
- 可提供風險分數的歷史記錄（如風險分數因資產變更而更新，AC-013-3）
- 歷史記錄包含所有必要資訊
- 歷史記錄可正確查詢

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 整合測試通過
- 歷史記錄儲存與查詢測試通過

**前置任務**：
- T-1-2-1：實作資料庫 Schema（RiskAssessments 表，需包含歷史記錄欄位）
- T-3-2-1：實作風險計算服務

**相關文件**：
- plan.md 第 4.2 節「資料庫 Schema」（RiskAssessments 表）
- spec.md US-012, US-013, AC-012-5, AC-013-3

---

#### T-3-2-6：實作風險計算 API

**對應使用者故事**：US-012, US-013  
**對應驗收條件**：AC-012-1 至 AC-012-5, AC-013-1, AC-013-2  
**對應 plan.md**：第 10.1.3 節「風險分數計算引擎」、第 5.2 節「API 端點定義」  
**優先級**：P0  
**預估工時**：10 小時  
**狀態**：待處理

**任務描述**：
使用 FastAPI 實作風險計算 API，包含：
- POST /api/v1/threats/{id}/calculate-risk（計算風險分數）
  - 觸發風險計算作業
  - 返回計算結果（風險分數、風險等級）
- GET /api/v1/threats/{id}/risk-assessment（查詢風險評估）
  - 返回風險評估詳情
  - 包含風險分數計算詳情（AC-013-1, AC-013-2）
    - 基礎 CVSS 分數
    - 各加權因子的貢獻
    - 最終風險分數
    - 風險等級
- GET /api/v1/threats/{id}/risk-assessment/history（查詢風險評估歷史）
  - 返回風險分數的歷史記錄（AC-013-3）
  - 支援時間範圍篩選
- 錯誤處理
- OpenAPI 文件更新

**驗收條件**：
- API 端點符合 plan.md 第 5.2 節的設計
- 所有驗收條件通過（AC-012-1 至 AC-012-5, AC-013-1 至 AC-013-3）
- 風險分數計算詳情顯示正確（AC-013-1, AC-013-2）
- API 回應時間符合要求（≤ 2 秒，NFR-001）
- API 文件（OpenAPI）已更新

**測試要求**：
- API 整合測試通過
- 驗收條件測試通過
- 效能測試通過

**前置任務**：
- T-3-2-1：實作風險計算服務
- T-3-2-5：實作風險計算歷史記錄

**相關文件**：
- plan.md 第 5.2 節「API 端點定義」
- spec.md US-012, US-013

---

### 7.3 風險評估介面

**對應 plan.md**：第 10.1.3 節「風險評估介面」、第 6.4 節「Web 管理界面模組」

#### T-3-3-1：實作前端風險評估顯示

**對應使用者故事**：US-012, US-013  
**對應驗收條件**：AC-012-4, AC-013-1, AC-013-2  
**對應 plan.md**：第 10.1.3 節「風險評估介面」、第 6.4 節「Web 管理界面模組」  
**優先級**：P0  
**預估工時**：12 小時  
**狀態**：待處理

**任務描述**：
使用 Next.js + React + TypeScript + Tailwind CSS 實作前端風險評估顯示，包含：
- 威脅詳細頁面 - 風險評估區塊
  - 顯示風險分數（大字體、顏色編碼）
  - 顯示風險等級（嚴重/高/中/低，AC-012-4）
  - 顯示風險分數計算詳情（AC-013-1, AC-013-2）
    - 基礎 CVSS 分數
    - 各加權因子的貢獻（資產重要性、受影響數量、PIR 符合度、CISA KEV）
    - 最終風險分數
    - 計算公式說明
  - 視覺化呈現（進度條、圓形圖表等）
- UI/UX 設計
  - 使用統一的設計系統（Tailwind CSS，P8）
  - 顏色編碼（嚴重：紅色、高：橙色、中：黃色、低：綠色）
  - 響應式設計

**驗收條件**：
- 所有驗收條件通過（AC-012-4, AC-013-1, AC-013-2）
- 風險分數計算詳情顯示正確（AC-013-1, AC-013-2）
- UI/UX 符合設計規範（P8）
- 頁面載入時間符合要求（≤ 2 秒，NFR-001）

**測試要求**：
- 端對端測試通過
- UI 測試通過

**前置任務**：
- T-3-2-6：實作風險計算 API

**相關文件**：
- plan.md 第 6.4 節「Web 管理界面模組」
- spec.md US-012, US-013

---

#### T-3-3-2：實作風險分數計算詳情頁面

**對應使用者故事**：US-013  
**對應驗收條件**：AC-013-1, AC-013-2, AC-013-3  
**對應 plan.md**：第 10.1.3 節「風險評估介面」、第 6.4 節「Web 管理界面模組」  
**優先級**：P0  
**預估工時**：10 小時  
**狀態**：待處理

**任務描述**：
實作風險分數計算詳情頁面，包含：
- 風險計算詳情頁面
  - 顯示基礎 CVSS 分數與各加權因子的貢獻（AC-013-2）
    - 基礎分數：X.X
    - 資產重要性加權：+X.X（說明：資產重要性高/中/低）
    - 受影響資產數量加權：+X.X（說明：N 個受影響資產）
    - PIR 符合度加權：+X.X（說明：符合 PIR-XX）
    - CISA KEV 加權：+X.X（說明：在 CISA KEV 清單中）
    - 最終風險分數：X.X
  - 視覺化呈現（堆疊圖、圓形圖等）
  - 計算公式說明
- 風險分數歷史記錄區塊（AC-013-3）
  - 顯示風險分數的歷史記錄
  - 時間軸視覺化
  - 顯示每次變更的原因（如：資產變更、PIR 更新等）
- UI/UX 設計
  - 使用統一的設計系統（Tailwind CSS，P8）
  - 清晰的資訊架構
  - 響應式設計

**驗收條件**：
- 所有驗收條件通過（AC-013-1, AC-013-2, AC-013-3）
- 風險分數計算詳情顯示正確（AC-013-1, AC-013-2）
- 風險分數歷史記錄顯示正確（AC-013-3）
- UI/UX 符合設計規範（P8）

**測試要求**：
- 端對端測試通過
- UI 測試通過

**前置任務**：
- T-3-3-1：實作前端風險評估顯示

**相關文件**：
- plan.md 第 6.4 節「Web 管理界面模組」
- spec.md US-013, AC-013-1 至 AC-013-3

---

#### T-3-3-3：實作風險趨勢分析

**對應使用者故事**：US-013  
**對應 plan.md**：第 10.1.3 節「風險評估介面」  
**優先級**：P1  
**預估工時**：8 小時  
**狀態**：待處理

**任務描述**：
實作風險趨勢分析，包含：
- 風險趨勢圖表
  - 時間序列圖（風險分數隨時間變化）
  - 風險等級分布圖（嚴重/高/中/低數量）
  - 加權因子貢獻圖（各加權因子的平均貢獻）
- 統計資訊
  - 平均風險分數
  - 最高風險分數
  - 風險分數變化趨勢（上升/下降/持平）
- 使用圖表函式庫（如 Chart.js、Recharts）

**驗收條件**：
- 風險趨勢圖表正常顯示
- 統計資訊正確
- UI/UX 符合設計規範

**測試要求**：
- UI 測試通過
- 圖表功能測試通過

**前置任務**：
- T-3-3-2：實作風險分數計算詳情頁面

**相關文件**：
- plan.md 第 10.1.3 節「風險評估介面」

---

### 7.4 測試與優化

**對應 plan.md**：第 10.1.3 節「測試與優化」

#### T-3-4-1：關聯分析準確度測試

**對應使用者故事**：US-010  
**對應 plan.md**：第 10.1.3 節「測試與優化」  
**優先級**：P0  
**預估工時**：8 小時  
**狀態**：待處理

**任務描述**：
執行關聯分析準確度測試，包含：
- 建立測試資料集
  - 各種產品名稱格式的威脅與資產
  - 各種版本格式的威脅與資產
  - 邊界情況（模糊匹配、版本範圍等）
- 準確度測試
  - 產品名稱比對準確度（目標 ≥ 90%）
  - 版本範圍比對準確度（目標 ≥ 90%）
  - 整體關聯分析準確度（目標 ≥ 90%）
- 優化調整
  - 調整模糊匹配演算法
  - 調整版本範圍匹配邏輯
  - 調整信心分數計算

**驗收條件**：
- 關聯分析準確度 ≥ 90%
- 所有測試案例通過
- 優化後準確度提升

**測試要求**：
- 準確度測試通過
- 測試報告完整

**前置任務**：
- T-3-1-1：實作關聯分析服務
- T-3-1-2：實作產品名稱比對邏輯
- T-3-1-3：實作版本範圍比對邏輯

**相關文件**：
- plan.md 第 10.1.3 節「測試與優化」
- spec.md US-010

---

#### T-3-4-2：風險計算邏輯驗證

**對應使用者故事**：US-012  
**對應 plan.md**：第 10.1.3 節「測試與優化」  
**優先級**：P0  
**預估工時**：6 小時  
**狀態**：待處理

**任務描述**：
驗證風險計算邏輯，包含：
- 建立測試案例
  - 各種 CVSS 分數組合
  - 各種資產重要性組合
  - 各種受影響資產數量
  - 各種 PIR 符合情況
  - 各種 CISA KEV 情況
- 邏輯驗證
  - 驗證計算公式正確
  - 驗證加權因子計算正確
  - 驗證風險等級分類正確
  - 驗證邊界值處理正確
- 結果驗證
  - 與預期結果比對
  - 與 plan.md 設計比對

**驗收條件**：
- 風險計算邏輯正確（符合 plan.md 設計）
- 所有測試案例通過
- 計算結果符合預期

**測試要求**：
- 邏輯驗證測試通過
- 測試報告完整

**前置任務**：
- T-3-2-1：實作風險計算服務
- T-3-2-2：實作 CVSS 基礎分數計算
- T-3-2-3：實作加權因子計算

**相關文件**：
- plan.md 第 10.1.3 節「測試與優化」
- plan.md 第 6.2.2 節「核心類別設計」（風險計算邏輯）
- spec.md US-012

---

#### T-3-4-3：效能測試

**對應使用者故事**：US-010, US-012  
**對應 plan.md**：第 10.1.3 節「測試與優化」、第 8.4 節「效能測試」  
**優先級**：P1  
**預估工時**：6 小時  
**狀態**：待處理

**任務描述**：
執行效能測試，包含：
- 關聯分析效能測試
  - 測試資料量：10,000 筆資產
  - 目標：關聯分析在 1 分鐘內完成（NFR-001）
- 風險計算效能測試
  - 測試資料量：1,000 筆威脅
  - 目標：風險計算在 3 分鐘內完成（NFR-001）
- 查詢效能測試
  - 測試資料量：100,000 筆威脅記錄
  - 目標：API 回應時間 ≤ 2 秒（NFR-001）
- 效能優化
  - 資料庫查詢優化
  - 演算法優化
  - 快取機制（如需要）

**驗收條件**：
- 關聯分析效能符合要求（≤ 1 分鐘）
- 風險計算效能符合要求（≤ 3 分鐘）
- 查詢效能符合要求（≤ 2 秒）
- 效能優化有效

**測試要求**：
- 效能測試通過
- 效能測試報告完整

**前置任務**：
- T-3-4-1：關聯分析準確度測試
- T-3-4-2：風險計算邏輯驗證

**相關文件**：
- plan.md 第 8.4 節「效能測試」
- spec.md NFR-001

---

## 8. 階段 4：報告生成與通知

**目標**：實作報告生成與通知機制  
**預估時程**：4-5 週  
**里程碑**：M4 - 報告生成與通知完成

**對應 plan.md**：第 10.1.4 節「階段 4：報告生成與通知」、第 6.3 節「報告生成與即時通知模組」  
**對應使用者故事**：US-015, US-016, US-017, US-018, US-019, US-020, US-021

### 8.1 報告生成服務

**對應 plan.md**：第 10.1.4 節「報告生成服務」、第 6.3.2 節「核心類別設計」

#### T-4-1-1：實作報告領域模型

**對應使用者故事**：US-015, US-017  
**對應驗收條件**：AC-015-1, AC-015-5, AC-015-6, AC-017-5  
**對應 plan.md**：第 10.1.4 節「報告生成服務」、第 6.3.2 節「核心類別設計」（Report 聚合根）  
**優先級**：P0  
**預估工時**：8 小時  
**狀態**：待處理

**任務描述**：
實作報告領域模型（Domain Layer），包含：
- Report 聚合根
  - id、report_type（CISO_Weekly、IT_Ticket）
  - title、file_path、file_format（HTML、PDF、TEXT、JSON）
  - generated_at（生成時間）
  - summary（AI 生成的摘要）
  - 業務規則方法
    - set_summary（設定摘要）
  - 領域事件（ReportGeneratedEvent）
- 報告類型枚舉
  - CISO_Weekly（CISO 週報）
  - IT_Ticket（IT 工單）

**驗收條件**：
- 領域模型符合 plan.md 第 6.3.2 節的設計
- 支援所有報告類型（CISO_Weekly、IT_Ticket）
- 支援所有檔案格式（HTML、PDF、TEXT、JSON）
- 領域事件可正常發布
- 符合 DDD 原則

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 所有業務規則通過測試
- 領域事件發布測試通過

**前置任務**：
- T-1-2-1：實作資料庫 Schema（Reports 表）

**相關文件**：
- plan.md 第 6.3.2 節「核心類別設計」（Report 聚合根）
- plan.md 第 4.2 節「資料庫 Schema」（Reports 表）
- spec.md US-015, US-017

---

#### T-4-1-2：實作 CISO 週報生成服務

**對應使用者故事**：US-015  
**對應驗收條件**：AC-015-1 至 AC-015-6  
**對應 plan.md**：第 10.1.4 節「報告生成服務」、第 6.3.2 節「核心類別設計」（ReportGenerationService）  
**優先級**：P0  
**預估工時**：20 小時  
**狀態**：待處理

**任務描述**：
實作 CISO 週報生成服務（Domain Layer），包含：
- ReportGenerationService 類別
  - generate_ciso_weekly_report 方法（生成 CISO 週報）
    - 輸入：period_start、period_end
    - 收集本週威脅情資與風險評估（AC-015-2）
      - 威脅數量統計
      - 嚴重威脅數量（風險分數 ≥ 8.0）
      - 嚴重威脅清單（AC-015-2）
      - 受影響資產統計（依資產類型、重要性分類，AC-015-2）
      - 風險趨勢分析（與上週比較，AC-015-2）
    - 生成報告內容
      - 使用報告模板生成 HTML/PDF（AC-015-3）
    - AI 生成業務風險描述（AC-015-4）
      - 呼叫 AISummaryService.generate_business_risk_description
      - 以非技術語言說明威脅對業務的影響
    - 生成報告檔案（AC-015-5, AC-015-6）
      - 儲存在 `reports/yyyy/yyyymm/` 目錄結構中
      - 檔案命名格式：`CISO_Weekly_Report_yyyy-mm-dd.html` 或 `.pdf`
    - 建立 Report 聚合根
    - 返回 Report
  - _get_threats_in_period 方法（取得期間內的威脅）
  - _get_risk_assessments_in_period 方法（取得期間內的風險評估）
  - _generate_report_content 方法（生成報告內容）
  - _generate_report_file 方法（生成報告檔案）

**驗收條件**：
- 可自動生成每週的 CISO 週報（AC-015-1）
- 週報包含所有必要內容（AC-015-2）
- 支援 HTML 與 PDF 兩種格式（AC-015-3）
- 使用 AI 技術生成易於理解的摘要（AC-015-4）
- 週報檔案儲存在正確的目錄結構中（AC-015-5）
- 週報檔案命名格式正確（AC-015-6）

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 整合測試通過
- 報告內容完整性測試通過
- 檔案生成測試通過

**前置任務**：
- T-4-1-1：實作報告領域模型
- T-2-1-6：實作 AI 服務 API（AI 摘要功能）

**相關文件**：
- plan.md 第 6.3.2 節「核心類別設計」（ReportGenerationService）
- plan.md 第 6.3.3 節「業務邏輯流程」（CISO 週報生成流程）
- spec.md US-015, AC-015-1 至 AC-015-6

---

#### T-4-1-3：實作報告模板（HTML、PDF）

**對應使用者故事**：US-015  
**對應驗收條件**：AC-015-2, AC-015-3  
**對應 plan.md**：第 10.1.4 節「報告生成服務」、第 6.3.2 節「核心類別設計」  
**優先級**：P0  
**預估工時**：16 小時  
**狀態**：待處理

**任務描述**：
實作報告模板，包含：
- HTML 模板
  - CISO 週報 HTML 模板
    - 報告標題與日期
    - 本週威脅情資摘要區塊
      - 威脅數量、嚴重威脅數量
    - 嚴重威脅清單區塊（表格）
      - CVE 編號、標題、風險分數、受影響資產數量
    - 受影響資產統計區塊
      - 依資產類型分類統計
      - 依資產重要性分類統計
    - 風險趨勢分析區塊
      - 與上週比較（威脅數量變化、風險分數變化）
      - 趨勢圖表（如需要）
    - AI 生成的業務風險描述區塊
    - 使用 Tailwind CSS 或類似框架進行樣式設計
- PDF 模板
  - 使用報告生成函式庫（如 WeasyPrint、ReportLab）
  - 將 HTML 模板轉換為 PDF
  - 或直接使用 PDF 生成函式庫
- 模板引擎
  - 使用 Jinja2 或類似模板引擎
  - 支援變數替換
  - 支援條件判斷與迴圈

**驗收條件**：
- HTML 模板包含所有必要內容（AC-015-2）
- PDF 模板包含所有必要內容（AC-015-2）
- 支援 HTML 與 PDF 兩種格式（AC-015-3）
- 模板樣式美觀、易讀
- 模板可正確渲染資料

**測試要求**：
- 模板渲染測試通過
- HTML/PDF 生成測試通過
- 內容完整性測試通過

**前置任務**：
- T-4-1-2：實作 CISO 週報生成服務

**相關文件**：
- plan.md 第 10.1.4 節「報告生成服務」
- spec.md US-015, AC-015-2, AC-015-3

---

#### T-4-1-4：實作 AI 摘要生成（整合 AI 服務）

**對應使用者故事**：US-015  
**對應驗收條件**：AC-015-4  
**對應 plan.md**：第 10.1.4 節「報告生成服務」、第 6.3.4 節「AI 摘要生成」  
**優先級**：P0  
**預估工時**：8 小時  
**狀態**：待處理

**任務描述**：
實作 AI 摘要生成服務（Application Layer），包含：
- AISummaryService 類別
  - generate_summary 方法（生成摘要）
    - 呼叫 AI 服務的 /api/v1/ai/summarize 端點
    - 輸入：content（報告內容）、target_length（目標長度）、language（語言）、style（風格：executive）
    - 返回：摘要文字
  - generate_business_risk_description 方法（生成業務風險描述）
    - 呼叫 AI 服務的 /api/v1/ai/translate-to-business 端點
    - 輸入：technical_description（技術描述）
    - 返回：業務風險描述（非技術語言）
  - 錯誤處理與回退機制
    - AI 服務失敗時使用規則基礎方法生成摘要
  - 超時控制（30 秒）
- 整合至 ReportGenerationService
  - 在生成 CISO 週報時呼叫 AI 摘要服務

**驗收條件**：
- 可成功呼叫 AI 服務生成摘要（AC-015-4）
- 生成的摘要易於理解（針對非技術背景的管理層，AC-015-4）
- 錯誤處理正確（AI 服務失敗時回退）
- 超時控制正常

**測試要求**：
- 整合測試通過
- AI 服務整合測試通過
- 錯誤處理測試通過
- 回退機制測試通過

**前置任務**：
- T-2-1-6：實作 AI 服務 API（AI 摘要功能）
- T-4-1-2：實作 CISO 週報生成服務

**相關文件**：
- plan.md 第 6.3.4 節「AI 摘要生成」
- spec.md US-015, AC-015-4

---

#### T-4-1-5：實作報告排程管理

**對應使用者故事**：US-016  
**對應驗收條件**：AC-016-1 至 AC-016-4  
**對應 plan.md**：第 10.1.4 節「報告生成服務」、第 6.3.3 節「業務邏輯流程」  
**優先級**：P0  
**預估工時**：10 小時  
**狀態**：待處理

**任務描述**：
實作報告排程管理，包含：
- ReportScheduleService 類別（Application Layer）
  - 使用 APScheduler 或類似工具
  - 設定 CISO 週報排程（AC-016-1）
    - 預設：每週一上午 9:00
    - 可自訂生成時間
  - 排程任務執行
    - 呼叫 ReportService.generate_report（report_type="CISO_Weekly"）
    - 記錄執行日誌（AC-016-4）
  - 動態新增/移除排程任務
- 報告設定管理
  - 儲存報告排程設定（生成時間、收件人等）
  - 更新報告排程設定
- 排程任務狀態追蹤
  - 任務執行歷史記錄
  - 任務執行狀態（成功/失敗）

**驗收條件**：
- 可設定週報的生成時間（例如：每週一上午 9:00，AC-016-1）
- 排程任務可正常執行
- 記錄週報生成與發送的日誌（AC-016-4）
- 排程任務可動態新增/移除

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 整合測試通過（實際排程執行）
- 排程管理測試通過

**前置任務**：
- T-4-1-2：實作 CISO 週報生成服務
- T-1-2-1：實作資料庫 Schema（Schedules 表）

**相關文件**：
- plan.md 第 6.3.3 節「業務邏輯流程」（CISO 週報生成流程）
- plan.md 第 4.2 節「資料庫 Schema」（Schedules 表）
- spec.md US-016, AC-016-1, AC-016-4

---

#### T-4-1-6：實作報告儲存與查詢

**對應使用者故事**：US-015  
**對應驗收條件**：AC-015-5, AC-015-6  
**對應 plan.md**：第 10.1.4 節「報告生成服務」、第 6.3.2 節「核心類別設計」  
**優先級**：P0  
**預估工時**：10 小時  
**狀態**：待處理

**任務描述**：
實作報告儲存與查詢，包含：
- ReportRepository（Infrastructure Layer）
  - save（儲存報告記錄）
    - 儲存報告元資料（id、type、title、file_path、file_format、generated_at）
    - 儲存報告檔案（實體檔案）
  - get_by_id（依 ID 查詢）
  - get_all（查詢所有報告，支援分頁、排序、篩選）
    - 依報告類型篩選
    - 依生成時間篩選
  - get_file_path（取得報告檔案路徑）
- 檔案儲存管理
  - 建立目錄結構（reports/yyyy/yyyymm/，AC-015-5）
  - 儲存報告檔案（HTML、PDF）
  - 檔案命名（CISO_Weekly_Report_yyyy-mm-dd.html 或 .pdf，AC-015-6）
  - 檔案清理（依資料保留政策）

**驗收條件**：
- 週報檔案儲存在 `reports/yyyy/yyyymm/` 目錄結構中（AC-015-5）
- 週報檔案命名格式正確（CISO_Weekly_Report_yyyy-mm-dd.html 或 .pdf，AC-015-6）
- 報告記錄可正確查詢
- 報告檔案可正確存取

**測試要求**：
- 整合測試通過（使用測試資料庫）
- 檔案儲存測試通過
- 查詢功能測試通過

**前置任務**：
- T-4-1-1：實作報告領域模型
- T-1-2-1：實作資料庫 Schema（Reports 表）

**相關文件**：
- plan.md 第 6.3.2 節「核心類別設計」
- plan.md 第 4.2 節「資料庫 Schema」（Reports 表）
- spec.md US-015, AC-015-5, AC-015-6

---

### 8.2 IT 工單生成

**對應 plan.md**：第 10.1.4 節「IT 工單生成」、第 6.3.2 節「核心類別設計」

#### T-4-2-1：實作工單生成服務

**對應使用者故事**：US-017  
**對應驗收條件**：AC-017-1 至 AC-017-5  
**對應 plan.md**：第 10.1.4 節「IT 工單生成」、第 6.3.2 節「核心類別設計」（ReportGenerationService）  
**優先級**：P0  
**預估工時**：16 小時  
**狀態**：待處理

**任務描述**：
實作工單生成服務（Domain Layer），包含：
- ReportGenerationService 類別（擴充）
  - generate_it_ticket 方法（生成 IT 工單）
    - 輸入：RiskAssessment
    - 檢查風險分數是否 ≥ 6.0（AC-017-1）
    - 收集技術資訊（AC-017-2）
      - CVE 編號與詳細描述
      - 受影響的資產清單（產品名稱、版本、IP 位址、負責人）
      - CVSS 分數與風險分數
      - 修補建議（修補程式連結、暫時緩解措施）
      - 優先處理順序（依風險分數排序）
    - 生成工單內容
      - 使用工單模板生成 TEXT/JSON（AC-017-3）
    - 生成工單檔案（AC-017-4）
    - 建立 Report 聚合根（report_type="IT_Ticket"）
    - 設定工單狀態（待處理，AC-017-5）
    - 返回 Report
  - _get_affected_assets 方法（取得受影響的資產）
  - _generate_ticket_content 方法（生成工單內容）
  - _generate_ticket_file 方法（生成工單檔案）

**驗收條件**：
- 可為每個嚴重或高風險威脅（風險分數 ≥ 6.0）生成 IT 工單（AC-017-1）
- 工單包含所有技術資訊（AC-017-2）
- 工單支援 TEXT 與 JSON 兩種格式（AC-017-3）
- 工單可匯出為檔案或透過 API 提供（AC-017-4）
- 系統可追蹤工單狀態（待處理、處理中、已完成、已關閉，AC-017-5）

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 整合測試通過
- 工單內容完整性測試通過
- 工單狀態管理測試通過

**前置任務**：
- T-4-1-1：實作報告領域模型
- T-3-2-1：實作風險計算服務

**相關文件**：
- plan.md 第 6.3.2 節「核心類別設計」（ReportGenerationService）
- spec.md US-017, AC-017-1 至 AC-017-5

---

#### T-4-2-2：實作工單格式（TEXT、JSON）

**對應使用者故事**：US-017  
**對應驗收條件**：AC-017-2, AC-017-3  
**對應 plan.md**：第 10.1.4 節「IT 工單生成」  
**優先級**：P0  
**預估工時**：8 小時  
**狀態**：待處理

**任務描述**：
實作工單格式，包含：
- TEXT 格式模板
  - 工單標題
  - CVE 編號與詳細描述
  - 受影響的資產清單（表格格式）
    - 產品名稱、版本、IP 位址、負責人
  - CVSS 分數與風險分數
  - 修補建議
    - 修補程式連結
    - 暫時緩解措施
  - 優先處理順序
- JSON 格式模板
  - 結構化 JSON 格式
  - 包含所有工單資訊
  - 符合 JSON Schema 規範
- 模板引擎
  - 使用 Jinja2 或類似模板引擎（TEXT）
  - 使用 JSON 序列化（JSON）

**驗收條件**：
- TEXT 格式包含所有技術資訊（AC-017-2）
- JSON 格式包含所有技術資訊（AC-017-2）
- 支援 TEXT 與 JSON 兩種格式（AC-017-3）
- 格式正確、易讀

**測試要求**：
- 模板渲染測試通過
- TEXT/JSON 生成測試通過
- 內容完整性測試通過

**前置任務**：
- T-4-2-1：實作工單生成服務

**相關文件**：
- plan.md 第 10.1.4 節「IT 工單生成」
- spec.md US-017, AC-017-2, AC-017-3

---

#### T-4-2-3：實作工單匯出功能

**對應使用者故事**：US-017, US-018  
**對應驗收條件**：AC-017-4, AC-018-1, AC-018-2, AC-018-3  
**對應 plan.md**：第 10.1.4 節「IT 工單生成」、第 5.2 節「API 端點定義」  
**優先級**：P0  
**預估工時**：10 小時  
**狀態**：待處理

**任務描述**：
實作工單匯出功能，包含：
- ReportService（Application Layer，擴充）
  - export_ticket 方法（匯出單一工單）
    - 輸入：工單 ID、格式（TEXT、JSON）
    - 取得工單記錄與檔案
    - 返回檔案內容或檔案路徑
  - export_tickets_batch 方法（批次匯出工單，AC-018-1）
    - 輸入：工單 ID 清單、格式（JSON，AC-018-2）
    - 取得所有選取的工單
    - 生成批次匯出檔案（JSON 格式，包含所有工單，AC-018-2）
    - 返回檔案內容或檔案路徑
- API 端點
  - GET /api/v1/reports/tickets/{id}/export（匯出單一工單，AC-017-4）
  - POST /api/v1/reports/tickets/export-batch（批次匯出工單，AC-018-1, AC-018-2）
- 稽核日誌記錄（AC-018-3）
  - 記錄工單匯出操作（使用者、時間、工單 ID）

**驗收條件**：
- 工單可匯出為檔案或透過 API 提供（AC-017-4）
- 支援批次匯出功能（可選取多個工單，AC-018-1）
- 支援 JSON 格式的批次匯出（包含所有選取的工單，AC-018-2）
- 記錄工單匯出的稽核日誌（AC-018-3）

**測試要求**：
- API 整合測試通過
- 匯出功能測試通過
- 批次匯出測試通過
- 稽核日誌記錄測試通過

**前置任務**：
- T-4-2-1：實作工單生成服務
- T-4-2-2：實作工單格式（TEXT、JSON）

**相關文件**：
- plan.md 第 5.2 節「API 端點定義」
- spec.md US-017, US-018

---

#### T-4-2-4：實作工單狀態管理

**對應使用者故事**：US-017  
**對應驗收條件**：AC-017-5  
**對應 plan.md**：第 10.1.4 節「IT 工單生成」、第 6.3.2 節「核心類別設計」  
**優先級**：P0  
**預估工時**：8 小時  
**狀態**：待處理

**任務描述**：
實作工單狀態管理，包含：
- Report 聚合根（擴充）
  - ticket_status 欄位（待處理、處理中、已完成、已關閉，AC-017-5）
  - update_ticket_status 方法（更新工單狀態）
    - 驗證狀態轉換規則
    - 發布 TicketStatusUpdatedEvent
- ReportService（Application Layer，擴充）
  - update_ticket_status 方法（更新工單狀態）
    - 輸入：工單 ID、新狀態
    - 更新工單狀態
    - 記錄狀態變更日誌
- API 端點
  - PUT /api/v1/reports/tickets/{id}/status（更新工單狀態）
- 狀態轉換規則
  - 待處理 → 處理中、已關閉
  - 處理中 → 已完成、已關閉
  - 已完成 → 已關閉
  - 已關閉 → 不可變更

**驗收條件**：
- 系統可追蹤工單狀態（待處理、處理中、已完成、已關閉，AC-017-5）
- 狀態轉換規則正確
- 狀態變更日誌記錄正確

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 狀態轉換測試通過
- 狀態管理測試通過

**前置任務**：
- T-4-2-1：實作工單生成服務

**相關文件**：
- plan.md 第 6.3.2 節「核心類別設計」
- spec.md US-017, AC-017-5

---

### 8.3 通知機制

**對應 plan.md**：第 10.1.4 節「通知機制」、第 6.3.2 節「核心類別設計」

#### T-4-3-1：實作通知規則管理

**對應使用者故事**：US-021  
**對應驗收條件**：AC-021-1 至 AC-021-4  
**對應 plan.md**：第 10.1.4 節「通知機制」、第 6.3.2 節「核心類別設計」（NotificationRule）  
**優先級**：P0  
**預估工時**：12 小時  
**狀態**：待處理

**任務描述**：
實作通知規則管理，包含：
- NotificationRule 聚合根（Domain Layer）
  - id、notification_type（Critical、HighRiskDaily、Weekly）
  - is_enabled（啟用狀態）
  - risk_score_threshold（風險分數閾值）
  - send_time（發送時間）
  - recipients（收件人清單）
  - 業務規則方法
    - should_trigger（檢查是否應該觸發通知）
      - 嚴重威脅通知：風險分數 ≥ 8.0（AC-021-1）
      - 高風險每日摘要：風險分數 ≥ 6.0（AC-021-1）
      - 週報通知：由排程觸發（AC-021-1）
    - toggle_enabled（啟用/停用通知，AC-021-3）
    - update_recipients（更新收件人，AC-021-2）
  - 領域事件（NotificationRuleUpdatedEvent）
- NotificationRuleRepository（Infrastructure Layer）
  - save（儲存通知規則）
  - get_by_id（依 ID 查詢）
  - get_enabled_rules（查詢啟用的規則）
  - get_by_type（依類型查詢）
- NotificationRuleService（Application Layer）
  - create_rule（建立通知規則，AC-021-1）
  - update_rule（更新通知規則，AC-021-2, AC-021-3）
  - delete_rule（刪除通知規則）
  - get_rules（查詢通知規則清單）
  - 記錄通知規則變更的稽核日誌（AC-021-4）

**驗收條件**：
- 可設定通知規則（嚴重威脅通知、高風險每日摘要、週報通知，AC-021-1）
- 可為每種通知類型設定不同的收件人（AC-021-2）
- 可啟用或停用個別通知類型（AC-021-3）
- 記錄通知規則的變更稽核日誌（AC-021-4）

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 整合測試通過
- 通知規則管理測試通過
- 稽核日誌記錄測試通過

**前置任務**：
- T-1-2-1：實作資料庫 Schema（NotificationRules 表）

**相關文件**：
- plan.md 第 6.3.2 節「核心類別設計」（NotificationRule 聚合根）
- plan.md 第 4.2 節「資料庫 Schema」（NotificationRules 表）
- spec.md US-021, AC-021-1 至 AC-021-4

---

#### T-4-3-2：實作 Email 通知服務

**對應使用者故事**：US-016, US-019, US-020  
**對應驗收條件**：AC-016-2, AC-016-3, AC-019-1 至 AC-019-4, AC-020-1 至 AC-020-4  
**對應 plan.md**：第 10.1.4 節「通知機制」、第 6.3.2 節「核心類別設計」（NotificationService）  
**優先級**：P0  
**預估工時**：12 小時  
**狀態**：待處理

**任務描述**：
實作 Email 通知服務，包含：
- EmailService 類別（Infrastructure Layer）
  - send 方法（發送 Email）
    - 輸入：recipients（收件人清單）、subject（主旨）、body（內容）
    - 使用 SMTP 或 Email API（如 SendGrid、AWS SES）
    - 支援 HTML 格式郵件
    - 錯誤處理與重試機制
  - send_batch 方法（批次發送）
- NotificationService 類別（Application Layer）
  - send_notification 方法（發送通知）
    - 輸入：NotificationRule、content（通知內容）
    - 建立通知記錄（AC-019-4, AC-020-4）
    - 發送 Email 通知（AC-016-3, AC-019-3）
    - 更新通知狀態（Sent/Failed）
    - 儲存通知記錄
    - 發布 NotificationSentEvent
  - _generate_notification_content 方法（生成通知內容）
    - 嚴重威脅通知內容（AC-019-2）
      - 威脅標題、CVE 編號、風險分數、受影響資產數量、詳細資訊連結
    - 高風險每日摘要內容（AC-020-2）
      - 威脅數量、威脅清單、受影響資產統計
    - 週報通知內容
      - 週報連結、摘要
- 通知記錄管理
  - 儲存通知記錄（時間、收件人、威脅 ID、狀態，AC-019-4）

**驗收條件**：
- 可設定多個收件人（Email 地址，AC-016-2）
- 可在生成週報後自動發送 Email 通知（AC-016-3）
- 可在發現嚴重威脅時立即發送通知（AC-019-1）
- 通知包含所有必要資訊（AC-019-2）
- 支援 Email 通知（AC-019-3）
- 記錄通知發送的日誌（AC-019-4）
- 可每日生成高風險威脅摘要（AC-020-1）
- 摘要包含所有必要資訊（AC-020-2）
- 可在設定的時間自動發送摘要（AC-020-3）
- 可設定摘要的收件人與發送時間（AC-020-4）

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 整合測試通過（使用 Mock Email 服務）
- Email 發送測試通過
- 通知內容生成測試通過

**前置任務**：
- T-4-3-1：實作通知規則管理
- T-1-2-1：實作資料庫 Schema（Notifications 表）

**相關文件**：
- plan.md 第 6.3.2 節「核心類別設計」（NotificationService）
- plan.md 第 4.2 節「資料庫 Schema」（Notifications 表）
- spec.md US-016, US-019, US-020

---

#### T-4-3-3：實作嚴重威脅即時通知

**對應使用者故事**：US-019  
**對應驗收條件**：AC-019-1 至 AC-019-4  
**對應 plan.md**：第 10.1.4 節「通知機制」、第 6.3.3 節「業務邏輯流程」  
**優先級**：P0  
**預估工時**：10 小時  
**狀態**：待處理

**任務描述**：
實作嚴重威脅即時通知，包含：
- RiskAssessmentEventHandler 類別（Application Layer）
  - 訂閱 RiskAssessmentCompleted 事件
  - handle 方法（處理風險評估完成事件）
    - 檢查風險分數是否 ≥ 8.0（AC-019-1）
    - 取得啟用的嚴重威脅通知規則
    - 生成通知內容（AC-019-2）
      - 威脅標題、CVE 編號、風險分數、受影響資產數量、詳細資訊連結
    - 發送 Email 通知（AC-019-3）
    - 儲存通知記錄（AC-019-4）
- 事件訂閱設定
  - 在事件總線中註冊事件處理器
- 通知內容模板
  - 嚴重威脅通知 Email 模板
  - 包含所有必要資訊（AC-019-2）

**驗收條件**：
- 可在發現嚴重威脅（風險分數 ≥ 8.0）時立即發送通知（AC-019-1）
- 通知包含所有必要資訊（AC-019-2）
- 支援 Email 通知（AC-019-3）
- 記錄通知發送的日誌（AC-019-4）

**測試要求**：
- 整合測試通過（事件訂閱與處理）
- 通知觸發測試通過
- 通知內容測試通過

**前置任務**：
- T-4-3-2：實作 Email 通知服務
- T-3-2-1：實作風險計算服務（RiskAssessmentCompleted 事件）

**相關文件**：
- plan.md 第 6.3.3 節「業務邏輯流程」（嚴重威脅即時通知流程）
- spec.md US-019, AC-019-1 至 AC-019-4

---

#### T-4-3-4：實作每日高風險威脅摘要

**對應使用者故事**：US-020  
**對應驗收條件**：AC-020-1 至 AC-020-4  
**對應 plan.md**：第 10.1.4 節「通知機制」、第 6.3.3 節「業務邏輯流程」  
**優先級**：P0  
**預估工時**：12 小時  
**狀態**：待處理

**任務描述**：
實作每日高風險威脅摘要，包含：
- DailyHighRiskSummaryService 類別（Application Layer）
  - generate_summary 方法（生成每日摘要）
    - 查詢本日高風險威脅（風險分數 ≥ 6.0，AC-020-1）
    - 統計威脅數量（AC-020-2）
    - 生成威脅清單（AC-020-2）
    - 統計受影響資產（AC-020-2）
    - 生成摘要內容
  - send_summary 方法（發送摘要）
    - 取得啟用的高風險每日摘要通知規則
    - 生成通知內容
    - 發送 Email 通知
    - 儲存通知記錄
- 排程管理
  - 使用 APScheduler 設定每日排程（預設：每日上午 8:00，AC-020-3）
  - 可自訂發送時間（AC-020-4）
  - 可自訂收件人（AC-020-4）
- 摘要內容模板
  - 每日高風險威脅摘要 Email 模板
  - 包含威脅數量、威脅清單、受影響資產統計（AC-020-2）

**驗收條件**：
- 可每日生成高風險威脅摘要（風險分數 ≥ 6.0，AC-020-1）
- 摘要包含所有必要資訊（AC-020-2）
- 可在設定的時間自動發送摘要（例如：每日上午 8:00，AC-020-3）
- 可設定摘要的收件人與發送時間（AC-020-4）

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 整合測試通過（排程執行）
- 摘要生成測試通過
- 通知發送測試通過

**前置任務**：
- T-4-3-2：實作 Email 通知服務
- T-4-3-1：實作通知規則管理

**相關文件**：
- plan.md 第 10.1.4 節「通知機制」
- spec.md US-020, AC-020-1 至 AC-020-4

---

#### T-4-3-5：實作通知排程

**對應使用者故事**：US-020  
**對應驗收條件**：AC-020-3, AC-020-4  
**對應 plan.md**：第 10.1.4 節「通知機制」  
**優先級**：P0  
**預估工時**：8 小時  
**狀態**：待處理

**任務描述**：
實作通知排程，包含：
- NotificationScheduleService 類別（Application Layer）
  - 使用 APScheduler 或類似工具
  - 設定每日高風險威脅摘要排程（AC-020-3）
    - 預設：每日上午 8:00
    - 可自訂發送時間（AC-020-4）
  - 排程任務執行
    - 呼叫 DailyHighRiskSummaryService.send_summary
    - 記錄執行日誌
  - 動態新增/移除排程任務
- 排程設定管理
  - 儲存通知排程設定（發送時間、收件人等）
  - 更新通知排程設定
- 排程任務狀態追蹤
  - 任務執行歷史記錄
  - 任務執行狀態（成功/失敗）

**驗收條件**：
- 可在設定的時間自動發送摘要（例如：每日上午 8:00，AC-020-3）
- 可設定摘要的發送時間（AC-020-4）
- 排程任務可正常執行
- 排程任務可動態新增/移除

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 整合測試通過（實際排程執行）
- 排程管理測試通過

**前置任務**：
- T-4-3-4：實作每日高風險威脅摘要

**相關文件**：
- plan.md 第 10.1.4 節「通知機制」
- spec.md US-020, AC-020-3, AC-020-4

---

### 8.4 報告與通知介面

**對應 plan.md**：第 10.1.4 節「報告與通知介面」、第 6.4 節「Web 管理界面模組」

#### T-4-4-1：實作前端報告管理介面

**對應使用者故事**：US-015, US-017  
**對應 plan.md**：第 10.1.4 節「報告與通知介面」、第 6.4 節「Web 管理界面模組」  
**優先級**：P0  
**預估工時**：16 小時  
**狀態**：待處理

**任務描述**：
使用 Next.js + React + TypeScript + Tailwind CSS 實作前端報告管理介面，包含：
- 報告清單頁面
  - 表格顯示報告清單
  - 分頁控制
  - 排序功能（依生成時間、報告類型等）
  - 篩選功能（依報告類型、時間範圍等）
  - 搜尋功能
- 報告詳細頁面
  - 顯示報告資訊（標題、類型、生成時間等）
  - 顯示報告摘要（AI 生成）
  - 下載報告檔案（HTML、PDF）
  - 預覽報告內容（HTML）
- 報告生成頁面（手動觸發）
  - 選擇報告類型（CISO 週報、IT 工單）
  - 設定報告參數（時間範圍等）
  - 觸發報告生成
  - 顯示生成進度
- UI/UX 設計
  - 使用統一的設計系統（Tailwind CSS，P8）
  - 響應式設計
  - 載入狀態顯示

**驗收條件**：
- 所有驗收條件通過（US-015, US-017 相關）
- UI/UX 符合設計規範（P8）
- 頁面載入時間符合要求（≤ 2 秒，NFR-001）
- 報告下載功能正常

**測試要求**：
- 端對端測試通過
- UI 測試通過

**前置任務**：
- T-4-1-6：實作報告儲存與查詢
- T-4-2-1：實作工單生成服務

**相關文件**：
- plan.md 第 6.4 節「Web 管理界面模組」
- spec.md US-015, US-017

---

#### T-4-4-2：實作前端通知規則設定介面

**對應使用者故事**：US-021  
**對應驗收條件**：AC-021-1 至 AC-021-4  
**對應 plan.md**：第 10.1.4 節「報告與通知介面」、第 6.4 節「Web 管理界面模組」  
**優先級**：P0  
**預估工時**：12 小時  
**狀態**：待處理

**任務描述**：
使用 Next.js + React + TypeScript + Tailwind CSS 實作前端通知規則設定介面，包含：
- 通知規則清單頁面
  - 表格顯示通知規則清單
  - 顯示規則類型、啟用狀態、收件人、發送時間等
  - 啟用/停用切換（AC-021-3）
- 通知規則設定頁面
  - 建立/編輯通知規則表單
    - 選擇通知類型（嚴重威脅通知、高風險每日摘要、週報通知，AC-021-1）
    - 設定風險分數閾值（如需要）
    - 設定收件人（多個 Email 地址，AC-021-2）
    - 設定發送時間（如需要）
    - 啟用/停用開關（AC-021-3）
  - 表單驗證
  - 儲存規則
- UI/UX 設計
  - 使用統一的設計系統（Tailwind CSS，P8）
  - 響應式設計
  - 表單驗證提示

**驗收條件**：
- 所有驗收條件通過（AC-021-1 至 AC-021-4）
- UI/UX 符合設計規範（P8）
- 表單驗證正確
- 啟用/停用功能正常（AC-021-3）

**測試要求**：
- 端對端測試通過
- UI 測試通過
- 表單驗證測試通過

**前置任務**：
- T-4-3-1：實作通知規則管理

**相關文件**：
- plan.md 第 6.4 節「Web 管理界面模組」
- spec.md US-021, AC-021-1 至 AC-021-4

---

#### T-4-4-3：實作歷史報告檢視

**對應使用者故事**：US-015  
**對應 plan.md**：第 10.1.4 節「報告與通知介面」  
**優先級**：P1  
**預估工時**：8 小時  
**狀態**：待處理

**任務描述**：
實作歷史報告檢視，包含：
- 歷史報告清單頁面
  - 顯示所有歷史報告
  - 支援時間範圍篩選
  - 支援報告類型篩選
  - 支援搜尋功能
- 歷史報告詳情頁面
  - 顯示報告完整內容
  - 下載報告檔案
  - 預覽報告內容
- 報告統計
  - 報告生成數量統計
  - 報告類型分布圖表

**驗收條件**：
- 歷史報告可正確顯示
- 報告下載功能正常
- 報告預覽功能正常
- UI/UX 符合設計規範

**測試要求**：
- 端對端測試通過
- UI 測試通過

**前置任務**：
- T-4-4-1：實作前端報告管理介面

**相關文件**：
- plan.md 第 10.1.4 節「報告與通知介面」

---

## 9. 階段 5：Web 管理界面與系統整合

**目標**：完成 Web 管理界面與系統整合功能  
**預估時程**：4-5 週  
**里程碑**：M5 - 系統完成

**對應 plan.md**：第 10.1.5 節「階段 5：Web 管理界面與系統整合」、第 6.4 節「Web 管理界面模組」  
**對應使用者故事**：US-022, US-023, US-024, US-025, US-026, US-027, US-028, US-029

### 9.1 身份驗證與授權

**對應 plan.md**：第 10.1.5 節「身份驗證與授權」、第 6.4.3 節「核心功能實作」、第 6.4.4 節「後端整合」

#### T-5-1-1：實作 OIDC/OAuth 2.0 整合

**對應使用者故事**：US-022  
**對應驗收條件**：AC-022-1, AC-022-2, AC-022-3, AC-022-4  
**對應 plan.md**：第 10.1.5 節「身份驗證與授權」、第 6.4.3 節「核心功能實作」、第 6.4.4 節「後端整合」  
**優先級**：P0  
**預估工時**：16 小時  
**狀態**：待處理

**任務描述**：
實作 OIDC/OAuth 2.0 整合，包含：
- 後端身份驗證服務（Application Layer）
  - OAuth2Service 類別
    - 整合 OIDC/OAuth 2.0 身份驗證提供者 (IdP)（AC-022-1）
    - 支援授權碼流程 (Authorization Code Flow)
    - Token 驗證與解析
    - 使用者資訊取得
  - TokenValidator 類別
    - validate 方法（驗證 Access Token）
    - 檢查 Token 有效性、過期時間
    - 解析 Token 取得使用者資訊
- 前端身份驗證（Next.js）
  - lib/auth/auth.ts
    - signIn 方法（重定向至 IdP 登入頁面，AC-022-1, AC-022-2）
    - handleCallback 方法（處理授權回調）
      - 使用授權碼交換 Access Token
      - 儲存 Token（localStorage 或 secure cookie）
      - 取得使用者資訊
    - signOut 方法（登出）
    - getUserInfo 方法（取得使用者資訊）
  - 支援單一登入 (SSO) 功能（AC-022-2）
- 錯誤處理
  - 登入失敗時顯示明確的錯誤訊息（AC-022-3）
  - Token 過期處理
  - 網路錯誤處理
- 稽核日誌記錄（AC-022-4）
  - 記錄所有登入嘗試（成功與失敗）
  - 記錄登出操作

**驗收條件**：
- 可整合 OIDC/OAuth 2.0 身份驗證提供者 (IdP)（AC-022-1）
- 支援單一登入 (SSO) 功能（AC-022-2）
- 登入失敗時顯示明確的錯誤訊息（AC-022-3）
- 記錄所有登入嘗試的稽核日誌（成功與失敗，AC-022-4）
- Token 驗證與管理正常

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 整合測試通過（Mock IdP）
- 登入流程測試通過
- 錯誤處理測試通過
- 稽核日誌記錄測試通過

**前置任務**：
- T-1-2-1：實作資料庫 Schema（Users、AuditLogs 表）

**相關文件**：
- plan.md 第 6.4.3 節「核心功能實作」（身份驗證流程）
- plan.md 第 6.4.4 節「後端整合」（身份驗證中介軟體）
- spec.md US-022, AC-022-1 至 AC-022-4

---

#### T-5-1-2：實作 RBAC 授權機制

**對應使用者故事**：US-023  
**對應驗收條件**：AC-023-1 至 AC-023-5  
**對應 plan.md**：第 10.1.5 節「身份驗證與授權」、第 6.4.4 節「後端整合」  
**優先級**：P0  
**預估工時**：16 小時  
**狀態**：待處理

**任務描述**：
實作 RBAC 授權機制，包含：
- 後端授權服務（Application Layer）
  - AuthorizationService 類別
    - check_permission 方法（檢查權限）
    - get_user_roles 方法（取得使用者角色）
    - get_role_permissions 方法（取得角色權限）
  - require_role 裝飾器（plan.md 第 6.4.4 節）
    - 角色授權裝飾器
    - 檢查使用者角色是否符合要求（AC-023-4）
    - 不符合時返回 403 Forbidden
  - require_permission 裝飾器
    - 權限授權裝飾器
    - 檢查使用者是否有特定權限
- 角色定義（AC-023-2）
  - 資安官 (CISO)：完整存取權限（檢視、設定、管理）
  - IT 管理員 (IT Admin)：資產管理、排程設定、工單檢視
  - 資安分析師 (Analyst)：檢視威脅情資、分析結果、報告
  - 唯讀使用者 (Viewer)：僅能檢視報告與威脅情資
- 權限定義
  - 各功能模組的權限清單
  - 角色與權限的對應關係
- API 層級權限驗證（AC-023-4）
  - 在所有 API 端點中套用授權檢查
  - 防止未授權存取
- 前端權限控制（AC-023-3）
  - usePermission Hook（檢查權限）
  - ProtectedRoute 元件（保護路由）
  - 在 UI 中隱藏使用者無權存取的功能（AC-023-3）
- 稽核日誌記錄（AC-023-5）
  - 記錄所有權限驗證失敗的稽核日誌

**驗收條件**：
- 實作角色基礎存取控制 (RBAC)（AC-023-1）
- 定義所有角色（CISO、IT Admin、Analyst、Viewer，AC-023-2）
- 在 UI 中隱藏使用者無權存取的功能（AC-023-3）
- 在 API 層級驗證權限，防止未授權存取（AC-023-4）
- 記錄所有權限驗證失敗的稽核日誌（AC-023-5）

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 整合測試通過
- 角色權限測試通過
- API 權限驗證測試通過
- 前端權限控制測試通過
- 稽核日誌記錄測試通過

**前置任務**：
- T-5-1-1：實作 OIDC/OAuth 2.0 整合
- T-1-2-1：實作資料庫 Schema（Roles、Permissions、UserRoles、RolePermissions 表）

**相關文件**：
- plan.md 第 6.4.4 節「後端整合」（授權裝飾器）
- plan.md 第 4.2 節「資料庫 Schema」（Roles、Permissions 表）
- spec.md US-023, AC-023-1 至 AC-023-5

---

#### T-5-1-3：實作前端登入介面

**對應使用者故事**：US-022  
**對應驗收條件**：AC-022-1, AC-022-2, AC-022-3  
**對應 plan.md**：第 10.1.5 節「身份驗證與授權」、第 6.4.3 節「核心功能實作」  
**優先級**：P0  
**預估工時**：8 小時  
**狀態**：待處理

**任務描述**：
使用 Next.js + React + TypeScript + Tailwind CSS 實作前端登入介面，包含：
- 登入頁面（app/(auth)/login/page.tsx）
  - 登入按鈕（觸發 OIDC/OAuth 2.0 登入流程，AC-022-1, AC-022-2）
  - 載入狀態顯示
  - 錯誤訊息顯示（AC-022-3）
    - 登入失敗時顯示明確的錯誤訊息
    - 網路錯誤處理
    - Token 驗證失敗處理
- 登入回調頁面（app/(auth)/callback/page.tsx）
  - 處理授權回調
  - 提取授權碼
  - 呼叫 handleCallback 方法
  - 重定向至儀表板
- 登出功能
  - 登出按鈕
  - 清除 Token 與使用者資訊
  - 重定向至登入頁面
- UI/UX 設計
  - 使用統一的設計系統（Tailwind CSS，P8）
  - 響應式設計
  - 載入狀態顯示
  - 錯誤訊息提示

**驗收條件**：
- 登入介面符合設計規範（P8）
- 可透過 OIDC/OAuth 2.0 登入（AC-022-1, AC-022-2）
- 登入失敗時顯示明確的錯誤訊息（AC-022-3）
- 登入流程順暢

**測試要求**：
- 端對端測試通過
- UI 測試通過
- 登入流程測試通過
- 錯誤處理測試通過

**前置任務**：
- T-5-1-1：實作 OIDC/OAuth 2.0 整合

**相關文件**：
- plan.md 第 6.4.3 節「核心功能實作」（身份驗證流程）
- spec.md US-022, AC-022-1 至 AC-022-3

---

#### T-5-1-4：實作權限檢查中介軟體

**對應使用者故事**：US-023  
**對應驗收條件**：AC-023-4, AC-023-5  
**對應 plan.md**：第 10.1.5 節「身份驗證與授權」、第 6.4.4 節「後端整合」  
**優先級**：P0  
**預估工時**：8 小時  
**狀態**：待處理

**任務描述**：
實作權限檢查中介軟體，包含：
- AuthenticationMiddleware（plan.md 第 6.4.4 節）
  - 提取 Token（從 Authorization header）
  - 驗證 Token 有效性
  - 設定使用者上下文（request.state.user）
- AuthorizationMiddleware
  - 檢查使用者角色與權限
  - 驗證 API 端點的存取權限（AC-023-4）
  - 不符合時返回 403 Forbidden
- 授權裝飾器（plan.md 第 6.4.4 節）
  - require_role 裝飾器（檢查角色）
  - require_permission 裝飾器（檢查權限）
- 錯誤處理
  - 401 Unauthorized（未提供 Token 或 Token 無效）
  - 403 Forbidden（權限不足）
- 稽核日誌記錄（AC-023-5）
  - 記錄所有權限驗證失敗的稽核日誌

**驗收條件**：
- 在 API 層級驗證權限，防止未授權存取（AC-023-4）
- 記錄所有權限驗證失敗的稽核日誌（AC-023-5）
- 中介軟體可正確攔截與驗證請求
- 錯誤回應正確

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 整合測試通過
- 權限驗證測試通過
- 錯誤處理測試通過
- 稽核日誌記錄測試通過

**前置任務**：
- T-5-1-2：實作 RBAC 授權機制

**相關文件**：
- plan.md 第 6.4.4 節「後端整合」（身份驗證中介軟體、授權裝飾器）
- spec.md US-023, AC-023-4, AC-023-5

---

### 9.2 系統管理功能

**對應 plan.md**：第 10.1.5 節「系統管理功能」、第 6.4 節「Web 管理界面模組」

#### T-5-2-1：實作系統設定管理

**對應使用者故事**：US-024  
**對應驗收條件**：AC-024-1 至 AC-024-5  
**對應 plan.md**：第 10.1.5 節「系統管理功能」、第 6.4.3 節「核心功能實作」  
**優先級**：P0  
**預估工時**：12 小時  
**狀態**：待處理

**任務描述**：
實作系統設定管理，包含：
- 後端系統設定服務（Application Layer）
  - SystemConfigurationService 類別
    - get_configuration 方法（取得系統設定）
    - update_configuration 方法（更新系統設定）
    - 支援以下設定類別（AC-024-2）：
      - 威脅情資來源訂閱
      - 通知規則
      - 報告排程
      - 資料保留政策
  - SystemConfigurationRepository
    - save（儲存設定）
    - get_by_category（依類別查詢）
- 前端系統設定介面（Next.js）
  - 系統設定頁面（app/(dashboard)/settings/page.tsx）
    - 集中管理介面（AC-024-1）
    - 設定類別分頁或區塊
    - 表單處理（明確的交易儲存，AC-024-3）
      - 儲存前要求使用者確認（AC-024-3）
      - 提供「取消」按鈕，允許使用者放棄變更（AC-024-4）
      - 使用 AssetForm 的設計模式（plan.md 第 6.4.3 節）
  - 設定表單元件
    - 威脅情資來源訂閱設定
    - 通知規則設定
    - 報告排程設定
    - 資料保留政策設定
- 稽核日誌記錄（AC-024-5）
  - 記錄所有設定變更的稽核日誌

**驗收條件**：
- 提供系統設定的集中管理介面（AC-024-1）
- 支援所有設定類別（AC-024-2）
- 在儲存設定前要求使用者確認（明確的交易儲存，AC-024-3）
- 提供「取消」按鈕，允許使用者放棄變更（AC-024-4）
- 記錄所有設定變更的稽核日誌（AC-024-5）

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 整合測試通過
- 設定管理測試通過
- 表單驗證測試通過
- 稽核日誌記錄測試通過

**前置任務**：
- T-1-2-1：實作資料庫 Schema（SystemConfigurations 表）
- T-5-1-2：實作 RBAC 授權機制

**相關文件**：
- plan.md 第 6.4.3 節「核心功能實作」（表單處理）
- plan.md 第 4.2 節「資料庫 Schema」（SystemConfigurations 表）
- spec.md US-024, AC-024-1 至 AC-024-5

---

#### T-5-2-2：實作排程管理（威脅收集、週報）

**對應使用者故事**：US-025, US-026  
**對應驗收條件**：AC-025-1 至 AC-025-5, AC-026-1 至 AC-026-5  
**對應 plan.md**：第 10.1.5 節「系統管理功能」、第 6.4 節「Web 管理界面模組」  
**優先級**：P0  
**預估工時**：16 小時  
**狀態**：待處理

**任務描述**：
實作排程管理，包含：
- 後端排程管理服務（Application Layer）
  - ScheduleManagementService 類別
    - get_schedules 方法（取得排程清單）
    - create_schedule 方法（建立排程）
    - update_schedule 方法（更新排程）
    - delete_schedule 方法（刪除排程）
    - trigger_schedule 方法（手動觸發排程，AC-025-5, AC-026-5）
    - get_schedule_history 方法（取得排程執行歷史，AC-025-4, AC-026-4）
  - 支援 Cron 表達式或類似的排程語法（AC-025-2）
- 威脅收集排程管理（US-025）
  - 前端排程設定介面（AC-025-1）
    - 可視化排程設定介面
    - 為每個威脅情資來源設定獨立的排程（AC-025-3）
    - Cron 表達式輸入或選擇器（AC-025-2）
    - 顯示排程的執行歷史（AC-025-4）
      - 最後執行時間
      - 下次執行時間
      - 執行狀態（成功/失敗）
    - 手動觸發按鈕（AC-025-5）
- 週報排程管理（US-026）
  - 前端週報排程設定介面（AC-026-1）
    - 可視化設定介面
    - 設定週報的生成時間（例如：每週一上午 9:00，AC-026-2）
    - 設定週報的收件人清單（AC-026-3）
    - 顯示週報排程的執行歷史（AC-026-4）
    - 手動觸發按鈕（AC-026-5）
- API 端點
  - GET /api/v1/schedules（查詢排程清單）
  - POST /api/v1/schedules（建立排程）
  - PUT /api/v1/schedules/{id}（更新排程）
  - DELETE /api/v1/schedules/{id}（刪除排程）
  - POST /api/v1/schedules/{id}/trigger（手動觸發排程）

**驗收條件**：
- 提供排程設定的可視化介面（AC-025-1）
- 支援 Cron 表達式或類似的排程語法（AC-025-2）
- 允許為每個威脅情資來源設定獨立的排程（AC-025-3）
- 顯示排程的執行歷史（AC-025-4）
- 允許手動觸發排程執行（AC-025-5）
- 提供週報排程的可視化設定介面（AC-026-1）
- 允許設定週報的生成時間（AC-026-2）
- 允許設定週報的收件人清單（AC-026-3）
- 顯示週報排程的執行歷史（AC-026-4）
- 允許手動觸發週報生成（AC-026-5）

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 整合測試通過
- 排程管理測試通過
- 手動觸發測試通過

**前置任務**：
- T-2-2-8：實作收集排程與任務管理
- T-4-1-5：實作報告排程管理
- T-5-1-2：實作 RBAC 授權機制

**相關文件**：
- plan.md 第 10.1.5 節「系統管理功能」
- spec.md US-025, US-026

---

#### T-5-2-3：實作系統狀態監控介面

**對應使用者故事**：US-027  
**對應驗收條件**：AC-027-1 至 AC-027-4  
**對應 plan.md**：第 10.1.5 節「系統管理功能」、第 6.4 節「Web 管理界面模組」  
**優先級**：P0  
**預估工時**：12 小時  
**狀態**：待處理

**任務描述**：
實作系統狀態監控介面，包含：
- 後端健康檢查服務（Application Layer）
  - HealthCheckService 類別
    - check_health 方法（檢查系統健康狀態）
      - 資料庫連線檢查
      - API 可用性檢查
      - 外部服務連線檢查（AI 服務、Email 服務等）
    - get_system_status 方法（取得系統狀態）
      - 威脅情資收集狀態（各來源的最後收集時間與狀態，AC-027-2）
      - 最近收集的威脅數量（AC-027-2）
      - 待處理的嚴重威脅數量（AC-027-2）
      - 系統健康狀態（AC-027-2）
- 健康檢查端點（AC-027-3）
  - GET /api/v1/health（健康檢查端點）
    - 返回系統健康狀態
    - 返回各服務的可用性
- 前端儀表板（Dashboard）（AC-027-1）
  - 系統狀態儀表板頁面（app/(dashboard)/dashboard/page.tsx）
    - 顯示系統狀態資訊（AC-027-2）
      - 威脅情資收集狀態（各來源的最後收集時間與狀態）
      - 最近收集的威脅數量
      - 待處理的嚴重威脅數量
      - 系統健康狀態（資料庫連線、API 可用性等）
    - 狀態卡片元件
    - 狀態圖表（如需要）
    - 告警訊息顯示（AC-027-4）
      - 系統異常時顯示告警訊息
      - 顏色編碼（綠色：正常、黃色：警告、紅色：異常）
- 即時更新
  - 使用 WebSocket 或輪詢機制更新狀態
  - 自動刷新（每 30 秒）

**驗收條件**：
- 提供儀表板 (Dashboard) 顯示系統狀態（AC-027-1）
- 儀表板顯示所有必要資訊（AC-027-2）
- 提供健康檢查端點 (Health Check Endpoint)（AC-027-3）
- 系統異常時顯示告警訊息（AC-027-4）

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 整合測試通過
- 健康檢查測試通過
- 儀表板顯示測試通過

**前置任務**：
- T-2-2-8：實作收集排程與任務管理
- T-5-1-2：實作 RBAC 授權機制

**相關文件**：
- plan.md 第 10.1.5 節「系統管理功能」
- spec.md US-027, AC-027-1 至 AC-027-4

---

#### T-5-2-4：實作稽核日誌查詢介面

**對應使用者故事**：US-024, US-022, US-023（所有涉及稽核日誌的功能）  
**對應 plan.md**：第 10.1.5 節「系統管理功能」、第 6.4 節「Web 管理界面模組」  
**優先級**：P0  
**預估工時**：10 小時  
**狀態**：待處理

**任務描述**：
實作稽核日誌查詢介面，包含：
- 後端稽核日誌服務（Application Layer）
  - AuditLogService 類別（擴充）
    - get_audit_logs 方法（查詢稽核日誌）
      - 支援分頁、排序、篩選
      - 依操作類型篩選
      - 依使用者篩選
      - 依時間範圍篩選
      - 依資源類型篩選
- API 端點
  - GET /api/v1/audit-logs（查詢稽核日誌）
    - 支援查詢參數：page, pageSize, sort, filter
- 前端稽核日誌查詢介面（Next.js）
  - 稽核日誌列表頁面（app/(dashboard)/audit-logs/page.tsx）
    - 表格顯示稽核日誌清單
    - 分頁控制
    - 排序功能
    - 篩選功能
      - 依操作類型篩選
      - 依使用者篩選
      - 依時間範圍篩選
      - 依資源類型篩選
    - 搜尋功能
    - 匯出功能（CSV、JSON）
- UI/UX 設計
  - 使用統一的設計系統（Tailwind CSS，P8）
  - 響應式設計
  - 載入狀態顯示

**驗收條件**：
- 可查詢所有稽核日誌
- 支援多種篩選條件
- 支援分頁與排序
- 支援匯出功能
- UI/UX 符合設計規範（P8）

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 整合測試通過
- 查詢功能測試通過
- 匯出功能測試通過

**前置任務**：
- T-1-4-5：實作稽核日誌服務
- T-5-1-2：實作 RBAC 授權機制

**相關文件**：
- plan.md 第 10.1.5 節「系統管理功能」
- plan.md 第 4.2 節「資料庫 Schema」（AuditLogs 表）

---

### 9.3 統計與儀表板

**對應 plan.md**：第 10.1.5 節「統計與儀表板」、第 6.4 節「Web 管理界面模組」

#### T-5-3-1：實作威脅統計 API

**對應使用者故事**：US-028  
**對應驗收條件**：AC-028-1, AC-028-2  
**對應 plan.md**：第 10.1.5 節「統計與儀表板」、第 5.2 節「API 端點定義」  
**優先級**：P0  
**預估工時**：12 小時  
**狀態**：待處理

**任務描述**：
實作威脅統計 API，包含：
- 後端統計服務（Application Layer）
  - ThreatStatisticsService 類別
    - get_threat_trend 方法（取得威脅數量趨勢，AC-028-1）
      - 依時間統計威脅數量
      - 支援時間範圍篩選（最近 7 天、30 天、90 天等，AC-028-2）
    - get_risk_distribution 方法（取得風險分數分布，AC-028-1）
      - 統計各風險等級的威脅數量（嚴重/高/中/低）
    - get_affected_asset_statistics 方法（取得受影響資產統計，AC-028-1）
      - 依資產類型統計
      - 依資產重要性統計
    - get_threat_source_statistics 方法（取得威脅來源統計，AC-028-1）
      - 統計各來源的威脅數量
- API 端點
  - GET /api/v1/statistics/threats/trend（威脅數量趨勢）
    - 查詢參數：startDate, endDate, interval（日/週/月）
  - GET /api/v1/statistics/threats/risk-distribution（風險分數分布）
    - 查詢參數：startDate, endDate
  - GET /api/v1/statistics/threats/affected-assets（受影響資產統計）
    - 查詢參數：startDate, endDate
  - GET /api/v1/statistics/threats/sources（威脅來源統計）
    - 查詢參數：startDate, endDate

**驗收條件**：
- 提供威脅情資的統計 API（AC-028-1）
- 支援時間範圍篩選（最近 7 天、30 天、90 天等，AC-028-2）
- API 回應時間符合要求（≤ 2 秒，NFR-001）

**測試要求**：
- 單元測試覆蓋率 ≥ 80%
- 整合測試通過
- 統計計算正確性測試通過
- 效能測試通過

**前置任務**：
- T-2-3-1：實作威脅 Repository
- T-3-2-1：實作風險計算服務

**相關文件**：
- plan.md 第 5.2 節「API 端點定義」
- spec.md US-028, AC-028-1, AC-028-2

---

#### T-5-3-2：實作前端儀表板

**對應使用者故事**：US-027, US-028  
**對應驗收條件**：AC-027-1, AC-027-2, AC-028-1, AC-028-2  
**對應 plan.md**：第 10.1.5 節「統計與儀表板」、第 6.4 節「Web 管理界面模組」  
**優先級**：P0  
**預估工時**：16 小時  
**狀態**：待處理

**任務描述**：
使用 Next.js + React + TypeScript + Tailwind CSS 實作前端儀表板，包含：
- 儀表板頁面（app/(dashboard)/dashboard/page.tsx）
  - 系統狀態區塊（AC-027-1, AC-027-2）
    - 威脅情資收集狀態
    - 最近收集的威脅數量
    - 待處理的嚴重威脅數量
    - 系統健康狀態
  - 威脅統計區塊（AC-028-1）
    - 威脅數量趨勢圖表（依時間，AC-028-1）
    - 風險分數分布圖表（嚴重/高/中/低，AC-028-1）
    - 受影響資產統計圖表（依資產類型，AC-028-1）
    - 威脅來源統計圖表（各來源的威脅數量，AC-028-1）
  - 時間範圍篩選器（AC-028-2）
    - 最近 7 天、30 天、90 天等選項
    - 自訂時間範圍選擇器
  - 使用圖表函式庫（如 Chart.js、Recharts）
- UI/UX 設計
  - 使用統一的設計系統（Tailwind CSS，P8）
  - 響應式設計（網格布局）
  - 載入狀態顯示
  - 即時更新（輪詢或 WebSocket）

**驗收條件**：
- 提供儀表板顯示系統狀態（AC-027-1, AC-027-2）
- 提供威脅情資的統計圖表（AC-028-1）
- 支援時間範圍篩選（AC-028-2）
- UI/UX 符合設計規範（P8）
- 頁面載入時間符合要求（≤ 2 秒，NFR-001）

**測試要求**：
- 端對端測試通過
- UI 測試通過
- 圖表功能測試通過

**前置任務**：
- T-5-3-1：實作威脅統計 API
- T-5-2-3：實作系統狀態監控介面

**相關文件**：
- plan.md 第 6.4 節「Web 管理界面模組」
- spec.md US-027, US-028

---

#### T-5-3-3：實作威脅趨勢圖表

**對應使用者故事**：US-028  
**對應驗收條件**：AC-028-1, AC-028-2, AC-028-3  
**對應 plan.md**：第 10.1.5 節「統計與儀表板」  
**優先級**：P0  
**預估工時**：10 小時  
**狀態**：待處理

**任務描述**：
實作威脅趨勢圖表，包含：
- 威脅數量趨勢圖表（AC-028-1）
  - 時間序列圖（線圖或柱狀圖）
  - X 軸：時間（日/週/月）
  - Y 軸：威脅數量
  - 支援多條線（不同威脅類型或來源）
- 風險分數分布圖表（AC-028-1）
  - 圓形圖或長條圖
  - 顯示各風險等級的威脅數量（嚴重/高/中/低）
- 受影響資產統計圖表（AC-028-1）
  - 長條圖或堆疊圖
  - 依資產類型或重要性分類
- 威脅來源統計圖表（AC-028-1）
  - 長條圖或圓形圖
  - 顯示各來源的威脅數量
- 時間範圍篩選（AC-028-2）
  - 下拉選單或日期選擇器
  - 最近 7 天、30 天、90 天等選項
- 圖表匯出功能（AC-028-3）
  - 匯出為 PNG 圖片
  - 匯出為 PDF
  - 使用圖表函式庫的匯出功能

**驗收條件**：
- 提供威脅數量趨勢圖表（AC-028-1）
- 提供風險分數分布圖表（AC-028-1）
- 提供受影響資產統計圖表（AC-028-1）
- 提供威脅來源統計圖表（AC-028-1）
- 支援時間範圍篩選（AC-028-2）
- 提供圖表的匯出功能（PNG、PDF，AC-028-3）

**測試要求**：
- 端對端測試通過
- 圖表功能測試通過
- 匯出功能測試通過

**前置任務**：
- T-5-3-2：實作前端儀表板

**相關文件**：
- plan.md 第 10.1.5 節「統計與儀表板」
- spec.md US-028, AC-028-1 至 AC-028-3

---

#### T-5-3-4：實作資產統計

**對應使用者故事**：US-028  
**對應 plan.md**：第 10.1.5 節「統計與儀表板」  
**優先級**：P1  
**預估工時**：8 小時  
**狀態**：待處理

**任務描述**：
實作資產統計，包含：
- 後端資產統計服務（Application Layer）
  - AssetStatisticsService 類別
    - get_asset_statistics 方法（取得資產統計）
      - 資產總數統計
      - 依資產類型統計
      - 依資料敏感度統計
      - 依業務關鍵性統計
      - 受威脅影響的資產統計
- API 端點
  - GET /api/v1/statistics/assets（資產統計）
- 前端資產統計區塊
  - 資產統計卡片
  - 資產分布圖表
  - 受威脅影響的資產統計

**驗收條件**：
- 資產統計正確
- 圖表顯示正常
- UI/UX 符合設計規範

**測試要求**：
- 整合測試通過
- 統計計算正確性測試通過

**前置任務**：
- T-5-3-2：實作前端儀表板

**相關文件**：
- plan.md 第 10.1.5 節「統計與儀表板」

---

### 9.4 系統整合與優化

**對應 plan.md**：第 10.1.5 節「系統整合與優化」

#### T-5-4-1：端對端測試所有功能

**對應 plan.md**：第 10.1.5 節「系統整合與優化」、第 8.3 節「端對端測試」  
**優先級**：P0  
**預估工時**：20 小時  
**狀態**：待處理

**任務描述**：
執行端對端測試所有功能，包含：
- 測試場景規劃
  - 身份驗證與授權流程
  - 資產管理完整流程
  - 威脅收集與分析完整流程
  - 報告生成與通知完整流程
  - 系統管理功能
- 測試執行
  - 使用 Playwright 或 Cypress
  - 執行所有端對端測試場景
  - 驗證所有使用者故事與驗收條件
- 測試報告
  - 測試結果報告
  - 問題追蹤與修復
- 測試自動化
  - CI/CD 整合
  - 自動化測試執行

**驗收條件**：
- 所有端對端測試通過
- 所有使用者故事與驗收條件通過
- 測試報告完整

**測試要求**：
- 端對端測試通過（使用 Playwright 或 Cypress）
- 所有測試場景通過

**前置任務**：
- 所有階段 1-5 的任務完成

**相關文件**：
- plan.md 第 8.3 節「端對端測試」
- spec.md 所有使用者故事

---

#### T-5-4-2：效能優化

**對應 plan.md**：第 10.1.5 節「系統整合與優化」、第 8.4 節「效能測試」  
**優先級**：P0  
**預估工時**：12 小時  
**狀態**：待處理

**任務描述**：
執行效能優化，包含：
- 效能測試
  - API 回應時間測試（目標 ≤ 2 秒，NFR-001）
  - 資料庫查詢效能測試
  - 前端頁面載入時間測試（目標 ≤ 2 秒，NFR-001）
  - 並發處理效能測試
- 效能優化
  - 資料庫查詢優化（索引調整、查詢優化）
  - API 回應時間優化（快取機制、非同步處理）
  - 前端效能優化（程式碼分割、懶載入、圖片優化）
  - 資源使用量優化（記憶體、CPU）
- 效能監控
  - 設定效能監控指標
  - 建立效能監控儀表板

**驗收條件**：
- API 回應時間符合要求（≤ 2 秒，NFR-001）
- 前端頁面載入時間符合要求（≤ 2 秒，NFR-001）
- 資料庫查詢效能符合要求
- 系統資源使用量合理

**測試要求**：
- 效能測試通過
- 負載測試通過（如需要）

**前置任務**：
- T-5-4-1：端對端測試所有功能

**相關文件**：
- plan.md 第 8.4 節「效能測試」
- spec.md NFR-001

---

#### T-5-4-3：安全性檢查

**對應 plan.md**：第 10.1.5 節「系統整合與優化」  
**優先級**：P0  
**預估工時**：10 小時  
**狀態**：待處理

**任務描述**：
執行安全性檢查，包含：
- 安全性掃描
  - 依賴套件漏洞掃描
  - 程式碼安全性掃描
  - API 安全性測試
- 安全性檢查項目
  - 身份驗證與授權機制
  - 輸入驗證與清理
  - SQL 注入防護
  - XSS 防護
  - CSRF 防護
  - 資料加密（傳輸與儲存）
  - 敏感資料保護
- 安全性修復
  - 修復發現的安全性問題
  - 更新有漏洞的依賴套件
- 安全性文件
  - 安全性檢查報告
  - 安全性建議

**驗收條件**：
- 所有安全性檢查通過
- 無高風險安全性問題
- 安全性文件完整

**測試要求**：
- 安全性掃描通過
- 安全性測試通過

**前置任務**：
- T-5-4-1：端對端測試所有功能

**相關文件**：
- plan.md 第 10.1.5 節「系統整合與優化」
- 專案憲章 P1「安全性優先」

---

#### T-5-4-4：文件整理

**對應 plan.md**：第 10.1.5 節「系統整合與優化」  
**優先級**：P0  
**預估工時**：8 小時  
**狀態**：待處理

**任務描述**：
整理系統文件，包含：
- API 文件
  - 更新 OpenAPI 文件
  - API 使用範例
- 系統文件
  - 系統架構文件
  - 部署文件
  - 操作手冊
  - 維護手冊
- 開發文件
  - 開發環境設定
  - 程式碼註解
  - README 文件
- 使用者文件
  - 使用者手冊
  - 功能說明文件

**驗收條件**：
- 所有文件完整
- 文件內容準確
- 文件格式統一

**測試要求**：
- 文件審查通過

**前置任務**：
- T-5-4-1：端對端測試所有功能

**相關文件**：
- plan.md 第 10.1.5 節「系統整合與優化」

---

## 10. 任務追蹤與狀態管理

### 10.1 任務狀態定義

- **待處理**：任務已定義，尚未開始
- **進行中**：任務正在執行中
- **已完成**：任務開發完成，等待驗收
- **已驗收**：任務已通過驗收，可進入下一階段

### 10.2 任務進度追蹤

任務進度將在專案管理工具中追蹤，包含：
- 任務完成率
- 階段進度
- 里程碑達成狀況

---

## 11. 參考文件

1. **專案憲章**：`1.專案憲章 Project Constitution.md` (v2.1.0)
2. **系統需求規格**：`系統需求設計與分析/spec.md` (v1.0.0)
3. **系統實作計畫**：`系統需求設計與分析/plan.md` (v1.0.0)

---

## 文件完成狀態

### 已完成章節

- ✅ **第 1 章：目的** - 已完成
- ✅ **第 2 章：範圍** - 已完成
- ✅ **第 3 章：任務組織方式** - 已完成
- ✅ **第 4 章：任務定義格式** - 已完成
- ✅ **第 5 章：階段 1：基礎建設與核心功能** - 已完成（17 個任務）
- ✅ **第 6 章：階段 2：威脅收集與 AI 處理** - 已完成（20 個任務）

### 已完成章節

- ✅ **第 1 章：目的** - 已完成
- ✅ **第 2 章：範圍** - 已完成
- ✅ **第 3 章：任務組織方式** - 已完成
- ✅ **第 4 章：任務定義格式** - 已完成
- ✅ **第 5 章：階段 1：基礎建設與核心功能** - 已完成（17 個任務）
- ✅ **第 6 章：階段 2：威脅收集與 AI 處理** - 已完成（20 個任務）
- ✅ **第 7 章：階段 3：關聯分析與風險計算** - 已完成（18 個任務）
- ✅ **第 8 章：階段 4：報告生成與通知** - 已完成（20 個任務）
- ✅ **第 9 章：階段 5：Web 管理界面與系統整合** - 已完成（18 個任務）
- ✅ **第 10 章：任務追蹤與狀態管理** - 已完成
- ✅ **第 11 章：參考文件** - 已完成

### 待完成章節

無（所有章節已完成）

### 階段 1 任務清單摘要

- **總任務數**：17 個
- **P0 優先級任務**：15 個
- **P1 優先級任務**：2 個
- **總預估工時**：約 200+ 小時
- **預估時程**：4-5 週
- **對應使用者故事**：US-001 至 US-007
- **對應里程碑**：M1 - 基礎建設完成

### 階段 2 任務清單摘要

- **總任務數**：20 個
- **P0 優先級任務**：18 個
- **P1 優先級任務**：2 個
- **總預估工時**：約 180+ 小時
- **預估時程**：5-6 週
- **對應使用者故事**：US-008, US-009, US-014
- **對應里程碑**：M2 - 威脅收集與 AI 處理完成

**任務分類**：
- **6.1 AI/ML 服務開發**：7 個任務（T-2-1-1 至 T-2-1-7）
- **6.2 威脅情資收集引擎**：8 個任務（T-2-2-1 至 T-2-2-8）
- **6.3 威脅資料儲存與查詢**：4 個任務（T-2-3-1 至 T-2-3-4）
- **6.4 整合測試與優化**：4 個任務（T-2-4-1 至 T-2-4-4）

### 階段 3 任務清單摘要

- **總任務數**：18 個
- **P0 優先級任務**：17 個
- **P1 優先級任務**：1 個
- **總預估工時**：約 150+ 小時
- **預估時程**：4-5 週
- **對應使用者故事**：US-010, US-011, US-012, US-013
- **對應里程碑**：M3 - 關聯分析與風險計算完成

**任務分類**：
- **7.1 關聯分析引擎**：6 個任務（T-3-1-1 至 T-3-1-6）
- **7.2 風險分數計算引擎**：6 個任務（T-3-2-1 至 T-3-2-6）
- **7.3 風險評估介面**：3 個任務（T-3-3-1 至 T-3-3-3）
- **7.4 測試與優化**：3 個任務（T-3-4-1 至 T-3-4-3）

### 階段 4 任務清單摘要

- **總任務數**：20 個
- **P0 優先級任務**：19 個
- **P1 優先級任務**：1 個
- **總預估工時**：約 180+ 小時
- **預估時程**：4-5 週
- **對應使用者故事**：US-015, US-016, US-017, US-018, US-019, US-020, US-021
- **對應里程碑**：M4 - 報告生成與通知完成

**任務分類**：
- **8.1 報告生成服務**：6 個任務（T-4-1-1 至 T-4-1-6）
- **8.2 IT 工單生成**：4 個任務（T-4-2-1 至 T-4-2-4）
- **8.3 通知機制**：5 個任務（T-4-3-1 至 T-4-3-5）
- **8.4 報告與通知介面**：3 個任務（T-4-4-1 至 T-4-4-3）

### 階段 5 任務清單摘要

- **總任務數**：18 個
- **P0 優先級任務**：17 個
- **P1 優先級任務**：1 個
- **總預估工時**：約 150+ 小時
- **預估時程**：4-5 週
- **對應使用者故事**：US-022, US-023, US-024, US-025, US-026, US-027, US-028, US-029
- **對應里程碑**：M5 - 系統完成

**任務分類**：
- **9.1 身份驗證與授權**：4 個任務（T-5-1-1 至 T-5-1-4）
- **9.2 系統管理功能**：4 個任務（T-5-2-1 至 T-5-2-4）
- **9.3 統計與儀表板**：4 個任務（T-5-3-1 至 T-5-3-4）
- **9.4 系統整合與優化**：4 個任務（T-5-4-1 至 T-5-4-4）

---

**文件狀態**：已核准 (Approved)  
**完成進度**：階段 1-5 已完成（共 93 個任務）  
**核准日期**：2025-11-21  
**下一步**：進入執行階段（EXECUTE）- 開始執行階段 1 的開發任務

