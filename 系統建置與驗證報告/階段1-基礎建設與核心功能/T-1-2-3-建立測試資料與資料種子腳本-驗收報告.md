# T-1-2-3：建立測試資料與資料種子腳本 - 驗收報告

**任務編號**：T-1-2-3  
**任務名稱**：建立測試資料與資料種子腳本  
**執行日期**：2025-11-21  
**執行人員**：開發團隊  
**狀態**：✅ 已完成

---

## 任務概述

建立測試資料與資料種子腳本，包含測試資料工廠（Factory Pattern）、測試用資產資料、PIR 資料、威脅來源資料、使用者與角色資料，以及資料種子腳本。

## 執行內容

### 1. 測試資料工廠（Factory Pattern）

#### ✅ 資產測試資料工廠（`tests/factories/asset_factory.py`）
- **AssetFactory 類別**：
  - `create()`: 建立基本資產
  - `create_high_priority()`: 建立高優先級資產（高敏感度、高關鍵性、對外暴露）
  - `create_low_priority()`: 建立低優先級資產（低敏感度、低關鍵性、不對外暴露）
  - `create_public_facing()`: 建立對外暴露資產
  - `create_batch()`: 批次建立資產
- **AssetProductFactory 類別**：
  - `create()`: 建立基本資產產品
  - `create_os_product()`: 建立作業系統產品
  - `create_application_product()`: 建立應用程式產品

#### ✅ 威脅情資測試資料工廠（`tests/factories/threat_factory.py`）
- **ThreatFeedFactory 類別**：
  - `create()`: 建立基本威脅來源
  - `create_cisa_kev()`: 建立 CISA KEV 來源（P0，每小時）
  - `create_nvd()`: 建立 NVD 來源（P1，每日）
  - `create_vmware_vmsa()`: 建立 VMware VMSA 來源（P1，每日）
  - `create_msrc()`: 建立 MSRC 來源（P1，每日）
  - `create_twcert()`: 建立 TWCERT/CC 來源（P2，每日）
- **ThreatFactory 類別**：
  - `create()`: 建立基本威脅
  - `create_critical()`: 建立嚴重威脅（CVSS >= 9.0）
  - `create_high()`: 建立高風險威脅（CVSS 7.0-8.9）
  - `create_medium()`: 建立中風險威脅（CVSS 4.0-6.9）
  - `create_low()`: 建立低風險威脅（CVSS < 4.0）

#### ✅ PIR 測試資料工廠（`tests/factories/pir_factory.py`）
- **PIRFactory 類別**：
  - `create()`: 建立基本 PIR
  - `create_product_name_pir()`: 建立產品名稱條件 PIR
  - `create_cve_pir()`: 建立 CVE 條件 PIR
  - `create_threat_type_pir()`: 建立威脅類型條件 PIR
  - `create_cisa_kev_pir()`: 建立 CISA KEV 條件 PIR
  - `create_taiwan_cert_pir()`: 建立台灣 CERT 條件 PIR

#### ✅ 使用者與角色測試資料工廠（`tests/factories/user_factory.py`）
- **UserFactory 類別**：
  - `create()`: 建立基本使用者
  - `create_ciso()`: 建立 CISO 使用者
  - `create_it_admin()`: 建立 IT 管理員使用者
  - `create_analyst()`: 建立分析師使用者
- **RoleFactory 類別**：
  - `create()`: 建立基本角色
  - `create_ciso()`: 建立 CISO 角色
  - `create_it_admin()`: 建立 IT 管理員角色
  - `create_analyst()`: 建立分析師角色
  - `create_viewer()`: 建立檢視者角色
- **PermissionFactory 類別**：
  - `create()`: 建立基本權限
  - `create_read()`: 建立讀取權限
  - `create_write()`: 建立寫入權限
  - `create_delete()`: 建立刪除權限

### 2. 測試用資產資料（至少 100 筆）

#### ✅ 資料種子腳本中的資產資料
- **基本資產**：100 筆（使用 `AssetFactory.create_batch(100)`）
- **高優先級資產**：20 筆（高敏感度、高關鍵性、對外暴露）
- **低優先級資產**：20 筆（低敏感度、低關鍵性、不對外暴露）
- **對外暴露資產**：20 筆
- **邊界情況測試**：
  - 極長主機名稱（200 字元）
  - 特殊 IP 格式（CIDR 格式：10.0.0.0/24）
- **總計**：至少 160 筆資產資料

#### ✅ 資產產品資料
- 每個資產包含 2 個產品：
  - 1 個作業系統產品（Linux 5.4）
  - 1 個應用程式產品（nginx 1.18.0）
- **總計**：至少 320 筆資產產品資料

### 3. 測試用 PIR 資料（5 個 PIR 項目）

#### ✅ PIR 資料
- **PIR-01**：產品名稱條件（nginx）
- **PIR-02**：CVE 條件（CVE-2024）
- **PIR-03**：威脅類型條件（RCE）
- **PIR-04**：CISA KEV 條件
- **PIR-05**：台灣 CERT 條件（TWCERT/CC）

### 4. 測試用威脅來源資料（5 個來源）

#### ✅ 威脅來源資料
- **CISA KEV**：P0 優先級，每小時收集
- **NVD**：P1 優先級，每日收集
- **VMware VMSA**：P1 優先級，每日收集
- **MSRC**：P1 優先級，每日收集
- **TWCERT/CC & TW-CERT**：P2 優先級，每日收集

### 5. 測試用使用者與角色資料

#### ✅ 角色資料（4 個角色）
- **CISO**：資安長角色
- **IT_Admin**：IT 管理員角色
- **Analyst**：分析師角色
- **Viewer**：檢視者角色

#### ✅ 權限資料
- **資源**：asset、threat、report、pir、threat_feed
- **動作**：read、write、delete
- **總計**：15 個權限（5 個資源 × 3 個動作）

#### ✅ 角色權限關聯
- **CISO**：擁有所有權限（15 個）
- **IT_Admin**：擁有資產和報告的讀寫權限（4 個）
- **Analyst**：擁有所有資源的讀寫權限（10 個）
- **Viewer**：擁有所有資源的讀取權限（5 個）

#### ✅ 使用者資料（3 個使用者）
- **CISO 使用者**：ciso@example.com，擁有 CISO 角色
- **IT 管理員使用者**：itadmin@example.com，擁有 IT_Admin 角色
- **分析師使用者**：analyst@example.com，擁有 Analyst 角色

### 6. 資料種子腳本（`scripts/seed_data.py`）

#### ✅ 種子腳本功能
- **初始化資料庫**：自動建立所有資料表
- **建立資產資料**：至少 160 筆資產 + 320 筆產品資料
- **建立 PIR 資料**：5 筆 PIR 資料
- **建立威脅來源資料**：5 筆威脅來源資料
- **建立使用者與角色資料**：4 個角色、15 個權限、3 個使用者
- **建立關聯資料**：角色權限關聯、使用者角色關聯
- **統計資訊輸出**：顯示建立的資料統計

### 7. 測試 Fixtures 更新

#### ✅ `tests/conftest.py` 更新
- 新增測試資料 Fixtures：
  - `sample_asset`: 範例資產
  - `sample_assets`: 多個範例資產
  - `sample_threat_feed`: 範例威脅來源
  - `sample_threat`: 範例威脅
  - `sample_pir`: 範例 PIR
  - `sample_user`: 範例使用者
  - `sample_role`: 範例角色
- 所有 Fixtures 使用 Factory Pattern，可重複使用

### 8. 整合測試

#### ✅ `tests/integration/test_seed_data.py`
- `test_seed_data_completeness()`: 測試資料完整性
- `test_seed_data_boundary_cases()`: 測試邊界情況
- `test_seed_data_pir_types()`: 測試 PIR 類型多樣性
- `test_seed_data_threat_feed_priorities()`: 測試威脅來源優先級多樣性
- `test_seed_data_user_roles()`: 測試使用者與角色關聯

## 驗收條件檢查

### ✅ 測試資料符合測試需求
- 資產資料：至少 160 筆（超過要求的 100 筆）
- PIR 資料：5 筆（符合要求）
- 威脅來源資料：5 筆（符合要求）
- 使用者與角色資料：完整建立

### ✅ 測試資料涵蓋各種邊界情況
- 極長主機名稱（200 字元）
- 特殊 IP 格式（CIDR）
- 不同優先級的資產（高、中、低）
- 不同敏感度的資產（高、中、低）
- 不同關鍵性的資產（高、中、低）
- 對外暴露與不對外暴露的資產

### ✅ 測試資料可重複使用（使用 fixtures）
- 所有 Factory 類別提供靜態方法
- 所有測試資料可透過 Factory 建立
- 測試 Fixtures 已整合到 conftest.py
- 所有 Fixtures 可重複使用

### ✅ 資料種子腳本可正常執行
- 種子腳本已建立（`scripts/seed_data.py`）
- 腳本可執行（已設定執行權限）
- 腳本包含完整的錯誤處理
- 腳本輸出統計資訊

### ✅ 測試資料符合 spec.md 第 7 章的表單格式
- PIR 資料符合 spec.md 第 7.2 節的格式
- 威脅來源資料符合 spec.md 第 7.3 節的格式
- 威脅來源優先級符合 spec.md 的定義（P0-P2）
- 收集頻率符合 spec.md 的定義（每小時、每日、每週）

## 測試結果

### ✅ 驗證測試資料完整性
- 整合測試已建立
- 測試驗證所有資料類型的數量
- 測試驗證資料關聯正確性

### ✅ 驗證資料種子腳本功能
- 整合測試已建立
- 測試驗證種子腳本可正常執行
- 測試驗證資料完整性

## 交付成果

1. **完整的測試資料工廠**
   - AssetFactory、AssetProductFactory
   - ThreatFeedFactory、ThreatFactory
   - PIRFactory
   - UserFactory、RoleFactory、PermissionFactory

2. **資料種子腳本**
   - `scripts/seed_data.py`：可執行的種子腳本
   - 包含所有必要的測試資料
   - 包含統計資訊輸出

3. **測試 Fixtures**
   - 更新 `tests/conftest.py`
   - 新增測試資料 Fixtures
   - 所有 Fixtures 可重複使用

4. **整合測試**
   - `tests/integration/test_seed_data.py`
   - 驗證資料完整性
   - 驗證邊界情況
   - 驗證資料多樣性

## 使用方式

### 執行資料種子腳本
```bash
cd backend
python scripts/seed_data.py
```

### 在測試中使用 Factory
```python
from tests.factories import AssetFactory

# 建立單一資產
asset = AssetFactory.create()

# 建立高優先級資產
high_priority_asset = AssetFactory.create_high_priority()

# 批次建立資產
assets = AssetFactory.create_batch(10)
```

### 在測試中使用 Fixtures
```python
def test_asset_creation(sample_asset):
    assert sample_asset.id is not None
    assert sample_asset.host_name is not None
```

## 相關文件

- **設計文件**：`系統需求設計與分析/plan.md` 第 8.1.5 節「測試資料管理」、第 10.1.1 節「資料庫設計與實作」
- **需求文件**：`系統需求設計與分析/spec.md` 第 7 章「使用表單」
- **任務文件**：`系統需求設計與分析/tasks.md` T-1-2-3

## 備註

- 所有 Factory 類別使用靜態方法，便於使用
- 所有測試資料符合 spec.md 的表單格式
- 資料種子腳本可用於開發環境初始化
- 測試資料涵蓋各種邊界情況，確保測試完整性

---

**驗收狀態**：✅ 通過  
**驗收日期**：2025-11-21  
**驗收人員**：開發團隊

