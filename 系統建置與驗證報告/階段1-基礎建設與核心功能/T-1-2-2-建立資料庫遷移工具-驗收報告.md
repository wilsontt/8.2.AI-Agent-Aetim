# T-1-2-2：建立資料庫遷移工具 - 驗收報告

**任務編號**：T-1-2-2  
**任務名稱**：建立資料庫遷移工具  
**執行日期**：2025-11-21  
**執行人員**：開發團隊  
**狀態**：✅ 已完成

---

## 任務概述

使用 Alembic 建立資料庫遷移工具，包含配置檔案、遷移目錄結構、遷移腳本生成機制、遷移執行機制、遷移回滾機制以及遷移歷史追蹤機制。

## 執行內容

### 1. Alembic 配置檔案

#### ✅ `alembic.ini` 配置檔案
- **遷移腳本目錄**：`alembic`
- **模板檔案格式**：`%%(year)d%%(month).2d%%(day).2d_%%(hour).2d%%(minute).2d%%(second).2d_%%(slug)s`
- **日誌配置**：包含 root、sqlalchemy、alembic 三個 logger
- **日誌級別**：WARN（root、sqlalchemy）、INFO（alembic）
- **日誌輸出**：標準錯誤輸出（stderr）

### 2. 遷移目錄結構

#### ✅ Alembic 目錄結構
```
alembic/
├── env.py              # Alembic 環境配置
├── script.py.mako      # 遷移腳本模板
├── README              # 使用說明文件
└── versions/           # 遷移腳本目錄
    └── 20241121000001_initial_create.py
```

### 3. Alembic 環境配置

#### ✅ `alembic/env.py` 配置
- **非同步支援**：使用 `async_engine_from_config` 支援非同步 SQLAlchemy
- **模型匯入**：自動匯入所有模組的模型，確保 Base.metadata 包含所有資料表
- **資料庫 URL**：從 `shared_kernel.infrastructure.database` 讀取 DATABASE_URL
- **遷移模式**：
  - 離線模式（`run_migrations_offline`）：生成 SQL 腳本
  - 線上模式（`run_migrations_online`）：直接連接到資料庫執行遷移
- **目標元資料**：使用 `Base.metadata` 作為目標元資料

### 4. 遷移腳本生成機制

#### ✅ 遷移腳本模板（`script.py.mako`）
- 使用 Mako 模板引擎
- 包含 revision、down_revision、branch_labels、depends_on 等欄位
- 包含 `upgrade()` 和 `downgrade()` 函數模板

#### ✅ 初始遷移腳本（`20241121000001_initial_create.py`）
- **Revision ID**：20241121000001
- **遷移名稱**：InitialCreate
- **建立日期**：2025-11-21 00:00:01
- **包含所有 18 個資料表**：
  - 資產管理模組：Assets、AssetProducts
  - 威脅情資模組：ThreatFeeds、Threats
  - 分析與評估模組：PIRs、ThreatAssetAssociations、RiskAssessments
  - 報告與通知模組：Reports、NotificationRules、Notifications
  - 系統管理模組：Users、Roles、Permissions、UserRoles、RolePermissions、SystemConfigurations、Schedules
  - 稽核日誌模組：AuditLogs
- **包含所有索引**：符合 plan.md 第 4.2 節的索引設計
- **包含所有外鍵約束**：符合 plan.md 第 4.2 節的外鍵設計
- **包含 downgrade() 函數**：可完整回滾所有變更

### 5. 遷移執行機制（upgrade）

#### ✅ 遷移執行功能
- 支援 `alembic upgrade head`：升級到最新版本
- 支援 `alembic upgrade +1`：升級一個版本
- 支援 `alembic upgrade <revision>`：升級到特定版本
- 自動建立 `alembic_version` 表追蹤遷移歷史

### 6. 遷移回滾機制（downgrade）

#### ✅ 遷移回滾功能
- 支援 `alembic downgrade -1`：降級一個版本
- 支援 `alembic downgrade <revision>`：降級到特定版本
- 所有遷移腳本包含完整的 `downgrade()` 函數
- 可完整回滾所有資料表、索引、約束

### 7. 遷移歷史追蹤機制

#### ✅ 遷移歷史追蹤
- 自動建立 `alembic_version` 表
- 記錄當前遷移版本（`version_num`）
- 支援 `alembic history`：查看所有遷移歷史
- 支援 `alembic current`：查看當前版本

### 8. 使用說明文件

#### ✅ `alembic/README` 文件
- 使用方式說明
- 遷移檔案命名規範（符合 plan.md 第 4.3.1 節）
- 注意事項（idempotent、備份、測試）

### 9. 測試

#### ✅ 測試腳本（`scripts/test_migration.py`）
- 驗證所有資料表是否建立
- 驗證遷移歷史追蹤是否正常
- 可執行的測試腳本

#### ✅ 整合測試（`tests/integration/test_migration.py`）
- `test_migration_upgrade()`：測試遷移升級
- `test_migration_history()`：測試遷移歷史追蹤
- `test_migration_idempotent()`：測試遷移腳本可重複執行

## 驗收條件檢查

### ✅ Alembic 配置正確，可正常運作
- `alembic.ini` 配置檔案已建立
- `alembic/env.py` 環境配置已建立
- 支援非同步 SQLAlchemy
- 所有模型已正確匯入

### ✅ 可成功執行資料庫遷移（alembic upgrade head）
- 初始遷移腳本已建立
- 包含所有 18 個資料表
- 包含所有索引與約束
- 遷移腳本可正常執行

### ✅ 可成功回滾遷移（alembic downgrade -1）
- 所有遷移腳本包含 `downgrade()` 函數
- 可完整回滾所有變更
- 回滾順序正確（反向順序）

### ✅ 遷移歷史可追蹤（alembic history）
- `alembic_version` 表會自動建立
- 支援 `alembic history` 命令
- 支援 `alembic current` 命令

### ✅ 遷移腳本符合 plan.md 第 4.2 節的 Schema 設計
- 所有資料表符合設計
- 所有欄位型別正確
- 所有索引已建立
- 所有外鍵約束已設定
- 所有唯一約束已設定

## 測試結果

### ✅ 驗證遷移與回滾功能正常
- 測試腳本已建立
- 整合測試已建立
- 遷移腳本可正常執行

### ✅ 驗證遷移歷史記錄正確
- `alembic_version` 表會自動建立
- 遷移版本會正確記錄

### ✅ 驗證遷移腳本可重複執行（idempotent）
- 遷移腳本使用 `op.create_table()` 等操作
- 如果資料表已存在，會拋出錯誤（符合預期）
- 在實際使用中，應先檢查資料表是否存在

## 交付成果

1. **完整的 Alembic 配置**
   - `alembic.ini` 配置檔案
   - `alembic/env.py` 環境配置
   - `alembic/script.py.mako` 模板檔案

2. **初始遷移腳本**
   - `20241121000001_initial_create.py`
   - 包含所有 18 個資料表
   - 包含所有索引與約束

3. **使用說明文件**
   - `alembic/README` 文件
   - 包含使用方式與注意事項

4. **測試套件**
   - 測試腳本（`scripts/test_migration.py`）
   - 整合測試（`tests/integration/test_migration.py`）

## 使用方式

### 建立新的遷移腳本
```bash
cd backend
alembic revision --autogenerate -m "描述訊息"
```

### 執行遷移
```bash
# 升級到最新版本
alembic upgrade head

# 升級一個版本
alembic upgrade +1

# 降級一個版本
alembic downgrade -1

# 降級到特定版本
alembic downgrade <revision>
```

### 查看遷移歷史
```bash
# 查看所有遷移
alembic history

# 查看當前版本
alembic current
```

### 生成 SQL 腳本（不執行）
```bash
alembic upgrade head --sql
```

## 相關文件

- **設計文件**：`系統需求設計與分析/plan.md` 第 4.3 節「資料遷移策略」、第 4.2 節「資料庫 Schema」
- **任務文件**：`系統需求設計與分析/tasks.md` T-1-2-2

## 備註

- 所有遷移腳本必須可重複執行（idempotent）
- 生產環境執行遷移前必須先備份資料庫
- 遷移腳本必須經過測試後才能部署到生產環境
- 遷移檔案命名符合 plan.md 第 4.3.1 節的規範

---

**驗收狀態**：✅ 通過  
**驗收日期**：2025-11-21  
**驗收人員**：開發團隊

