# T-1-3-1：實作資產領域模型 - 驗收報告

**任務編號**：T-1-3-1  
**任務名稱**：實作資產領域模型  
**執行日期**：2025-11-21  
**執行人員**：開發團隊  
**狀態**：✅ 已完成

---

## 任務概述

實作資產領域模型（Domain Layer），包含 Asset 聚合根、DataSensitivity 和 BusinessCriticality 值物件、AssetProduct 實體，以及領域事件（AssetCreatedEvent、AssetUpdatedEvent）。

## 執行內容

### 1. Asset 聚合根

#### ✅ `asset_management/domain/aggregates/asset.py`
- **類別方法 `create()`**：
  - 建立資產的工廠方法
  - 驗證所有必要欄位
  - 自動生成 UUID
  - 發布 `AssetCreatedEvent` 領域事件
- **實例方法 `update()`**：
  - 更新資產資訊（支援部分更新）
  - 驗證更新欄位的有效性
  - 自動更新 `updated_at` 和 `updated_by`
  - 發布 `AssetUpdatedEvent` 領域事件（包含更新的欄位清單）
- **實例方法 `add_product()`**：
  - 新增產品資訊到資產
  - 驗證產品名稱不能為空
  - 防止重複產品（相同名稱和版本）
  - 返回新建立的 `AssetProduct` 實體
- **實例方法 `remove_product()`**：
  - 移除產品資訊
  - 驗證產品存在性
- **實例方法 `calculate_risk_weight()`**：
  - 計算風險權重
  - 公式：資料敏感度權重 × 業務關鍵性權重
  - 返回浮點數權重值
- **領域事件管理**：
  - `get_domain_events()`：取得領域事件清單
  - `clear_domain_events()`：清除領域事件清單
- **業務規則驗證**：
  - 主機名稱不能為空
  - 作業系統不能為空
  - 運行的應用程式不能為空
  - 負責人不能為空
  - 資料敏感度和業務關鍵性必須是有效的值物件

### 2. DataSensitivity 值物件

#### ✅ `asset_management/domain/value_objects/data_sensitivity.py`
- **值物件特性**：
  - 使用 `@dataclass(frozen=True)` 確保不可變性
  - 透過值相等性比較（`__eq__`）
  - 可雜湊（`__hash__`）
- **權重對照表**：
  - 高：1.5
  - 中：1.0
  - 低：0.5
- **驗證邏輯**：
  - 驗證值必須為「高」、「中」或「低」
  - 無效值會拋出 `ValueError`
- **屬性 `weight`**：
  - 根據值返回對應的權重

### 3. BusinessCriticality 值物件

#### ✅ `asset_management/domain/value_objects/business_criticality.py`
- **值物件特性**：
  - 使用 `@dataclass(frozen=True)` 確保不可變性
  - 透過值相等性比較（`__eq__`）
  - 可雜湊（`__hash__`）
- **權重對照表**：
  - 高：1.5
  - 中：1.0
  - 低：0.5
- **驗證邏輯**：
  - 驗證值必須為「高」、「中」或「低」
  - 無效值會拋出 `ValueError`
- **屬性 `weight`**：
  - 根據值返回對應的權重

### 4. AssetProduct 實體

#### ✅ `asset_management/domain/entities/asset_product.py`
- **實體特性**：
  - 具有唯一識別碼（`id`）
  - 透過 ID 相等性比較（`__eq__`）
  - 可雜湊（`__hash__`）
- **欄位**：
  - `id`：產品唯一識別碼（UUID）
  - `product_name`：產品名稱（必填）
  - `product_version`：產品版本（可選）
  - `product_type`：產品類型（OS/Application，可選）
  - `original_text`：原始文字（用於比對，可選）
- **驗證邏輯**：
  - 產品名稱不能為空
  - 如果沒有提供 ID，自動生成 UUID

### 5. 領域事件

#### ✅ `asset_management/domain/domain_events/asset_created_event.py`
- **事件欄位**：
  - `asset_id`：資產 ID
  - `host_name`：主機名稱
  - `owner`：負責人
  - `occurred_at`：事件發生時間（自動設定）
- **事件特性**：
  - 使用 `@dataclass(frozen=True)` 確保不可變性
  - 自動記錄事件發生時間

#### ✅ `asset_management/domain/domain_events/asset_updated_event.py`
- **事件欄位**：
  - `asset_id`：資產 ID
  - `host_name`：主機名稱
  - `updated_fields`：被更新的欄位清單
  - `occurred_at`：事件發生時間（自動設定）
- **事件特性**：
  - 使用 `@dataclass(frozen=True)` 確保不可變性
  - 記錄所有被更新的欄位
  - 自動記錄事件發生時間

### 6. 模組匯出

#### ✅ `asset_management/domain/__init__.py`
- 匯出所有領域模型類別
- 提供清晰的模組介面

### 7. 單元測試

#### ✅ `tests/unit/test_asset_domain.py`
- **DataSensitivity 測試**：
  - 測試建立高/中/低敏感度
  - 測試無效敏感度值
  - 測試值物件相等性
  - 測試不可變性
- **BusinessCriticality 測試**：
  - 測試建立高/中/低關鍵性
  - 測試無效關鍵性值
  - 測試值物件相等性
- **AssetProduct 測試**：
  - 測試建立產品
  - 測試無效產品名稱
  - 測試實體相等性（透過 ID）
- **Asset 聚合根測試**：
  - 測試建立資產
  - 測試建立資產發布領域事件
  - 測試更新資產
  - 測試更新資產發布領域事件
  - 測試新增產品資訊
  - 測試新增重複產品（應拋出異常）
  - 測試移除產品資訊
  - 測試移除不存在的產品（應拋出異常）
  - 測試計算風險權重
  - 測試無效主機名稱
  - 測試無效負責人
  - 測試清除領域事件
- **領域事件測試**：
  - 測試資產建立事件
  - 測試資產更新事件

## 驗收條件檢查

### ✅ 領域模型符合 plan.md 第 6.1 節的設計
- Asset 聚合根已實作
- DataSensitivity 值物件已實作（權重：1.5/1.0/0.5）
- BusinessCriticality 值物件已實作（權重：1.5/1.0/0.5）
- AssetProduct 實體已實作
- 領域事件已實作（AssetCreatedEvent、AssetUpdatedEvent）

### ✅ 所有業務規則正確實作
- 主機名稱不能為空
- 作業系統不能為空
- 運行的應用程式不能為空
- 負責人不能為空
- 產品名稱不能為空
- 防止重複產品
- 資料敏感度和業務關鍵性值驗證

### ✅ 值物件的權重計算正確
- DataSensitivity 權重：高=1.5、中=1.0、低=0.5
- BusinessCriticality 權重：高=1.5、中=1.0、低=0.5
- 風險權重計算：資料敏感度權重 × 業務關鍵性權重
- 測試驗證：高×高=2.25、中×中=1.0、低×低=0.25

### ✅ 領域事件可正常發布
- Asset.create() 自動發布 AssetCreatedEvent
- Asset.update() 自動發布 AssetUpdatedEvent
- 事件包含必要的資訊（asset_id、host_name 等）
- 事件自動記錄發生時間

### ✅ 符合 DDD 原則
- **聚合根**：Asset 作為聚合根，維護聚合的一致性邊界
- **實體**：AssetProduct 具有唯一識別碼
- **值物件**：DataSensitivity 和 BusinessCriticality 是不可變的，透過值相等性比較
- **領域事件**：AssetCreatedEvent 和 AssetUpdatedEvent 用於表示領域中發生的重要事件

## 測試結果

### ✅ 單元測試覆蓋率 ≥ 80%
- 已建立完整的單元測試套件
- 測試涵蓋所有業務規則
- 測試涵蓋所有值物件計算邏輯
- 測試涵蓋所有領域事件發布

### ✅ 所有業務規則通過測試
- 所有驗證邏輯都有對應的測試
- 所有異常情況都有測試覆蓋

### ✅ 值物件計算邏輯測試通過
- 權重計算測試通過
- 風險權重計算測試通過

### ✅ 領域事件發布測試通過
- 資產建立事件發布測試通過
- 資產更新事件發布測試通過

## 交付成果

1. **完整的領域模型**
   - Asset 聚合根（包含所有業務邏輯方法）
   - DataSensitivity 值物件
   - BusinessCriticality 值物件
   - AssetProduct 實體
   - AssetCreatedEvent 領域事件
   - AssetUpdatedEvent 領域事件

2. **完整的單元測試**
   - 測試覆蓋率 ≥ 80%
   - 所有業務規則都有測試
   - 所有值物件計算邏輯都有測試
   - 所有領域事件都有測試

## 使用範例

### 建立資產
```python
from asset_management.domain import Asset

# 建立資產
asset = Asset.create(
    host_name="test-host",
    operating_system="Linux 5.4",
    running_applications="nginx 1.18",
    owner="test-owner",
    data_sensitivity="高",
    business_criticality="高",
)

# 取得領域事件
events = asset.get_domain_events()
# events[0] 是 AssetCreatedEvent
```

### 更新資產
```python
# 更新資產
asset.update(
    host_name="updated-host",
    owner="updated-owner",
    updated_by="user1",
)

# 取得更新事件
events = asset.get_domain_events()
# events[0] 是 AssetUpdatedEvent，包含 updated_fields
```

### 新增產品資訊
```python
# 新增產品
product = asset.add_product("nginx", "1.18.0", "Application")

# 計算風險權重
risk_weight = asset.calculate_risk_weight()
# 高敏感度 × 高關鍵性 = 1.5 × 1.5 = 2.25
```

## 相關文件

- **設計文件**：`系統需求設計與分析/plan.md` 第 6.1 節「基礎建設與情資定義模組」、第 3.2 節「有界上下文劃分」
- **需求文件**：`系統需求設計與分析/spec.md` US-001, US-002
- **任務文件**：`系統需求設計與分析/tasks.md` T-1-3-1

## 備註

- 所有領域模型遵循 DDD 原則
- 值物件使用 `@dataclass(frozen=True)` 確保不可變性
- 聚合根負責維護聚合的一致性邊界
- 領域事件用於模組間的非同步通訊
- 所有業務規則都有對應的驗證和測試

---

**驗收狀態**：✅ 通過  
**驗收日期**：2025-11-21  
**驗收人員**：開發團隊

